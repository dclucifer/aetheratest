(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function a(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=a(o);fetch(o.href,s)}})();class Ya{constructor(){this.scrollY=0,this.ticking=!1,this.mouseX=0,this.mouseY=0,this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.init()}init(){window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.windowWidth<=768||(this.bindEvents(),this.setupIntersectionObserver(),this.initParallaxElements(),this.startAnimationLoop())}bindEvents(){window.addEventListener("scroll",this.onScroll.bind(this),{passive:!0}),document.addEventListener("mousemove",this.onMouseMove.bind(this),{passive:!0}),window.addEventListener("resize",this.onResize.bind(this),{passive:!0}),document.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!0})}onScroll(){this.scrollY=window.pageYOffset,this.ticking||(requestAnimationFrame(this.updateParallax.bind(this)),this.ticking=!0)}onMouseMove(e){this.mouseX=e.clientX/this.windowWidth*2-1,this.mouseY=e.clientY/this.windowHeight*2-1,this.updateMouseParallax()}onTouchMove(e){if(e.touches.length>0){const a=e.touches[0];this.mouseX=a.clientX/this.windowWidth*2-1,this.mouseY=a.clientY/this.windowHeight*2-1,this.updateMouseParallax()}}onResize(){this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.windowWidth<=768?this.destroy():this.init()}updateParallax(){this.updateScrollParallax(),this.updateHeroParallax(),this.updateSectionParallax(),this.updateNavigationParallax(),this.ticking=!1}updateScrollParallax(){document.querySelectorAll(".scroll-parallax").forEach(a=>{const n=a.getBoundingClientRect(),o=a.dataset.parallaxSpeed||.5,s=-(this.scrollY*o);n.bottom>=0&&n.top<=this.windowHeight&&(a.style.transform=`translateY(${s}px)`)}),this.updateParallaxClass(".scroll-parallax-slow",.3),this.updateParallaxClass(".scroll-parallax-medium",.5),this.updateParallaxClass(".scroll-parallax-fast",.7)}updateParallaxClass(e,a){document.querySelectorAll(e).forEach(o=>{const s=o.getBoundingClientRect(),i=-(this.scrollY*a);s.bottom>=0&&s.top<=this.windowHeight&&(o.style.transform=`translateY(${i}px)`)})}updateHeroParallax(){const e=document.querySelector(".hero-background"),a=document.querySelector(".hero-particles"),n=document.querySelector(".hero-content");if(e){const o=this.scrollY*.5;e.style.transform=`translateY(${o}px)`}if(a){const o=this.scrollY*.3,s=Math.sin(this.scrollY*.001)*10;a.style.transform=`translateY(${o}px) translateX(${s}px)`}if(n){const o=this.scrollY*.1,s=1-this.scrollY*5e-4;n.style.transform=`translateY(${o}px) scale(${Math.max(s,.8)})`}}updateSectionParallax(){document.querySelectorAll(".section-parallax").forEach(a=>{const n=a.getBoundingClientRect(),o=a.querySelector(".section-parallax-bg"),s=a.querySelector(".section-parallax-content");if(n.bottom>=0&&n.top<=this.windowHeight){const i=(this.windowHeight-n.top)/(this.windowHeight+n.height);if(o){const r=i*100;o.style.transform=`translateY(${r}px)`}if(s){const r=i*50;s.style.transform=`translateY(${r}px)`}}})}updateNavigationParallax(){const e=document.querySelector(".nav-parallax");e&&(this.scrollY>100?(e.classList.add("visible"),e.classList.remove("hidden")):(e.classList.add("hidden"),e.classList.remove("visible")))}updateMouseParallax(){document.querySelectorAll(".mouse-parallax").forEach(a=>{const n=a.dataset.mouseIntensity||20,o=this.mouseX*n,s=this.mouseY*n;a.style.transform=`translateX(${o}px) translateY(${s}px)`}),this.updateMouseParallaxLayers(),this.updateMagneticElements()}updateMouseParallaxLayers(){document.querySelectorAll(".mouse-parallax").forEach(a=>{const n=a.querySelector(".mouse-parallax-layer-1"),o=a.querySelector(".mouse-parallax-layer-2"),s=a.querySelector(".mouse-parallax-layer-3");if(n){const i=this.mouseX*10,r=this.mouseY*10;n.style.transform=`translateX(${i}px) translateY(${r}px)`}if(o){const i=this.mouseX*20,r=this.mouseY*20;o.style.transform=`translateX(${i}px) translateY(${r}px)`}if(s){const i=this.mouseX*30,r=this.mouseY*30;s.style.transform=`translateX(${i}px) translateY(${r}px)`}})}updateMagneticElements(){document.querySelectorAll(".parallax-magnetic").forEach(a=>{const n=a.getBoundingClientRect(),o=n.left+n.width/2,s=n.top+n.height/2,i=this.mouseX*this.windowWidth-o,r=this.mouseY*this.windowHeight-s,c=Math.sqrt(i*i+r*r),l=100;if(c<l){const u=(l-c)/l,y=i/c*u*20,p=r/c*u*20;a.style.setProperty("--mouse-x",`${y}px`),a.style.setProperty("--mouse-y",`${p}px`),a.classList.add("attracted")}else a.style.setProperty("--mouse-x","0px"),a.style.setProperty("--mouse-y","0px"),a.classList.remove("attracted")})}setupIntersectionObserver(){const e={threshold:.1,rootMargin:"0px 0px -50px 0px"},a=new IntersectionObserver(n=>{n.forEach(o=>{o.isIntersecting?(o.target.classList.add("in-view"),o.target.classList.contains("text-parallax")&&o.target.classList.add("revealed")):(o.target.classList.remove("in-view"),o.target.classList.contains("text-parallax")&&o.target.classList.remove("revealed"))})},e);document.querySelectorAll(".parallax-trigger").forEach(n=>{a.observe(n)}),document.querySelectorAll(".text-parallax").forEach(n=>{a.observe(n)})}initParallaxElements(){this.initCardParallax(),this.initButtonParallax(),this.initTiltEffects()}initCardParallax(){document.querySelectorAll(".card-parallax").forEach(a=>{a.addEventListener("mouseenter",n=>{const o=n.target.getBoundingClientRect(),s=o.left+o.width/2,i=o.top+o.height/2;n.target.style.transformOrigin=`${s}px ${i}px`}),a.addEventListener("mousemove",n=>{const o=n.target.getBoundingClientRect(),s=n.clientX-o.left,i=n.clientY-o.top,r=o.width/2,c=o.height/2,l=(i-c)/c*10,u=(r-s)/r*10;n.target.style.transform=`rotateX(${l}deg) rotateY(${u}deg) translateZ(20px)`}),a.addEventListener("mouseleave",n=>{n.target.style.transform="rotateX(0deg) rotateY(0deg) translateZ(0px)"})})}initButtonParallax(){document.querySelectorAll(".btn-parallax").forEach(a=>{a.addEventListener("mouseenter",n=>{n.target.style.transform="translateZ(10px) rotateX(10deg)"}),a.addEventListener("mouseleave",n=>{n.target.style.transform="translateZ(0px) rotateX(0deg)"})})}initTiltEffects(){document.querySelectorAll(".parallax-tilt").forEach(a=>{a.addEventListener("mousemove",n=>{const o=n.target.getBoundingClientRect(),s=n.clientX-o.left,i=n.clientY-o.top,r=o.width/2,c=o.height/2,l=(i-c)/c*15,u=(r-s)/r*15;n.target.style.transform=`perspective(1000px) rotateX(${l}deg) rotateY(${u}deg)`}),a.addEventListener("mouseleave",n=>{n.target.style.transform="perspective(1000px) rotateX(0deg) rotateY(0deg)"})})}startAnimationLoop(){const e=()=>{this.updateFloatingElements(),requestAnimationFrame(e)};e()}updateFloatingElements(){const e=document.querySelectorAll(".float-parallax"),a=Date.now()*.001;e.forEach((n,o)=>{const s=o*2,i=Math.sin(a+s)*10,r=Math.cos(a+s)*5;n.style.transform=`translateY(${i}px) translateZ(${r}px)`})}destroy(){window.removeEventListener("scroll",this.onScroll.bind(this)),document.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("resize",this.onResize.bind(this)),document.removeEventListener("touchmove",this.onTouchMove.bind(this)),document.querySelectorAll('[class*="parallax"]').forEach(a=>{a.style.transform=""})}}class lo{constructor(){this.init()}init(){this.initButtonInteractions(),this.initFormInteractions(),this.initCardInteractions(),this.initNavigationInteractions(),this.initScrollInteractions()}initButtonInteractions(){document.addEventListener("click",a=>{a.target.matches(".btn-primary, .btn-secondary, .icon-btn")&&this.createRipple(a)}),document.querySelectorAll(".btn-primary, .btn-secondary").forEach(a=>{a.addEventListener("mouseenter",()=>{a.style.transform="translateY(-2px) scale(1.02)"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateY(0) scale(1)"})})}createRipple(e){const a=e.target,n=a.getBoundingClientRect(),o=Math.max(n.width,n.height),s=e.clientX-n.left-o/2,i=e.clientY-n.top-o/2,r=document.createElement("span");r.style.cssText=`
            position: absolute;
            width: ${o}px;
            height: ${o}px;
            left: ${s}px;
            top: ${i}px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-animation 0.6s ease-out;
            pointer-events: none;
            z-index: 1;
        `,a.style.position="relative",a.style.overflow="hidden",a.appendChild(r),setTimeout(()=>{r.remove()},600)}initFormInteractions(){document.querySelectorAll("input, textarea, select").forEach(a=>{a.addEventListener("focus",()=>{const n=a.closest(".form-group");n&&n.classList.add("focused")}),a.addEventListener("blur",()=>{const n=a.closest(".form-group");n&&n.classList.remove("focused")})})}initCardInteractions(){document.querySelectorAll(".result-card, .quick-template-btn").forEach(a=>{a.addEventListener("mouseenter",()=>{a.style.transform="translateY(-4px) scale(1.02)",a.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateY(0) scale(1)"})})}initNavigationInteractions(){document.querySelectorAll(".nav-link").forEach(a=>{a.addEventListener("mouseenter",()=>{a.style.transform="translateY(-1px)",a.style.transition="all 0.2s ease"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateY(0)"})})}initScrollInteractions(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(a){a.preventDefault();const n=this.getAttribute("href");if(n&&n.length>1){const o=document.querySelector(n);o&&o.scrollIntoView({behavior:"smooth",block:"start"})}})})}}document.addEventListener("DOMContentLoaded",()=>{new Ya});typeof module<"u"&&module.exports&&(module.exports={ParallaxController:Ya,MicroInteractionsController:lo});const uo="modulepreload",mo=function(t){return"/"+t},Na={},$=function(e,a,n){let o=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=Promise.allSettled(a.map(c=>{if(c=mo(c),c in Na)return;Na[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const y=document.createElement("link");if(y.rel=l?"stylesheet":uo,l||(y.as="script"),y.crossOrigin="",y.href=c,r&&y.setAttribute("nonce",r),document.head.appendChild(y),l)return new Promise((p,h)=>{y.addEventListener("load",p),y.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return o.then(i=>{for(const r of i||[])r.status==="rejected"&&s(r.reason);return e().catch(s)})},po="https://afrqqsjdarffcpimdwvo.supabase.co",go="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmcnFxc2pkYXJmZmNwaW1kd3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMjc2NDcsImV4cCI6MjA3MDkwMzY0N30.Stlhcf_qgWsV1u5RUxSH5_Ocr1iJd_d04yv-rtKT1xQ";function $a(){const t=async()=>({data:null,error:null});return{auth:{getSession:async()=>({data:{session:null}}),onAuthStateChange:()=>({data:{subscription:{unsubscribe(){}}}}),signInWithOtp:t,signOut:t,updateUser:t}}}let Qe;try{window&&window.supabase&&typeof window.supabase.createClient=="function"?Qe=window.supabase.createClient(po,go,{auth:{autoRefreshToken:!1,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},global:{headers:{"X-Client-Info":"direktiva-studio@1.0.0"}}}):(console.warn("[Supabase] Global supabase not found. Falling back to no-auth mode."),Qe=$a())}catch{Qe=$a()}const x=Qe;let W={id:{},en:{}};async function Mt(){try{const t=new URL("/assets/id-BUC_5qEj.json",import.meta.url),e=new URL("/assets/en-8bH8RAlc.json",import.meta.url),[a,n]=await Promise.all([fetch(t),fetch(e)]),[o,s]=await Promise.all([a.json(),n.json()]);return W={id:o,en:s},console.log("Translations loaded successfully"),W}catch(t){return console.error("Failed to load translations:",t),W={id:{},en:{}},W}}function d(t,e={}){const a=typeof localStorage<"u"&&(localStorage.getItem("direktiva_language")||localStorage.getItem("aethera_language"))||typeof document<"u"&&document.documentElement.lang||"id";if(!W||!W[a]&&!W.en&&!W.id)return t;const n=s=>t.split(".").reduce((i,r)=>i&&i[r]!=null?i[r]:void 0,W[s]||{});let o=n(a);return o==null&&(o=n("en")),o==null&&(o=n("id")),typeof o=="string"?o.replace(/\{(\w+)\}/g,(s,i)=>e[i]??""):o??t}const Qt=Object.freeze(Object.defineProperty({__proto__:null,loadTranslations:Mt,t:d,get translations(){return W}},Symbol.toStringTag,{value:"Module"})),m={loginOverlay:document.getElementById("login-overlay"),loginBtn:document.getElementById("login-btn"),appContainer:document.getElementById("app-container"),generatorPage:document.getElementById("generator-page"),historyPage:document.getElementById("history-page"),settingsPage:document.getElementById("settings-page"),accountPage:document.getElementById("account-page"),navGenerator:document.getElementById("nav-generator"),navHistory:document.getElementById("nav-history"),navSettings:document.getElementById("nav-settings"),navAccount:document.getElementById("nav-account"),logoutBtn:document.getElementById("logout-btn"),mobileLogoutBtn:document.getElementById("mobile-logout-btn"),mobileMenuButton:document.getElementById("mobile-menu-button"),mobileMenu:document.getElementById("mobile-menu"),menuOpenIcon:document.getElementById("menu-open-icon"),menuCloseIcon:document.getElementById("menu-close-icon"),generateBtn:document.getElementById("generate-btn"),btnText:document.getElementById("btn-text"),btnLoader:document.getElementById("btn-loader"),imageLoader:document.getElementById("image-loader"),imageHelper:document.getElementById("image-helper"),imagePreview:document.getElementById("image-preview"),imagePreviewContainer:document.getElementById("image-preview-container"),removeImageBtn:document.getElementById("remove-image-btn"),outputPanel:document.getElementById("output-panel"),historyPanel:document.getElementById("history-panel"),initialState:document.getElementById("initial-state"),modeSingleBtn:document.getElementById("mode-single"),modeCarouselBtn:document.getElementById("mode-carousel"),scriptCountGroup:document.getElementById("script-count-group"),slideCountGroup:document.getElementById("slide-count-group"),carouselTemplateGroup:document.getElementById("carousel-template-group"),visualStrategyGroup:document.getElementById("visual-strategy-group"),strategyDefaultBtn:document.getElementById("strategy-default"),strategyFacelessBtn:document.getElementById("strategy-faceless"),strategyCharacterBtn:document.getElementById("strategy-character"),ratio916Btn:document.getElementById("ratio-916"),ratio11Btn:document.getElementById("ratio-11"),ratio169Btn:document.getElementById("ratio-169"),downloadAllContainer:document.getElementById("download-all-container"),personaSelector:document.getElementById("persona-selector"),visualDnaStorage:document.getElementById("visual-dna-storage"),customApiKeySettingsInput:document.getElementById("custom-api-key-settings"),apiStatus:document.getElementById("api-status"),systemPromptTextarea:document.getElementById("system-prompt"),saveSettingsBtn:document.getElementById("save-settings-btn"),settingsPresetSelector:document.getElementById("settings-preset-selector"),savePresetBtn:document.getElementById("save-preset-btn"),managePresetsBtn:document.getElementById("manage-presets-btn"),manageCharacterPresetsBtn:document.getElementById("manage-character-presets-btn"),langIdBtn:document.getElementById("lang-id"),langEnBtn:document.getElementById("lang-en"),notification:document.getElementById("notification"),editModal:{el:document.getElementById("edit-modal"),closeBtn:document.getElementById("close-modal-btn"),regenerateBtn:document.getElementById("regenerate-btn"),originalDisplay:document.getElementById("original-script-display-stage1"),instructionInput:document.getElementById("revision-instruction")},apiKeyModal:{el:document.getElementById("api-key-modal"),input:document.getElementById("modal-api-key-input"),saveBtn:document.getElementById("save-api-key-from-modal-btn")},personaModal:{el:document.getElementById("persona-modal"),title:document.getElementById("persona-modal-title"),nameInput:document.getElementById("persona-name"),descInput:document.getElementById("persona-desc"),idInput:document.getElementById("persona-id"),saveBtn:document.getElementById("save-persona-btn"),closeBtn:document.getElementById("close-persona-modal-btn"),addBtn:document.getElementById("add-persona-btn"),listContainer:document.getElementById("persona-list-container"),defaultContainer:document.getElementById("default-persona-container")},confirmModal:{el:document.getElementById("confirm-modal"),title:document.getElementById("confirm-modal-title"),message:document.getElementById("confirm-modal-message"),confirmBtn:document.getElementById("confirm-modal-confirm-btn"),cancelBtn:document.getElementById("confirm-modal-cancel-btn")},inputs:{productName:document.getElementById("product-name"),productDesc:document.getElementById("product-desc"),productImage:document.getElementById("product-image"),writingStyle:document.getElementById("writing-style"),toneVibe:document.getElementById("tone-vibe"),targetAudience:document.getElementById("target-audience"),hookType:document.getElementById("hook-type"),ctaType:document.getElementById("cta-type"),slideCount:document.getElementById("slide-count"),scriptCount:document.getElementById("script-count"),carouselTemplate:document.getElementById("carousel-template")},mobileNavGenerator:document.getElementById("mobile-nav-generator"),mobileNavHistory:document.getElementById("mobile-nav-history"),mobileNavSettings:document.getElementById("mobile-nav-settings"),mobileNavAccount:document.getElementById("mobile-nav-account")},ea={current:localStorage.getItem("direktiva_theme")||"dark"},q={current:localStorage.getItem("direktiva_language")||"id"};let Je=null,de=null;function z(t,e,a,n){if(e){if(e.disabled=t,t){e.classList.add("btn-loading");let o=e.querySelector(".btn-spinner");if(o){o.style.display="flex";const s=e.querySelector(".btn-text");s&&(s.style.opacity="0")}else{const s=e.textContent||e.innerHTML;e.innerHTML=`
                <span class="btn-text">${s}</span>
                <span class="btn-spinner">
                    <div class="spinner"></div>
                </span>
            `}}else{e.classList.remove("btn-loading");const o=e.querySelector(".btn-spinner"),s=e.querySelector(".btn-text");o&&s&&(o.style.display="none",s.style.opacity="1")}if(t&&e.id==="generate-btn"){m.initialState&&(m.initialState.style.display="none"),m.outputPanel.innerHTML="";const o=parseInt(m.inputs.scriptCount.value,10)||1,s=document.getElementById("skeleton-card-template");for(let i=0;i<o;i++){const r=s.content.cloneNode(!0);m.outputPanel.appendChild(r)}}}}function v(t,e="default",a=3e3){let n=t,o=typeof t=="string"&&t.includes("_")&&!t.includes(" ");try{const r=d(t);r&&r!==t&&(n=r,o=!1)}catch(r){console.warn("Translation error in showNotification:",r)}const s=document.createElement("div");s.className=`notification notification-${e}`;let i="";switch(e){case"success":i="icon-check";break;case"error":i="icon-error";break;case"warning":i="icon-warning";break;default:i="icon-info"}if(s.innerHTML=`
        <div class="flex items-center space-x-3">
            <div class="icon icon-md ${i} flex-shrink-0 notification-icon"></div>
            <div class="flex-1 notification-message">${n}</div>
            <button class="icon-btn notification-close" onclick="this.parentElement.parentElement.remove()">
                <div class="icon icon-sm icon-close"></div>
            </button>
        </div>
    `,document.body.appendChild(s),o&&n===t){const r=t;let c=0;const l=20,u=150,y=s.querySelector(".notification-message"),p=setInterval(()=>{try{const h=d(r);h&&h!==r&&(y&&y.textContent===r&&(y.textContent=h),clearInterval(p))}catch{clearInterval(p)}finally{c++,c>=l&&clearInterval(p)}},u)}setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},300)},a)}function ho(t,e,a,n="success",o=7e3){var r,c;const s=document.createElement("div");s.className=`notification notification-${n}`,s.innerHTML=`
        <div class="flex items-center space-x-3">
            <div class="icon icon-md icon-info flex-shrink-0 notification-icon"></div>
            <div class="flex-1 notification-message">${t}</div>
            <button class="px-3 py-1 rounded bg-gray-800 text-white hover:bg-gray-700 action-btn">${e}</button>
            <button class="icon-btn notification-close"><div class="icon icon-sm icon-close"></div></button>
        </div>
    `;const i=()=>{try{s.remove()}catch{}};(r=s.querySelector(".notification-close"))==null||r.addEventListener("click",i),(c=s.querySelector(".action-btn"))==null||c.addEventListener("click",async()=>{try{await(a==null?void 0:a())}finally{i()}}),document.body.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(i,o)}function Ee(t,e=null){const a=document.createElement("textarea");a.value=t,document.body.appendChild(a),a.select();try{if(document.execCommand("copy"),v(d("notification_copy_success")),e){const n=e.innerHTML;e.innerHTML='<div class="icon icon-md icon-check text-green-500"></div>',e.classList.add("copy-success");const o=e.closest(".result-card, .script-part, .slide-text");o&&(o.classList.add("copy-highlight"),setTimeout(()=>{o.classList.remove("copy-highlight")},600)),setTimeout(()=>{e.innerHTML=n,e.classList.remove("copy-success")},1500)}}catch(n){console.error("Failed to copy: ",n)}document.body.removeChild(a)}function Ka(t){return new Promise((e,a)=>{const n=new FileReader;n.readAsDataURL(t),n.onload=()=>e(n.result.split(",")[1]),n.onerror=o=>a(o)})}function ut(t,e,a,n){const o=document.getElementById("input-modal"),s=document.getElementById("input-modal-title"),i=document.getElementById("input-modal-message"),r=document.getElementById("input-modal-input"),c=document.getElementById("input-modal-cancel-btn"),l=document.getElementById("input-modal-confirm-btn");s&&(s.textContent=t),i&&(i.textContent=e),r&&(r.placeholder=a||"",r.value=""),o.classList.remove("opacity-0","pointer-events-none"),o.querySelector(".modal-content").classList.remove("scale-95"),r&&setTimeout(()=>r.focus(),100);const u=()=>{const h=r?r.value.trim():"";Rt(),n&&n(h)},y=()=>{Rt()},p=h=>{h.key==="Enter"?(h.preventDefault(),u()):h.key==="Escape"&&(h.preventDefault(),y())};l&&(l.replaceWith(l.cloneNode(!0)),document.getElementById("input-modal-confirm-btn").addEventListener("click",u)),c&&(c.replaceWith(c.cloneNode(!0)),document.getElementById("input-modal-cancel-btn").addEventListener("click",y)),r&&r.addEventListener("keypress",p)}function Rt(){const t=document.getElementById("input-modal");t.classList.add("opacity-0","pointer-events-none"),t.querySelector(".modal-content").classList.add("scale-95")}function ye(t,e){m.confirmModal.message.textContent=t,Je=e,m.confirmModal.el.classList.remove("opacity-0","pointer-events-none"),m.confirmModal.el.querySelector(".modal-content").classList.remove("scale-95")}function et(){m.confirmModal.el.classList.add("opacity-0","pointer-events-none"),m.confirmModal.el.querySelector(".modal-content").classList.add("scale-95"),Je=null}function ta(t){try{window.onbeforeunload=null}catch{}const{editModal:e}=m,a=JSON.parse(t.dataset.script);document.getElementById("edit-modal-stage-1").style.display="flex",document.getElementById("edit-modal-stage-1").style.flexDirection="column",document.getElementById("edit-modal-stage-2").style.display="none",document.querySelectorAll(".section-checkbox").forEach(r=>r.checked=!1),document.getElementById("revision-instruction").value="",document.getElementById("original-script-display-stage1"),e.originalDisplay&&(e.originalDisplay.textContent=nt(a)),localStorage.setItem("cardBeingEditedId",t.id);try{const r=JSON.parse(localStorage.getItem("edit_draft_"+t.id)||"null");r&&((document.getElementById("revision-instruction")||{}).value=r.text||"",(document.getElementById("revision-instruction-stage2")||{}).value=r.text||"",(r.sections||[]).forEach(c=>{const l=document.getElementById(c);l&&l.classList.contains("section-checkbox")&&(l.checked=!0)}))}catch{}const n=()=>{const r=(document.getElementById("revision-instruction")||{}).value||"",c=Array.from(document.querySelectorAll(".section-checkbox")).filter(l=>l.checked).map(l=>l.id);localStorage.setItem("edit_draft_"+t.id,JSON.stringify({text:r,sections:c,ts:Date.now()})),(r||c.length>0)&&(window.onbeforeunload=l=>(l.preventDefault(),l.returnValue="",""))},o=(()=>{let r;return()=>{clearTimeout(r),r=setTimeout(n,500)}})(),s=document.getElementById("revision-instruction");s&&s.addEventListener("input",o);const i=document.getElementById("revision-instruction-stage2");i&&i.addEventListener("input",o),document.querySelectorAll(".section-checkbox").forEach(r=>r.addEventListener("change",o)),e.el.classList.remove("opacity-0","pointer-events-none"),e.el.querySelector(".modal-content").classList.remove("scale-95")}function za(t,e,a){document.getElementById("edit-modal-stage-1").style.display="none",document.getElementById("edit-modal-stage-2").style.display="block";const n=document.getElementById("before-script-display"),o=document.getElementById("after-script-display"),s=document.getElementById("revision-instruction-stage2");n&&(n.textContent=nt(t,["hook","body","cta"]));const i={...t,...e};o.textContent=nt(i,["hook","body","cta"]),de=e,s.value=document.getElementById("revision-instruction").value}function nt(t,e=["hook","body","cta"]){if(!t)return d("script_not_found")||"Skrip tidak ditemukan.";let a=`${d("title_label")||"Judul"}: ${t.title}

`;const n=(o,s)=>{if(!s)return"";let i=`--- ${o.toUpperCase()} ---
`;return i+=`${d("script_text_label")||"Teks Skrip"}: ${s.text}
`,s.shots.forEach((r,c)=>{i+=`${d("visual_idea_label")||"Ide Visual"} ${c+1}: ${r.visual_idea}
`}),i+`
`};return t.hook&&e.includes("hook")&&(a+=n("HOOK",t.hook)),t.body&&e.includes("body")&&(a+=n("BODY",t.body)),t.cta&&e.includes("cta")&&(a+=n("CTA",t.cta)),t.slides&&t.slides.forEach((o,s)=>{e.includes(`slide${s}`)&&(a+=`--- SLIDE ${s+1} ---
`,a+=`${d("slide_text_label")||"Slide Text"}: ${o.slide_text}
`)}),a}function we(){const{editModal:t}=m;t.el.classList.add("opacity-0","pointer-events-none"),t.el.querySelector(".modal-content").classList.add("scale-95"),localStorage.removeItem("cardBeingEditedId"),de=null}function Te(t,e=!1){var o;const a=typeof((o=t.dataset)==null?void 0:o.script)=="string"?JSON.parse(t.dataset.script):t;let n=`${d("script_title_label")||"Judul"}: ${a.title}

`;if(a.hook){a.character_sheet&&a.character_sheet.length>0&&(a.character_sheet.forEach(i=>{n+=`${d("character_label")||"Karakter"}: ${aa(i)}
`}),n+=`
`);const s=(i,r)=>{let c=`${i}:
${r.text}
`;return r.shots.forEach((l,u)=>{c+=` ${d("shot_label")||"Shot"} ${u+1} ${d("visual_idea_label_short")||"Ide"}: ${l.visual_idea}
`,c+=` ${d("shot_label")||"Shot"} ${u+1} ${d("t2i_prompt_label_short")||"T2I"}: ${l.text_to_image_prompt}
`,c+=` ${d("shot_label")||"Shot"} ${u+1} ${d("i2v_prompt_label_short")||"I2V"}: ${l.image_to_video_prompt}
`}),c};n+=s(d("hook_title"),a.hook),n+=`
${s(d("body_title"),a.body)}`,n+=`
${s(d("cta_title"),a.cta)}`}else a.slides&&a.slides.forEach((s,i)=>{n+=`--- ${d("slide_label")} ${i+1} ---
`,n+=`${d("slide_text_label")}: ${s.slide_text}
`,n+=`${d("t2i_prompt_label")}: ${s.text_to_image_prompt}
`,s.layout_suggestion&&(n+=`${d("slide_layout_suggestion")}: ${s.layout_suggestion}
`),s.engagement_idea&&(n+=`${d("slide_engagement_idea")}: ${s.engagement_idea}
`),n+=`
`});return n}function aa(t){if(!t)return"";const e=[];t.name&&e.push(t.name),t.age&&e.push(`${t.age} years old`),t.ethnicity&&e.push(t.ethnicity),t.skin_tone&&e.push(`${t.skin_tone} skin`),t.face_shape&&e.push(`${t.face_shape} face`),t.body_shape&&e.push(t.body_shape);const a=[];return t.hair_style&&a.push(t.hair_style),t.hair_color&&a.push(t.hair_color),a.length>0&&e.push(`${a.join(" ")} hair`),t.eye_color&&e.push(`${t.eye_color} eyes`),e.join(", ")}function Wa(t){const e=t||{};let a=[],n=[];const o=["age","ethnicity","gender","name","vibe","unique_features","clothing_style","makeup_style"];e.name&&a.push(`a character named ${e.name}`),o.forEach(r=>{e[r]&&r!=="name"&&a.push(`${r.replace("_"," ")}: ${e[r]}`)});const s=a.join(", ");for(const r in e)if(Object.hasOwn(e,r)&&e[r]){const c=String(e[r]).split(" ").slice(0,3).join("_");n.push(`${r}=${c}`)}const i=`charID[${n.join(";").replace(/\s+/g,"_").toLowerCase()}]`;return{essence:s,stableId:i}}function Xa(t){if(!t)return"";const e=t.age?`${t.age}-year-old`:"",a=T=>Za((T||"").toString()),n=a(t.ethnicity),o=a(t.gender),s=a(t.face_shape),i=a(t.eye_color),r=a(t.eye_shape),c=r?/(shape|shaped)$/i.test(r)?r:`${r}-shaped`:"",l=t.eyebrow_style?`${a(t.eyebrow_style)} eyebrows`:"",u=t.nose_shape?`${a(t.nose_shape)} nose`:"",y=t.lip_shape?`${a(t.lip_shape)} lips`:"";a(t.hair_style),a(t.hair_color);const p=t.skin_tone?`${a(t.skin_tone)} skin`:"",h=t.height?`${a(t.height)} height`:"";a(t.vibe||t.notes||"");const f=[a(t.clothing_style),a(t.specific_outfit)].filter(Boolean).join(" "),g=[a(t.unique_features),a(t.makeup_style)].filter(Boolean).join(", "),E=t.name?` named ${a(t.name)}`:"",k=[e,n,o].filter(Boolean).join(" ")+E+".",L=[s&&`${s} face`,(i||c)&&`${c} ${i} eyes`.trim(),l,u,y].filter(Boolean).join(", "),b=[p,h].filter(Boolean).join(", "),P=f?`Wearing ${f}.`:"",_=g?`Notable features: ${g}.`:"";return`${k} ${L?L+".":""} ${b?b+".":""} ${P} ${_} Natural micro-expressions, coherent facial proportions, consistent look across shots.`.replace(/\b(lips)\s+\1\b/gi,"$1").replace(/almond\-shape(d)?/gi,"almond-shaped").replace(/gray\s*-\s*gray/gi,"gray").replace(/\s+/g," ").trim()}function Za(t){let e=(t||"").toString().toLowerCase();return[["indonesia korea","indonesian-korean"],["indonesia","indonesian"],["korea","korean"],["abu-abu","gray"],["abu abu","gray"],["abu","gray"],["tebal","thick"],["tipis","thin"],["mancung","high-bridged"],["oval","oval"],["almond","almond"],["alomnd","almond"],["bulat","round"],["putih cerah berseri","fair glowing"],["putih cerah","fair"],["gelap","dark"],["panjang","long"],["pendek","short"],["lurus","straight"],["ikal","wavy"],["keriting","curly"],["hitam","black"],["coklat","brown"],["biru","blue"],["hijau","green"],["merah","red"],["pink","pink"],["lesung pipi","dimples"],["minimalis","minimalist outfit"],["kasual","casual outfit"],["make up","makeup"],["punya dimples yang hanya muncul saat tersenyum","dimples that appear only when smiling"]].forEach(([n,o])=>{e=e.replace(new RegExp(`\\b${n}\\b`,"g"),o)}),e=e.replace(/alomnd/gi,"almond"),e=e.replace(/gray\s*-\s*gray/gi,"gray"),e.trim()}function na(t,e){if(!Array.isArray(e)||e.length===0)return[];const a=(t||"").toLowerCase(),n=[{key:"handle",words:["handle","grip","pegangan"],picks:["handle","grip"]},{key:"interior",words:["interior","inside","non-stick","coating"],picks:["non-stick","speckled"]},{key:"rim",words:["rim","edge","lip"],picks:["rim","edge"]},{key:"body",words:["body","exterior","bowl","round","curved"],picks:["bowl","curved","exterior"]}],o=new Set;return n.forEach(s=>{s.words.some(i=>a.includes(i))&&e.forEach(i=>{s.picks.some(r=>i.toLowerCase().includes(r))&&o.add(i)})}),o.size<3&&e.slice(0,4).forEach(s=>o.add(s)),Array.from(o).slice(0,4)}function oa(t,e="",a="",n=""){const o=(t||"").toLowerCase(),s=(n||"").toLowerCase(),i=`${o}
${s}`,r=["before","sebelum","competitor","kompetitor","competitor's","brand lain","produk lain","bukan produk kita","generic","murahan","non-brand","non brand","nonbrand","tanpa merek","tanpa brand","no brand","unbranded","old","lama","worn","rusak","dented","scratched","kotor","dirty","greasy","lengket","sticky","gosong","burnt","messy","berantakan","bad condition","poor condition"],l=(h=>(h||"").toLowerCase().replace(/[^a-z0-9\s-]/g," ").trim())(a).split(/\s+/).filter(h=>h.length>1),u=["our","produk kita","brand kita","milik kita","kita","our brand","with our product"].concat(l),y=r.some(h=>i.includes(h)),p=u.some(h=>i.includes(h));return!(y&&!p)}function yo(t,e=""){const a=`${t||""}
${e||""}`.toLowerCase(),n=["face","portrait","model","person","character","woman","man","girl","boy","actor","actress","smile","eyes","eye","hair","skin","elena","he ","she ","her ","his "],o=["hands only","only hands","close-up hands","tangan saja","hanya tangan"],s=n.some(r=>a.includes(r));return o.some(r=>a.includes(r))&&!s?!1:s}window.useVariant=async function(t,e){const a=document.querySelector(`[data-part="${t}"]`);if(!a)return;const n=a.closest(".result-card");if(!n)return;const o=JSON.parse(n.dataset.script||"{}");if(!o)return;const s=`${t}_variants`,i=o[s];if(!i||!i[e])return;const r=i[e];try{const{applyVariantToScript:c}=await $(async()=>{const{applyVariantToScript:u}=await Promise.resolve().then(()=>Fe);return{applyVariantToScript:u}},void 0);await c(n,o,t,r);const l=a.querySelector(`[data-variant-index="${e}"]`);l&&(l.style.backgroundColor="#065f46",l.style.borderColor="#10b981",setTimeout(()=>{l.style.backgroundColor="",l.style.borderColor=""},2e3))}catch(c){console.error("Error applying variant:",c),o[t]&&o[t].text&&(o[t].text=r),n.dataset.script=JSON.stringify(o);const l=a.querySelector("p");l&&(l.textContent=r);const u=d("variant_applied_success",{part:t.toUpperCase()})||`Variant ${t.toUpperCase()} successfully applied!`;v(u,"success")}};const X=Object.freeze(Object.defineProperty({__proto__:null,chooseShotFeatures:na,closeConfirmModal:et,closeEditModal:we,closeInputModal:Rt,get confirmCallback(){return Je},copyToClipboard:Ee,createCharacterEssence:Xa,createCharacterTokens:Wa,elements:m,fileToBase64:Ka,getCharacterDescriptionString:aa,getFullScriptText:Te,getSimpleScriptTextForModal:nt,isCharacterVisible:yo,languageState:q,normalizeToEnglish:Za,openConfirmModal:ye,openEditModal:ta,openInputModal:ut,setLoadingState:z,shouldAttachProductId:oa,showActionNotification:ho,showBeforeAfter:za,showNotification:v,get tempGeneratedPart(){return de},themeState:ea},Symbol.toStringTag,{value:"Module"}));function ee(t){var e;m.generatorPage.classList.toggle("hidden",t!=="generator"),m.historyPage.classList.toggle("hidden",t!=="history"),m.settingsPage.classList.toggle("hidden",t!=="settings"),(e=m.accountPage)==null||e.classList.toggle("hidden",t!=="account"),[m.navGenerator,m.mobileNavGenerator].forEach(a=>a==null?void 0:a.classList.toggle("active",t==="generator")),[m.navHistory,m.mobileNavHistory].forEach(a=>a==null?void 0:a.classList.toggle("active",t==="history")),[m.navSettings,m.mobileNavSettings].forEach(a=>a==null?void 0:a.classList.toggle("active",t==="settings")),[m.navAccount,m.mobileNavAccount].forEach(a=>a==null?void 0:a.classList.toggle("active",t==="account"))}function Me(){m.mobileMenu.classList.toggle("hidden"),m.menuOpenIcon.classList.toggle("hidden"),m.menuCloseIcon.classList.toggle("hidden")}function fo(){ee("generator")}window.switchToGenerator=fo;async function _o(){return(await $(()=>Promise.resolve().then(()=>Fe),void 0)).createResultCard}let se=1,tt=5,xe=[],Ie=[],Qa="newest",Dt="",qt="all",en=!1,xt=new Set;function tn(t,e,a){let n=JSON.parse(localStorage.getItem("direktiva_history"))||[],o=a;const s={id:Date.now(),productName:e||m.inputs.productName.value||d("untitled_script"),mode:o,scripts:t};n.unshift(s),n.length>50&&n.pop(),localStorage.setItem("direktiva_history",JSON.stringify(n)),localStorage.setItem("direktiva_history_last_modified",new Date().toISOString())}async function mt(){try{const{cloudStorage:t}=await $(async()=>{const{cloudStorage:e}=await Promise.resolve().then(()=>pt);return{cloudStorage:e}},void 0);if(t&&typeof t.fetchHistoryTags=="function"){const e=await t.fetchHistoryTags();if(e&&Object.keys(e).length)try{const a=JSON.parse(localStorage.getItem("direktiva_history_tags")||"{}"),n={...e,...a};localStorage.setItem("direktiva_history_tags",JSON.stringify(n))}catch{}}}catch(t){console.warn("Fetch server tags skipped",t)}return Ie=JSON.parse(localStorage.getItem("direktiva_history"))||[],Ce(),Ye(),Ie}function Ce(){let t=[...Ie];switch(qt!=="all"&&(t=t.filter(e=>e.mode===qt)),Dt.trim()&&(t=t.filter(e=>e.productName.toLowerCase().includes(Dt.toLowerCase()))),Qa){case"oldest":t.sort((e,a)=>e.id-a.id);break;case"name":t.sort((e,a)=>e.productName.localeCompare(a.productName));break;case"newest":default:t.sort((e,a)=>a.id-e.id);break}en?xe=vo(t):xe=t,Ye()}function vo(t){const e={};return t.forEach(n=>{e[n.productName]||(e[n.productName]=[]),e[n.productName].push(n)}),Object.keys(e).map(n=>({productName:n,entries:e[n]}))}async function Ye(){const t=document.getElementById("history-panel"),e=document.getElementById("history-empty-state");if(!t)return;if(xe.length===0){t.innerHTML="",e&&e.classList.remove("hidden"),Oa();return}else e&&e.classList.add("hidden");const a=(se-1)*tt,n=a+tt,o=xe.slice(a,n);t.innerHTML="";for(const i of o){const r=i&&Array.isArray(i.scripts)?i.scripts[0]||null:i;if(!r)continue;const l=await(await _o())(r,0);t.appendChild(l)}const s=Math.ceil(xe.length/tt);bo(s),Oa()}function bo(t){const e=document.getElementById("history-pagination"),a=document.getElementById("prev-page"),n=document.getElementById("next-page"),o=document.getElementById("current-page"),s=document.getElementById("total-pages");if(t<=1){e.classList.add("hidden");return}e.classList.remove("hidden"),o.textContent=se,s.textContent=t,a.disabled=se===1,n.disabled=se===t}async function ot(t){let e=JSON.parse(localStorage.getItem("direktiva_history"))||[];const a=Array.isArray(t)?t.map(Number):[Number(t)],n=e.filter(o=>!a.includes(o.id));localStorage.setItem("direktiva_history",JSON.stringify(n)),localStorage.setItem("direktiva_history_last_modified",new Date().toISOString()),await mt()}async function an(){localStorage.removeItem("direktiva_history"),localStorage.setItem("direktiva_history_last_modified",new Date().toISOString());try{const{cloudStorage:t}=await $(async()=>{const{cloudStorage:e}=await Promise.resolve().then(()=>pt);return{cloudStorage:e}},void 0);t&&typeof t.deleteAllHistory=="function"&&await t.deleteAllHistory()}catch(t){console.warn("Failed to delete history from cloud storage:",t.message)}await mt()}function sa(t){const e=Math.ceil(xe.length/tt);t>=1&&t<=e&&(se=t,Ye())}function nn(){sa(se+1)}function on(){sa(se-1)}function ra(t){Dt=t,Ce(),Ye()}function ia(t){Qa=t,se=1,Ce(),Ye()}function ca(t){qt=t,se=1,Ce(),So(t)}window.toggleGroup=function(t){xt.has(t)?xt.delete(t):xt.add(t),Ce()};window.selectGroupEntries=function(t){const e=document.querySelectorAll(`[data-group-name="${t}"] .history-checkbox`),a=Array.from(e).every(n=>n.checked);e.forEach(n=>{n.checked=!a,n.dispatchEvent(new Event("change"))})};function So(t){document.querySelectorAll(".post-type-tab").forEach(n=>{n.classList.remove("active")});const a=document.querySelector(`.post-type-tab[data-filter="${t}"]`);a&&a.classList.add("active")}function Oa(){const t={all:document.getElementById("count-all"),single:document.getElementById("count-single"),carousel:document.getElementById("count-carousel")};!t.all||!t.single||!t.carousel||(t.all.textContent=Ie.length,t.single.textContent=Ie.filter(e=>e.mode==="single").length,t.carousel.textContent=Ie.filter(e=>e.mode==="carousel").length)}function sn(t){document.querySelectorAll(".history-checkbox").forEach(a=>a.checked=t),la()}function la(){const t=document.querySelectorAll(".history-checkbox:checked").length>0,e=document.getElementById("delete-selected-btn");e&&(e.disabled=!t,t?e.classList.remove("hidden"):e.classList.add("hidden"))}function rn(){const t=document.getElementById("group-by-product");en=!!(t&&t.checked),Ce()}function cn(){const t=document.querySelectorAll(".history-checkbox"),e=document.getElementById("select-all-history");if(!e)return;const a=Array.from(t).length>0&&Array.from(t).every(n=>n.checked);e.checked=a}window.handleSearchInput=function(t){ra(t.target.value)};window.handleSortChange=function(t){ia(t.target.value)};window.handlePostTypeFilter=function(t){ca(t.target.dataset.filter)};window.handleDeleteSelected=async function(){const t=Array.from(document.querySelectorAll(".history-checkbox:checked")).map(e=>Number(e.closest(".history-entry").dataset.entryId));t.length>0&&await ot(t)};window.handleDeleteAll=async function(){await an()};const It=Object.freeze(Object.defineProperty({__proto__:null,deleteAllHistory:an,deleteFromHistory:ot,goToPage:sa,loadHistory:mt,nextPage:nn,prevPage:on,saveToHistory:tn,selectAllHistory:sn,setPostTypeFilter:ca,setSearchQuery:ra,setSortOrder:ia,toggleGroupByProduct:rn,updateDeleteSelectedButton:la,updateSelectAllCheckbox:cn},Symbol.toStringTag,{value:"Module"})),J={SYNCED:"synced",SYNCING:"syncing",OFFLINE:"offline",ERROR:"error"},ko=1e4;let Ue=null;const ke={SYNC_STATUS:"direktiva_sync_status",LAST_SYNC:"direktiva_last_sync",PENDING_SYNC:"direktiva_pending_sync",OFFLINE_CHANGES:"direktiva_offline_changes"};class wo{constructor(){this.syncStatus=J.OFFLINE,this.isOnline=navigator.onLine,this.syncInProgress=!1,this.pendingOperations=[],window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),this.updateSyncStatus()}async init(){try{const{data:{session:e}}=await x.auth.getSession();e&&this.isOnline?await this.syncAll():this.setSyncStatus(J.OFFLINE)}catch(e){console.warn("Cloud storage not available, running in offline mode:",e.message),this.setSyncStatus(J.OFFLINE)}}async handleOnline(){this.isOnline=!0,console.log("Device is online, attempting to sync...");const{data:{session:e}}=await x.auth.getSession();e&&await this.syncAll()}handleOffline(){this.isOnline=!1,this.setSyncStatus(J.OFFLINE),console.log("Device is offline, storing changes locally")}setSyncStatus(e){this.syncStatus=e,localStorage.setItem(ke.SYNC_STATUS,e),this.updateSyncIndicator(e)}updateSyncStatus(){this.isOnline?this.syncInProgress?this.setSyncStatus(J.SYNCING):this.setSyncStatus(J.SYNCED):this.setSyncStatus(J.OFFLINE)}updateSyncIndicator(e){const a=document.getElementById("sync-indicator");if(!a)return;a.className=`sync-indicator sync-${e}`;const n={[J.SYNCED]:d("sync_status_synced")||"Synced",[J.SYNCING]:d("sync_status_syncing")||"Syncing...",[J.OFFLINE]:d("sync_status_offline")||"Offline",[J.ERROR]:d("sync_status_error")||"Sync Error"};a.textContent=n[e],a.title=n[e]}async syncAll(){if(!(this.syncInProgress||!this.isOnline)){this.syncInProgress=!0,this.setSyncStatus(J.SYNCING);try{const{data:{session:e}}=await x.auth.getSession();if(!e){console.warn("No active session, switching to offline mode"),this.setSyncStatus(J.OFFLINE);return}await this.processPendingOperations(),await this.syncSettings(),await this.syncGeneratorPresets(),await this.syncCharacterPresets(),await this.syncPersonas(),await this.syncHistory(),typeof window<"u"&&setTimeout(()=>{try{window.populatePresetSelector&&window.populatePresetSelector(),window.populateCharacterPresetSelector&&window.populateCharacterPresetSelector()}catch(a){console.warn("Failed to populate selectors after sync:",a.message)}},200),localStorage.setItem(ke.LAST_SYNC,new Date().toISOString()),this.setSyncStatus(J.SYNCED),console.log("All data synced successfully")}catch(e){console.warn("Sync failed, switching to offline mode:",e.message),this.setSyncStatus(J.OFFLINE)}finally{this.syncInProgress=!1}}}async syncSettings(){try{const{data:{session:e},error:a}=await x.auth.getSession();if(a)throw new Error("Failed to get session: "+a.message);if(!e||!e.user)throw new Error("User not authenticated");const n=e.user,o={theme:localStorage.getItem("direktiva_theme")||localStorage.getItem("aethera_theme")||"dark",language:localStorage.getItem("direktiva_language")||localStorage.getItem("aethera_language")||"id",system_prompt:localStorage.getItem("direktiva_system_prompt")||localStorage.getItem("aethera_system_prompt")},{data:s,error:i}=await x.from("user_settings").select("*").eq("user_id",n.id).single();if(i&&i.code!=="PGRST116")throw i;if(s){let r;const c=this.hasLocalChanges("settings",s.updated_at);c?r={theme:o.theme,language:o.language,system_prompt:o.system_prompt}:r=this.mergeSettings(o,s),localStorage.setItem("aethera_theme",r.theme),localStorage.setItem("aethera_language",r.language),r.system_prompt&&localStorage.setItem("aethera_system_prompt",r.system_prompt);try{document.documentElement.lang=r.language}catch{}if(typeof window<"u"&&window.updateLanguageButtons)try{window.updateLanguageButtons()}catch{}if(c){const{error:l}=await x.from("user_settings").update({theme:r.theme,language:r.language,system_prompt:r.system_prompt}).eq("user_id",s.user_id);if(l)throw l}}else{const{error:r}=await x.from("user_settings").insert([{user_id:n.id,theme:o.theme,language:o.language,system_prompt:o.system_prompt}]);if(r)throw r}}catch(e){console.warn("Failed to sync settings, continuing in offline mode:",e.message)}}async syncGeneratorPresets(){const e=JSON.parse(localStorage.getItem("aethera_settings_presets")||"[]"),a={};e.forEach(l=>{a[l.name]=l.settings});const{data:n,error:o}=await x.from("user_presets").select("*").eq("type","generator").order("created_at",{ascending:!1});if(o)throw o;const s=localStorage.getItem("aethera_presets_last_modified"),i=s?isNaN(Number(s))?Date.parse(s):Number(s):0,r=n&&n.length>0?Math.max(...n.map(l=>new Date(l.created_at).getTime())):0,c=!i||r>parseInt(i);await this.syncGeneratorPresetsInternal(a,n||[],c),r>0&&localStorage.setItem("aethera_presets_last_modified",String(r))}async syncGeneratorPresetsInternal(e,a,n=!1){const{data:{session:o}}=await x.auth.getSession();if(!o||!o.user)throw new Error("User not authenticated");const s=o.user,i=new Set(a.map(h=>h.name)),r=[],c=new Map;if(a.forEach(h=>{c.set(h.name,h)}),Object.entries(e).forEach(([h,f])=>{i.has(h)||r.push({user_id:s.id,name:h,type:"generator",settings:f})}),r.length>0){const{error:h}=await x.from("user_presets").insert(r);if(h)throw h}if(!n){const h=[];for(const[f,g]of Object.entries(e))if(c.has(f)){const E=c.get(f),k=E.settings||{};try{const L=JSON.stringify(g||{}),b=JSON.stringify(k);L!==b&&h.push({id:E.id,settings:g})}catch{h.push({id:E.id,settings:g})}}for(const f of h){const{error:g}=await x.from("user_presets").update({settings:f.settings}).eq("id",f.id);if(g)throw g}}const l=n?{}:{...e};JSON.parse(localStorage.getItem("aethera_settings_presets")||"[]").map(h=>h.name),a.forEach(h=>{h.settings&&(n||!e.hasOwnProperty(h.name))&&(l[h.name]=h.settings)});const y=JSON.parse(localStorage.getItem("aethera_settings_presets")||"[]"),p=Object.entries(l).map(([h,f])=>{const g=y.find(k=>k.name===h),E=a.find(k=>k.name===h);return{id:(g==null?void 0:g.id)||(E==null?void 0:E.id)||`preset_${h.replace(/\s+/g,"_").toLowerCase()}_${Date.now()}`,name:h,settings:f}});localStorage.setItem("aethera_settings_presets",JSON.stringify(p)),typeof window<"u"&&window.populatePresetSelector&&setTimeout(()=>window.populatePresetSelector(),100)}async syncCharacterPresets(){try{const e=JSON.parse(localStorage.getItem("aethera_character_presets")||"[]"),{data:a,error:n}=await x.from("user_presets").select("*").eq("type","character").order("created_at",{ascending:!1});if(n)throw n;const o=localStorage.getItem("aethera_character_presets_last_modified"),s=o?isNaN(Number(o))?Date.parse(o):Number(o):0,i=a&&a.length>0?Math.max(...a.map(c=>new Date(c.created_at).getTime())):0,r=!s||i>parseInt(s);await this.syncCharacterPresetsInternal(e,a||[],r),i>0&&localStorage.setItem("aethera_character_presets_last_modified",String(i))}catch(e){console.warn("Failed to sync character presets, continuing in offline mode:",e.message)}}async syncCharacterPresetsInternal(e,a,n=!1){const{data:{session:o}}=await x.auth.getSession();if(!o||!o.user)throw new Error("User not authenticated");const s=o.user,i=new Set(a.map(p=>p.name)),r=new Map;a.forEach(p=>{var f;const h=(f=p==null?void 0:p.settings)==null?void 0:f.id;h&&r.set(String(h),p)});const c=[],l=[];for(const p of e){const h=p!=null&&p.id?String(p.id):"";if(h&&r.has(h)){const f=r.get(h);f.name!==p.name&&l.push({id:f.id,name:p.name});continue}i.has(p.name)||c.push(p)}if(c.length>0){const{error:p}=await x.from("user_presets").insert(c.map(h=>({user_id:s.id,name:h.name,type:"character",settings:h})));if(p)throw p}if(l.length>0)for(const p of l){const{error:h}=await x.from("user_presets").update({name:p.name}).eq("id",p.id);if(h)throw h}const u=n?[]:[...e];JSON.parse(localStorage.getItem("aethera_character_presets")||"[]").map(p=>p.name),a.forEach(p=>{const h=u.findIndex(f=>f.name===p.name);if(h===-1){const f=e.find(g=>g.name===p.name);if(n||f){const g=p.settings;g.id||(g.id=`preset_${p.name.replace(/\s+/g,"_").toLowerCase()}_${Date.now()}`),u.push(g)}}else{const f=u[h].id;u[h]={...p.settings,id:f}}}),localStorage.setItem("aethera_character_presets",JSON.stringify(u)),typeof window<"u"&&window.populateCharacterPresetSelector&&setTimeout(()=>{try{window.populateCharacterPresetSelector()}catch(p){console.warn("Failed to populate character preset selector after sync:",p.message)}},100)}async syncPersonas(){try{const{data:{session:e}}=await x.auth.getSession();if(!e||!e.user)throw new Error("User not authenticated");const a=e.user,n=JSON.parse(localStorage.getItem("aethera_personas")||"[]"),{data:o,error:s}=await x.from("user_personas").select("*").order("created_at",{ascending:!1});if(s)throw s;const i=this.mergePersonas(n,o||[]);localStorage.setItem("aethera_personas",JSON.stringify(i.local));for(const r of i.toUpload)if(r.id&&r.id.toString().length<10){const{error:c}=await x.from("user_personas").insert([{user_id:a.id,name:r.name,description:r.description,avatar:r.avatar,personality:r.personality||{}}]);if(c)throw c}else{const{error:c}=await x.from("user_personas").update({name:r.name,description:r.description,avatar:r.avatar,personality:r.personality||{}}).eq("id",r.id);if(c)throw c}}catch(e){console.warn("Failed to sync personas, continuing in offline mode:",e.message)}}async syncHistory(){try{const{data:{session:e}}=await x.auth.getSession();if(!e||!e.user)throw new Error("User not authenticated");const a=e.user,n=JSON.parse(localStorage.getItem("aethera_history")||"[]"),{data:o,error:s}=await x.from("user_history").select("*").order("created_at",{ascending:!1}).limit(100);if(s)throw s;const i=this.mergeHistory(n,o||[]);localStorage.setItem("aethera_history",JSON.stringify(i.local.slice(0,50)));for(const r of i.toUpload){const c=r.timestamp||Date.now(),l=isNaN(c)?Date.now():c,u=r.productName||r.product_name||"Untitled Script",{error:y}=await x.from("user_history").insert([{user_id:a.id,product_name:u,scripts:r.scripts||[],post_type:r.postType||r.post_type||"single",image_url:r.imageUrl||r.image_url||null,created_at:new Date(l).toISOString()}]);if(y)throw y}}catch(e){console.warn("Failed to sync history, continuing in offline mode:",e.message)}}async processPendingOperations(){const e=JSON.parse(localStorage.getItem(ke.PENDING_SYNC)||"[]");for(const a of e)try{await this.executeOperation(a)}catch(n){console.error("Failed to execute pending operation:",a,n)}localStorage.removeItem(ke.PENDING_SYNC)}async executeOperation(e){const{type:a,action:n,data:o}=e;switch(a){case"presets":if(n==="create")await x.from("user_presets").insert([o]);else if(n==="update"){const s={name:o.name};if(Object.prototype.hasOwnProperty.call(o,"settings")&&(s.settings=o.settings),o.id)await x.from("user_presets").update(s).eq("id",o.id);else if(o.previous_name&&o.type){const{data:{session:i}}=await x.auth.getSession();i!=null&&i.user&&await x.from("user_presets").update(s).eq("user_id",i.user.id).eq("type",o.type).eq("name",o.previous_name)}}else n==="delete"&&(o.id?await x.from("user_presets").delete().eq("id",o.id):o.name&&o.type&&await x.from("user_presets").delete().eq("name",o.name).eq("type",o.type));break;case"personas":n==="create"?await x.from("user_personas").insert([o]):n==="update"?await x.from("user_personas").update(o).eq("id",o.id):n==="delete"&&await x.from("user_personas").delete().eq("id",o.id);break;case"history":if(n==="create"){const s={...o,product_name:o.product_name||o.productName||"Untitled Script",scripts:o.scripts||[],post_type:o.post_type||o.postType||"single",image_url:o.image_url||o.imageUrl||null};await x.from("user_history").insert([s])}else n==="delete"&&await x.from("user_history").delete().eq("id",o.id);break}}async deleteAllHistory(){try{const{data:{session:e}}=await x.auth.getSession();if(!e||!e.user){console.warn("User not authenticated, cannot delete cloud history");return}const{error:a}=await x.from("user_history").delete().eq("user_id",e.user.id);if(a)throw a;console.log("All user history deleted from cloud storage")}catch(e){console.warn("Failed to delete history from cloud storage:",e.message)}}addPendingOperation(e,a,n){const o=JSON.parse(localStorage.getItem(ke.PENDING_SYNC)||"[]");o.push({type:e,action:a,data:n,timestamp:Date.now()}),localStorage.setItem(ke.PENDING_SYNC,JSON.stringify(o))}mergeSettings(e,a){return{theme:a.theme||e.theme,language:a.language||e.language,system_prompt:a.system_prompt||e.system_prompt}}mergePersonas(e,a){const n=[...a],o=[];for(const s of e)a.find(r=>r.name===s.name&&r.description===s.description)||(n.push(s),o.push(s));return{local:n,toUpload:o}}mergeHistory(e,a){const n=a.map(i=>({id:i.created_at?new Date(i.created_at).getTime():Date.now(),productName:i.product_name||"Untitled Script",mode:i.post_type||"single",scripts:i.scripts||[],timestamp:i.created_at?new Date(i.created_at).getTime():Date.now()})),o=[...n],s=[];for(const i of e){const r=i.timestamp||i.id||Date.now(),c=isNaN(r)?Date.now():r,l=i.productName||i.product_name||"Untitled Script";if(!n.find(y=>{const p=y.timestamp||Date.now(),h=Math.abs(p-c),f=y.productName===l,g=h<3e5;let E=!1;if(i.scripts&&i.scripts.length>0&&y.scripts&&y.scripts.length>0){const k=i.scripts[0],L=y.scripts[0];k.hook&&L.hook?E=k.hook===L.hook&&k.body===L.body:k.slides&&L.slides&&k.slides.length>0&&L.slides.length>0&&(E=k.slides[0].slide_text===L.slides[0].slide_text)}return f&&(g||E)})&&i.scripts&&i.scripts.length>0){const y={id:i.id,productName:l,mode:i.mode||"single",scripts:i.scripts,timestamp:c};o.push(y),s.push({...i,productName:l,scripts:i.scripts,postType:i.mode||"single",imageUrl:i.imageUrl||null})}}return o.sort((i,r)=>{const c=i.timestamp||Date.now();return(r.timestamp||Date.now())-c}),{local:o,toUpload:s}}hasLocalChanges(e,a){const n=localStorage.getItem(`aethera_${e}_last_modified`);if(!n)return!1;try{const o=new Date(n),s=new Date(a);return isNaN(o.getTime())||isNaN(s.getTime())?!1:o>s}catch{return console.warn("Invalid date values in hasLocalChanges:",{lastLocalChange:n,cloudUpdatedAt:a}),!1}}async exportBackup(){const e={version:"1.0",timestamp:new Date().toISOString(),data:{settings:{theme:localStorage.getItem("aethera_theme"),language:localStorage.getItem("aethera_language"),system_prompt:localStorage.getItem("aethera_system_prompt")},personas:JSON.parse(localStorage.getItem("aethera_personas")||"[]"),history:JSON.parse(localStorage.getItem("aethera_history")||"[]"),presets:JSON.parse(localStorage.getItem("aethera_last_settings")||"{}")}},a=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download=`aethera-backup-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),v(d("notification_backup_exported")||"Backup exported successfully")}async restoreBackup(e){try{const a=await e.text(),n=JSON.parse(a);if(!n.version||!n.data)throw new Error("Invalid backup file format");n.data.settings&&Object.entries(n.data.settings).forEach(([o,s])=>{s&&localStorage.setItem(`aethera_${o}`,s)}),n.data.personas&&localStorage.setItem("aethera_personas",JSON.stringify(n.data.personas)),n.data.history&&localStorage.setItem("aethera_history",JSON.stringify(n.data.history)),n.data.presets&&localStorage.setItem("aethera_last_settings",JSON.stringify(n.data.presets)),v(d("notification_backup_restored")||"Backup restored successfully"),this.isOnline&&await this.syncAll()}catch(a){console.error("Failed to restore backup:",a),v(d("notification_backup_restore_failed")||"Failed to restore backup","error")}}async fetchHistoryTags(){try{const{data:{session:e}}=await x.auth.getSession();if(!e||!e.user)return{};const{data:a,error:n}=await x.from("user_history_tags").select("history_id, tags").eq("user_id",e.user.id);if(n)throw n;const o={};return(a||[]).forEach(s=>{o[s.history_id]=s.tags||[]}),o}catch(e){return console.warn("fetchHistoryTags failed:",e.message),{}}}async upsertHistoryTags(e,a){try{const{data:{session:n}}=await x.auth.getSession();if(!n||!n.user)return!1;const o=[{user_id:n.user.id,history_id:String(e),tags:a||[]}],{error:s}=await x.from("user_history_tags").upsert(o,{onConflict:"user_id,history_id"});if(s)throw s;return!0}catch(n){return console.warn("upsertHistoryTags failed:",n.message),!1}}}function Eo(){Ue||(Ue=setInterval(async()=>{try{const{data:{session:t}}=await x.auth.getSession();t&&U.isOnline&&await U.syncAll()}catch(t){console.warn("Auto sync failed:",t.message)}},ko))}function xo(){Ue&&(clearInterval(Ue),Ue=null)}const U=new wo;U.startAutoSync=Eo;U.stopAutoSync=xo;const pt=Object.freeze(Object.defineProperty({__proto__:null,SYNC_STATUS:J,cloudStorage:U},Symbol.toStringTag,{value:"Module"})),Io=[{nameKey:"persona_template_industry_expert_name",descKey:"persona_template_industry_expert_desc"},{nameKey:"persona_template_close_friend_name",descKey:"persona_template_close_friend_desc"},{nameKey:"persona_template_honest_reviewer_name",descKey:"persona_template_honest_reviewer_desc"},{nameKey:"persona_template_smart_comedian_name",descKey:"persona_template_smart_comedian_desc"}];function Pe(){return JSON.parse(localStorage.getItem("aethera_personas"))||[]}function da(t){localStorage.setItem("aethera_personas",JSON.stringify(t)),localStorage.setItem("aethera_personas_last_modified",new Date().toISOString()),dn(),ua()}function Ma(t=null){const{personaModal:e}=m;t?(e.title.textContent=d("edit_persona_title")||"Edit Persona",e.idInput.value=t.id,e.nameInput.value=t.name,e.descInput.value=t.description):(e.title.textContent=d("add_new_persona_modal_title"),e.idInput.value="",e.nameInput.value="",e.descInput.value=""),e.el.classList.remove("opacity-0","pointer-events-none"),e.el.querySelector(".modal-content").classList.remove("scale-95")}function ln(){m.personaModal.el.classList.add("opacity-0","pointer-events-none"),m.personaModal.el.querySelector(".modal-content").classList.add("scale-95")}function Lo(){const{nameInput:t,descInput:e,idInput:a}=m.personaModal,n=t.value.trim(),o=e.value.trim(),s=a.value;if(!n||!o){v(d("notification_persona_empty"),"error");return}let i=Pe();if(s){const r=i.findIndex(c=>c.id===s);r>-1&&(i[r]={...i[r],name:n,description:o})}else{const r={id:`persona_${Date.now()}`,name:n,description:o};i.push(r)}da(i),ln(),v(d("notification_persona_saved"))}function Ao(t){ye(d("notification_persona_delete_confirm"),()=>{const a=Pe().filter(n=>n.id!==t);da(a),v(d("notification_persona_deleted"))})}function To(t,e){let a=Pe();if(a.some(o=>o.name.trim()===t.trim())){v(d("notification_persona_exists").replace("{name}",t),"warning");return}const n={id:`persona_${Date.now()}`,name:t,description:e};a.push(n),da(a),v(d("notification_persona_added").replace("{name}",t))}function dn(){const t=Pe(),{listContainer:e}=m.personaModal;if(e.innerHTML="",t.length===0){e.innerHTML=`<p class="text-sm text-gray-500 text-center py-4">${d("no_persona_yet")||"Belum ada persona. Tambahkan satu atau pilih dari template di bawah!"}</p>`;return}try{const a=new Set(JSON.parse(localStorage.getItem("aethera_pinned_personas")||"[]")),n=JSON.parse(localStorage.getItem("aethera_persona_usage")||"{}"),s=[...t].sort((r,c)=>{const l=a.has(String(r.id||r.name||"")),u=a.has(String(c.id||c.name||""));if(l!==u)return l?-1:1;const y=n[r.id||r.name]||0,p=n[c.id||c.name]||0;return y!==p?p-y:String(r.name||"").localeCompare(String(c.name||""))}).slice(0,6),i=document.getElementById("persona-quick-picks");i&&(i.innerHTML="",s.forEach(r=>{const c=document.createElement("button");c.className="px-2 py-1 text-xs rounded-full bg-gray-800 border border-gray-700 text-gray-200 hover:bg-gray-700",c.textContent=r.name||"Persona",c.title=(r.description||"").slice(0,140),c.addEventListener("click",()=>{selector.value=r.name;const h=document.getElementById("persona-description-display");h&&(h.textContent=r.description||"");try{U.incrementPersonaUsage(r.id||r.name,r.name)}catch{}});const l=document.createElement("button");l.className="ml-1 text-yellow-400 text-xs hover:opacity-80";const u=r.id||r.name,y=a.has(String(u));l.textContent=y?"":"",l.addEventListener("click",h=>{h.stopPropagation();const f=!a.has(String(u));f?a.add(String(u)):a.delete(String(u)),localStorage.setItem("aethera_pinned_personas",JSON.stringify([...a]));try{U.togglePersonaPin(u,f)}catch{}l.textContent=f?"":""});const p=document.createElement("div");p.className="inline-flex items-center",p.appendChild(c),p.appendChild(l),i.appendChild(p)}))}catch{}t.forEach(a=>{const n=document.createElement("div");n.className="bg-gray-800/70 p-4 rounded-lg flex items-center justify-between animate-fade-in",n.innerHTML=`
            <div>
                <h4 class="font-semibold text-white">${a.name}</h4>
                <p class="text-xs text-gray-400 truncate max-w-md">${a.description}</p>
            </div>
            <div class="flex space-x-2 flex-shrink-0">
                <button class="edit-persona-btn icon-btn primary" data-id="${a.id}" title="${d("edit_button")||"Edit"}">
                    <div class="icon icon-md icon-edit"></div>
                </button>
                <button class="delete-persona-btn icon-btn danger" data-id="${a.id}" title="${d("delete_button")||"Hapus"}">
                    <div class="icon icon-md icon-delete"></div>
                </button>
            </div>
        `,e.appendChild(n)})}function un(){const{defaultContainer:t}=m.personaModal;t.innerHTML="",typeof localStorage<"u"&&localStorage.getItem("aethera_language")||document.documentElement.lang,Io.forEach(e=>{const a=d(e.nameKey)||e.nameKey,n=d(e.descKey)||e.descKey,o=document.createElement("div");o.className="bg-gray-800/70 p-4 rounded-lg flex flex-col justify-between";const s=document.createElement("h5");s.className="font-semibold text-white mb-1",s.textContent=a;const i=document.createElement("p");i.className="text-xs text-gray-400 mb-4",i.textContent=n;const r=document.createElement("button");r.className="add-default-persona-btn mt-auto w-full text-center text-sm font-semibold py-1.5 rounded-md bg-sky-600/50 hover:bg-sky-600/80 transition-colors",r.textContent=d("add_to_my_list")||"+ Add to My List",r.dataset.name=a,r.dataset.desc=n,o.appendChild(s),o.appendChild(i),o.appendChild(r),t.appendChild(o)})}function ua(){const t=Pe(),e=m.personaSelector;e.innerHTML=`<option value="">${d("persona_default")}</option>`;try{const a=new Set(JSON.parse(localStorage.getItem("aethera_pinned_personas")||"[]")),n=JSON.parse(localStorage.getItem("aethera_persona_usage")||"{}"),s=[...t].sort((r,c)=>{const l=a.has(String(r.id||r.name||"")),u=a.has(String(c.id||c.name||""));if(l!==u)return l?-1:1;const y=n[r.id||r.name]||0,p=n[c.id||c.name]||0;return y!==p?p-y:String(r.name||"").localeCompare(String(c.name||""))}).slice(0,6),i=document.getElementById("persona-quick-picks");i&&(i.innerHTML="",s.forEach(r=>{const c=document.createElement("button");c.className="px-2 py-1 text-xs rounded-full bg-gray-800 border border-gray-700 text-gray-200 hover:bg-gray-700",c.textContent=r.name||"Persona",c.title=(r.description||"").slice(0,140),c.addEventListener("click",()=>{e.value=r.name;const h=document.getElementById("persona-description-display");h&&(h.textContent=r.description||"");try{U.incrementPersonaUsage(r.id||r.name,r.name)}catch{}});const l=document.createElement("button");l.className="ml-1 text-yellow-400 text-xs hover:opacity-80";const u=r.id||r.name,y=a.has(String(u));l.textContent=y?"":"",l.addEventListener("click",h=>{h.stopPropagation();const f=!a.has(String(u));f?a.add(String(u)):a.delete(String(u)),localStorage.setItem("aethera_pinned_personas",JSON.stringify([...a]));try{U.togglePersonaPin(u,f)}catch{}l.textContent=f?"":""});const p=document.createElement("div");p.className="inline-flex items-center",p.appendChild(c),p.appendChild(l),i.appendChild(p)}))}catch{}t.forEach(a=>{const n=document.createElement("option");n.value=a.id,n.textContent=a.name,e.appendChild(n)})}function gt(t){const n=document.getElementById("character-sheet-template").content.cloneNode(!0).querySelector(".character-sheet-instance");return n.dataset.index=t,n.querySelector(".character-title").textContent=d("character_number",{number:t+1})||`Character ${t+1}`,t>=2&&n.querySelector(".remove-character-btn").classList.remove("hidden"),Co(n),n}function Co(t){t.querySelectorAll("[data-lang-key]").forEach(e=>{const a=e.dataset.langKey,n=d(a);n&&n!==a&&(e.tagName==="INPUT"&&e.placeholder||e.tagName==="TEXTAREA"&&e.placeholder?e.placeholder=n:(e.tagName,e.textContent=n))})}function ma(){const t=document.getElementById("character-mode").value,e=document.getElementById("dynamic-character-sheet-area"),a=document.getElementById("interaction-description-container");e.innerHTML="";let n=1;(t==="couple"||t==="group")&&(n=2);for(let r=0;r<n;r++)e.appendChild(gt(r));if(a.classList.toggle("hidden",t==="single"),t==="group"){const r=document.createElement("button");r.id="add-character-btn",r.textContent=d("add_character_button")||"+ Add Another Character",r.type="button",r.className="btn-secondary text-sm font-semibold px-3 py-1.5 rounded-md w-full mt-4",e.appendChild(r)}const s=document.getElementById("save-character-button-template").content.cloneNode(!0);e.appendChild(s);const i=e.querySelector('[data-lang-key="save_character_button"]');if(i){const r=d("save_character_button");r&&r!=="save_character_button"&&(i.textContent=r)}st()}function st(){const t=document.getElementById("product-category").value,e=document.querySelectorAll(".character-sheet-instance"),a=t==="fashion";e.forEach(n=>{const o=n.querySelector(".dynamic-field-section");o&&o.classList.toggle("hidden",a)})}function ht(t){const e=t==="light";document.body.classList.toggle("light-mode",e),document.body.classList.toggle("dark-mode",!e),document.documentElement.setAttribute("data-theme",e?"light":"dark");try{const a=n=>{if(!n)return;const o=n.getAttribute("data-logo-dark"),s=n.getAttribute("data-logo-light"),i=e?s||o:o||s;i&&(n.onerror=()=>{const r=e?o:s;r&&n.src!==r&&(n.src=r)},n.src!==i&&(n.src=i))};a(document.getElementById("app-logo-icon")),a(document.getElementById("login-logo-full"))}catch{}try{localStorage.setItem("direktiva_theme",e?"light":"dark"),localStorage.setItem("direktiva_settings_last_modified",new Date().toISOString())}catch{}ea.current=e?"light":"dark",mn(e?"light":"dark")}function Ht(t){const e=t||(ea.current==="light"?"dark":"light");if(ht(e),typeof v=="function"){const a=e==="dark"?"dark_mode_active":"light_mode_active",n=d(a);let o=n;(!n||n===a)&&((q&&q.current||"id")==="en"?o=a==="light_mode_active"?"Light Mode Active":"Dark Mode Active":o=a==="light_mode_active"?"Mode Terang Aktif":"Mode Gelap Aktif"),v(o)}}function mn(t){const e=document.getElementById("theme-icon-sun"),a=document.getElementById("theme-icon-moon");e&&a&&(e.classList.toggle("hidden",t==="dark"),a.classList.toggle("hidden",t==="light"));const n=document.getElementById("mobile-theme-icon-sun"),o=document.getElementById("mobile-theme-icon-moon");n&&o&&(n.classList.toggle("hidden",t==="dark"),o.classList.toggle("hidden",t==="light"));const s=document.getElementById("mobile-theme-text");if(s){const i=t==="dark"?"theme_dark":"theme_light",r=t==="dark"?"Dark":"Light",c=d(i);s.textContent=c&&c!==i?c:r}}async function pa(t){document.documentElement.lang=t,localStorage.setItem("direktiva_language",t),localStorage.setItem("direktiva_settings_last_modified",new Date().toISOString()),q.current=t,ga(),await pn(),await Po(t)}async function Po(t){const{DEFAULT_SYSTEM_PROMPT:e,ENGLISH_SYSTEM_PROMPT:a}=await $(async()=>{const{DEFAULT_SYSTEM_PROMPT:s,ENGLISH_SYSTEM_PROMPT:i}=await Promise.resolve().then(()=>Bo);return{DEFAULT_SYSTEM_PROMPT:s,ENGLISH_SYSTEM_PROMPT:i}},void 0);localStorage.getItem("direktiva_system_prompt");const n=t==="en"?a:e;localStorage.setItem("direktiva_system_prompt",n),localStorage.setItem("direktiva_settings_last_modified",new Date().toISOString());const o=document.getElementById("system-prompt");o&&(o.value=n),console.log(`System prompt updated for language: ${t}`)}async function De(t){await pa(t),document.getElementById("character-mode")&&ma()}function ga(){m.langIdBtn.classList.remove("bg-blue-600","text-white"),m.langIdBtn.classList.add("text-gray-400","hover:bg-gray-700"),m.langEnBtn.classList.remove("bg-blue-600","text-white"),m.langEnBtn.classList.add("text-gray-400","hover:bg-gray-700"),localStorage.getItem("direktiva_language")==="id"?(m.langIdBtn.classList.add("bg-blue-600","text-white"),m.langIdBtn.classList.remove("text-gray-400","hover:bg-gray-700")):(m.langEnBtn.classList.add("bg-blue-600","text-white"),m.langEnBtn.classList.remove("text-gray-400","hover:bg-gray-700"));const t=document.getElementById("mobile-lang-id"),e=document.getElementById("mobile-lang-en");t&&e&&(t.classList.remove("bg-blue-600","text-white"),t.classList.add("text-gray-400","hover:bg-gray-700"),e.classList.remove("bg-blue-600","text-white"),e.classList.add("text-gray-400","hover:bg-gray-700"),localStorage.getItem("direktiva_language")==="id"?(t.classList.add("bg-blue-600","text-white"),t.classList.remove("text-gray-400","hover:bg-gray-700")):(e.classList.add("bg-blue-600","text-white"),e.classList.remove("text-gray-400","hover:bg-gray-700")))}typeof window<"u"&&(window.updateLanguageButtons=ga);function Ke(){if(localStorage.getItem("direktiva_user_api_key")){const e="api_status_user",a=d(e);m.apiStatus.textContent=a&&a!==e?a:localStorage.getItem("direktiva_language")==="en"?"Using your API Key":"Menggunakan API Key Anda",m.apiStatus.className="text-xs font-semibold text-green-400"}else{const e="api_status_default",a=d(e);m.apiStatus.textContent=a&&a!==e?a:localStorage.getItem("direktiva_language")==="en"?"Using default API (limited)":"Menggunakan API default (terbatas)",m.apiStatus.className="text-xs font-semibold text-yellow-400"}}async function pn(){document.querySelectorAll("[data-lang-key]").forEach(e=>{const a=e.dataset.langKey,n=d(a);n&&n!==a&&(e.tagName==="INPUT"&&e.placeholder||e.tagName==="TEXTAREA"&&e.placeholder?e.placeholder=n:(e.tagName,e.textContent=n))}),document.querySelectorAll("[data-lang-key-placeholder]").forEach(e=>{const a=e.dataset.langKeyPlaceholder,n=d(a);n&&n!==a&&(e.placeholder=n)}),document.querySelectorAll("[data-lang-key-title]").forEach(e=>{const a=e.dataset.langKeyTitle,n=d(a);n&&n!==a&&(e.title=n)});const t=document.querySelector('[data-lang-key="gemini_api_key_helper"]');t&&(t.innerHTML=`${d("gemini_api_key_helper")} <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Google AI Studio</a>.`),Ke(),un(),ua(),await mt()}function ha(t){new Swiper(t,{loop:!1,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}function gn(t){const a=document.getElementById("micro-shot-template").content.cloneNode(!0).firstElementChild;a.querySelector(".visual-idea-text").textContent=t.visual_idea,a.querySelector(".prompt-t2i-display").textContent=t.text_to_image_prompt,a.querySelector(".prompt-i2v-display").textContent=t.image_to_video_prompt;const n=a.querySelectorAll(".prompt-copy-btn");return n[0].dataset.prompt=t.text_to_image_prompt,n[1].dataset.prompt=t.image_to_video_prompt,a.querySelector('[data-lang-key="visual_idea_label"]').textContent=d("visual_idea_label"),a.querySelector('[data-lang-key="t2i_prompt_label"]').textContent=d("t2i_prompt_label"),a.querySelector('[data-lang-key="i2v_prompt_label"]').textContent=d("i2v_prompt_label"),a.outerHTML}function at(t,e,a=null){const n=e.shots.map(s=>gn(s)).join('<div class="my-2"></div>');let o="";if(a&&a.length>0){const s=a.map((i,r)=>`<div class="variant-item p-2 bg-gray-800/50 rounded border border-gray-600/30 hover:border-gray-500/50 transition-colors cursor-pointer" data-variant-index="${r}">
                <div class="flex justify-between items-start">
                    <p class="text-xs text-gray-300 flex-1">${i}</p>
                    <div class="ml-2 flex items-center space-x-1">
                        <span class="text-xs text-yellow-400 font-medium"> ${(Math.random()*2+8).toFixed(1)}</span>
                        <button class="text-xs px-2 py-1 bg-blue-600/80 hover:bg-blue-600 rounded text-white transition-colors" onclick="useVariant('${t.key}', ${r})">
                            ${d("use_button")||"Gunakan"}
                        </button>
                    </div>
                </div>
            </div>`).join("");o=`
            <div class="mt-3 border-t border-gray-600/30 pt-3">
                <div class="flex items-center justify-between mb-2">
                    <h6 class="text-xs font-semibold ${t.textColor} tracking-wider">A/B VARIANTS</h6>
                    <span class="text-xs text-gray-400">${a.length} ${d("variants_label")||"variasi"}</span>
                </div>
                <div class="space-y-2">
                    ${s}
                </div>
            </div>`}return`<div class="p-3 rounded-md ${t.bgColor} ${t.borderColor}" data-part="${t.key}">
        <h5 class="text-xs font-bold ${t.textColor} mb-2 tracking-wider">${t.title}</h5>
        <p class="text-sm ${t.bodyColor} mb-3">${e.text}</p>
        <div class="shots-container space-y-2">${n}</div>
        ${o}
    </div>`}function hn(t){var a;if(!t||!((a=t.selling_points)!=null&&a.length))return"";let e=t.selling_points.map(n=>`<li><span class="text-green-400 mr-2">&#10003;</span>${n}</li>`).join("");return`<div class="p-4 rounded-md bg-gray-800/50 border border-gray-700/50"><h5 class="text-sm font-bold text-gray-300 mb-3">${d("selling_points_title")}</h5><div class="text-xs text-gray-400"><ul>${e}</ul></div></div>`}function yn(t){return t?`<div class="p-4 rounded-md bg-blue-900/40 border border-blue-800/70 space-y-3">
        <h5 class="text-sm font-bold text-blue-300">${d("image_data_sheet_title")}</h5>
        <div class="editable-input bg-gray-900/50 p-2 h-24 overflow-y-auto">${t}</div>
    </div>`:""}function ya(t,e){const n=document.getElementById("carousel-slide-template").content.cloneNode(!0).firstElementChild;n.querySelector(".slide-title").textContent=`${d("slide_label")} ${e+1}`,n.querySelector(".slide-text").textContent=t.slide_text,n.querySelector(".prompt-t2i-display").textContent=t.text_to_image_prompt,n.querySelector(".prompt-copy-btn").dataset.prompt=t.text_to_image_prompt;const o=n.querySelector(".suggestions-container"),s=n.querySelector(".layout-suggestion-p"),i=n.querySelector(".engagement-idea-p");let r=!1;return t.layout_suggestion&&(s.querySelector(".layout-suggestion-text").textContent=t.layout_suggestion,s.style.display="block",r=!0),t.engagement_idea&&(i.querySelector(".engagement-idea-text").textContent=t.engagement_idea,i.style.display="block",r=!0),r&&(o.style.display="block"),n.querySelector('[data-lang-key="t2i_prompt_label"]').textContent=d("t2i_prompt_label"),n.querySelector('[data-lang-key="slide_layout_suggestion"]').textContent=d("slide_layout_suggestion"),n.querySelector('[data-lang-key="slide_engagement_idea"]').textContent=d("slide_engagement_idea"),n.outerHTML}function fa(t){return`
    <div class="mt-4 space-y-4">
        <button class="generate-assets-btn w-full btn-secondary text-sm font-semibold py-2 rounded-md">${d("generate_assets_button")||"Generate Additional Assets (Titles, Hashtags, etc.)"}</button>
        <div class="additional-assets-container hidden bg-gray-900/50 p-4 rounded-lg border border-gray-700/50">
             <div class="asset-loader text-center py-4"><div class="icon icon-md icon-spinner text-blue-400 mx-auto"></div></div>
             <div class="asset-content hidden"></div>
        </div>
    </div>`}function _a(t,e){const a=t.querySelector(".card-content");if(e.character_sheet&&!e.original_character_descriptions){const o=new Set,s=/<char-desc>(.*?)<\/char-desc>/gi;["hook","body","cta"].forEach(i=>{e[i]&&e[i].shots&&e[i].shots.forEach(r=>{const c=(r.text_to_image_prompt||"")+" "+(r.image_to_video_prompt||"");let l;for(;(l=s.exec(c))!==null;)o.add(l[1].trim())})}),e.original_character_descriptions=Array.from(o)}t.dataset.script=JSON.stringify(e);let n=hn(e.review_insights);if(e.hook&&e.body&&e.cta){n+=yn(e.visual_dna);const o={hook:{key:"hook",title:d("hook_title"),bgColor:"bg-sky-900/50",borderColor:"border-sky-800/70",textColor:"text-sky-300",bodyColor:"text-sky-100"},body:{key:"body",title:d("body_title"),bgColor:"bg-indigo-900/50",borderColor:"border-indigo-800/70",textColor:"text-indigo-300",bodyColor:"text-indigo-100"},cta:{key:"cta",title:d("cta_title"),bgColor:"bg-purple-900/50",borderColor:"border-purple-800/70",textColor:"text-purple-300",bodyColor:"text-purple-100"}};n+=at(o.hook,e.hook,e.hook_variants)+at(o.body,e.body,e.body_variants)+at(o.cta,e.cta,e.cta_variants),n+=fa()}else if(e.slides){const o=e.slides.map((s,i)=>ya(s,i)).join("");n+=`
            <div class="swiper carousel-swiper-container bg-gray-900/50 p-4 rounded-lg relative">
                <div class="swiper-wrapper">${o}</div>
                <div class="swiper-pagination !bottom-2"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
            </div>
        `}a.innerHTML=n;try{if(e.additional_assets_html){const o=a.querySelector(".additional-assets-container"),s=a.querySelector(".asset-loader"),i=a.querySelector(".asset-content");o==null||o.classList.remove("hidden"),s==null||s.classList.add("hidden"),i&&(i.classList.remove("hidden"),i.innerHTML=e.additional_assets_html)}}catch{}}const Ra=Object.freeze(Object.defineProperty({__proto__:null,applyLanguage:pa,applyTheme:ht,createAssetsHTML:fa,createCarouselSlideHTML:ya,createEditableVisualSheetHTML:yn,createMicroShotHTML:gn,createReviewInsightHTML:hn,createScriptPartHTML:at,initSwiper:ha,switchLanguage:De,switchTheme:Ht,translateUI:pn,updateApiStatus:Ke,updateCardContent:_a,updateLanguageButtons:ga,updateThemeToggleIcon:mn},Symbol.toStringTag,{value:"Module"})),va=`You are 'Direktiva Studio AI', a world-class Video Ad Scriptwriter, Virtual Director, Content Strategist and a Cinematic Prompt Artist. Your mission is to transform product descriptions into dynamic, engaging, and production-ready short video storyboards.

**YOUR CORE PHILOSOPHY:**
Every script section (Hook, Body, CTA) must tell a **mini-story** through visuals. Don't just show the product, but demonstrate **action, emotion, and transformation**. Each 'shot' should be a different scene that builds the story.

**EXECUTION RULES & OUTPUT:**
1. **Research & Analysis:** Extract 'Selling Points' from product description as the story foundation.
2. **Visual Story Flow (VERY IMPORTANT):**
   * For each section (Hook, Body, CTA), create a sequence of scenes (\`shots\`) with beginning, middle, and end.
   * **Shot 1 (Opening):** Set the scene or show the problem.
   * **Shot 2 (Core):** Focus on product in action, show solution or main features.
   * **Shot 3 (Peak/Transition):** Show results, positive emotions, or transition to next section.
   * Ensure \`visual_idea\` for each shot is truly different and builds the narrative.
3. **Character & Consistency (STRICTEST RULE):**
   * If given **CHARACTER SHEET(S)** from user, these are your main actors. You MUST use all relevant details in every \`prompt\` T2I to maintain absolute consistency.
   * When creating \`prompt\` T2I, you **MAY ONLY** place character physical descriptions inside \`<char-desc>\` tags. **NEVER** write character physical descriptions (like age, race, or appearance) outside these tags.
   * If given **INTERACTION DESCRIPTION**, use it as main reference for multi-character scenes.
   * **If Visual Strategy is 'Standard' or 'Faceless' and NO Character Sheet given:** You are STRICTLY FORBIDDEN from creating or defining specific characters. Create generic prompts (example: 'a woman's hand', 'a person from behind').
4. **Technical Prompt Details:**
   * **\`visual_idea\`**: MUST be in English. Describe scenes, actions, and emotions cinematically.
   * **\`text_to_image_prompt\` (T2I)**: MUST be in English. Must be very detailed. Combine the following information:
        * **PROMPT TRANSLATION RULE (CRITICAL):** Your most important task is to translate the simple \`visual_idea\` into a hyper-detailed and ACCURATE \`text_to_image_prompt\`. The prompt MUST perfectly match the idea's subject, action, and framing (close-up, full body, etc.). The first few words of the prompt are the most important; they MUST define the main subject and camera shot type.
		* **PRODUCT VISUAL KEYWORDS:** If provided, include these keywords as the main basis for object description.
		* **MAIN COLOR PALETTE:** If provided, you MUST use these HEX color codes in the prompt to ensure color accuracy.
		* **CHARACTER SHEET:** Integrate character descriptions (only inside \`<char-desc>\` tags).
        * **INTERACTION DETAIL RULE:** For every shot where a character interacts with the product, the \`text_to_image_prompt\` (T2I) prompt must describe both the character's physical action and their subtle emotional reaction. Describe HOW they hold it and WHY they are making that expression. Use phrases like 'her fingers gently grip the bottle as she looks at it with a curious smile' instead of just 'woman holding product'.
		* **CINEMATIC DETAILS:** Add specific action descriptions, environment, lighting style (e.g., soft cinematic lighting), camera angles (e.g., low angle shot), and visual style (photorealistic, 8k, detailed).
	* **\`image_to_video_prompt\` (I2V)**: MUST be in English. Focus ONLY on movement: describe camera movement (e.g., slow zoom in) AND subject movement (e.g., character smiling and turning head slowly). DO NOT include character physical descriptions here.
5. **Negative Prompt:** For each \`shot\`, fill the \`negative_prompt\` property with descriptions of things to avoid for high-quality image generation, such as 'low quality, blurry, watermark, text, signature, deformed'.
6. **VERY STRICT LANGUAGE RULES:**
    * **ALL SCRIPT TEXT OUTPUT MUST BE IN ENGLISH: This includes hook.text, body.text, cta.text, hook_variants, body_variants, cta_variants, body_intro, and selling_points.
    * **NEVER use Indonesian for script content, narration, or any text that will be read by the user.**
    * **CONSISTENT: Ensure all hook, body, and CTA variations use natural English that is appropriate for the target audience.**
7. **Language & Format:** Reply ONLY in the requested JSON format. Script narrative in English.
8.  **PLATFORM-SPECIFIC NOTES** [[PLATFORM_NOTES]]
9.  **STRUCTURED PLAN (JSON)** [[PLATFORM_PLAN_JSON]]

Analyze the user request below and generate your best cinematic storyboard.`,ba=`Anda adalah 'Direktiva Studio AI', seorang Penulis Naskah Iklan Video kelas dunia, seorang Sutradara Virtual, Ahli Strategi Konten,  dan seorang Seniman Prompt Sinematik. Misi Anda adalah mengubah deskripsi produk menjadi sebuah storyboard video pendek yang dinamis, menarik, dan siap produksi.

**FILOSOFI UTAMA ANDA:**
Setiap bagian skrip (Hook, Body, CTA) harus menceritakan sebuah **mini-story** melalui visual. Jangan hanya menampilkan produk, tapi tunjukkan **aksi, emosi, dan transformasi**. Setiap 'shot' harus merupakan adegan yang berbeda dan membangun cerita.

**ATURAN PELAKSANAAN & OUTPUT:**
1.  **Riset & Analisis:** Ekstrak 'Selling Points' dari deskripsi produk sebagai fondasi cerita.
2.  **Alur Cerita Visual (SANGAT PENTING):**
    * Untuk setiap bagian (Hook, Body, CTA), buatlah urutan adegan (\`shots\`) yang memiliki awal, tengah, dan akhir.
    * **Shot 1 (Pembuka):** Atur adegan atau tunjukkan masalah.
    * **Shot 2 (Inti):** Fokus pada produk dalam aksi, tunjukkan solusi atau fitur utama.
    * **Shot 3 (Puncak/Transisi):** Tunjukkan hasil, emosi positif, atau transisi ke bagian selanjutnya.
    * Pastikan \`visual_idea\` untuk setiap shot benar-benar berbeda dan membangun narasi.
3.  **Karakter & Konsistensi (ATURAN PALING KETAT):**
    * Jika diberi **CHARACTER SHEET(S)** dari pengguna, ini adalah aktor utama Anda. Anda WAJIB menggunakan semua detail relevan di setiap \`prompt\` T2I untuk menjaga konsistensi absolut.
    * Saat membuat \`prompt\` T2I, Anda **HANYA BOLEH** menempatkan deskripsi fisik karakter di dalam tag \`<char-desc>\`. **JANGAN PERNAH** menulis deskripsi fisik karakter (seperti usia, ras, atau penampilan) di luar tag ini.
    * Jika diberi **DESKRIPSI INTERAKSI**, jadikan itu sebagai acuan utama untuk adegan multi-karakter.
    * **Jika Strategi Visual adalah 'Standar' atau 'Faceless' dan TIDAK diberi Character Sheet:** Anda DILARANG KERAS membuat atau mendefinisikan karakter spesifik. Buatlah prompt yang umum (contoh: "a woman's hand", "a person from behind").
4.  **Detail Teknis Prompt:**
    * **\`visual_idea\`**: WAJIB mengikuti bahasa aplikasi saat ini. Jika mode bahasa adalah Indonesia, tulis dalam Bahasa Indonesia; jika Inggris, tulis dalam Bahasa Inggris. Deskripsikan adegan, aksi, dan emosi secara sinematik.
    * **\`text_to_image_prompt\` (T2I)**: WAJIB dalam Bahasa Inggris. Harus sangat detail. Gabungkan informasi berikut:
        * **ATURAN PENERJEMAHAN PROMPT (KRITIS):** Tugas terpenting Anda adalah menerjemahkan \`visual_idea\` yang sederhana menjadi \`text_to_image_prompt\` yang sangat detail dan AKURAT. Prompt WAJIB cocok secara sempurna dengan subjek, aksi, dan framing (close-up, full body, dll.) dari ide tersebut. Beberapa kata pertama dari prompt adalah yang paling penting; WAJIB mendefinisikan subjek utama dan jenis shot kamera.
        * **VISUAL KEYWORDS PRODUK:** Jika diberikan, masukkan kata kunci ini sebagai dasar utama deskripsi objek.
        * **PALET WARNA UTAMA:** Jika diberikan, Anda WAJIB menggunakan kode warna HEX ini di dalam prompt untuk memastikan akurasi warna.
        * **CHARACTER SHEET:** Integrasikan deskripsi karakter (hanya di dalam tag \`<char-desc>\`).
        * **ATURAN DETAIL INTERAKSI:** Untuk setiap shot di mana karakter berinteraksi dengan produk, prompt \`text_to_image_prompt\` (T2I) harus mendeskripsikan aksi fisik karakter DAN reaksi emosional mereka yang halus. Deskripsikan BAGAIMANA cara mereka memegangnya dan MENGAPA mereka membuat ekspresi tersebut. Gunakan frasa seperti 'jemarinya menggenggam botol dengan lembut saat ia menatapnya dengan senyum penasaran' daripada hanya 'wanita memegang produk'.
        * **DETAIL SINEMATIK:** Tambahkan deskripsi aksi spesifik, lingkungan, gaya pencahayaan (e.g., *soft cinematic lighting*), sudut kamera (e.g., *low angle shot*), dan gaya visual (*photorealistic, 8k, detailed*).
    * **\`image_to_video_prompt\` (I2V)**: WAJIB dalam Bahasa Inggris. Fokus HANYA pada gerakan: deskripsikan gerakan kamera (e.g., *slow zoom in*) DAN gerakan subjek (e.g., *character smiling and turning head slowly*). JANGAN sertakan deskripsi fisik karakter di sini.
5.  **Negative Prompt:** Untuk setiap \`shot\`, isi properti \`negative_prompt\` dengan deskripsi hal-hal yang harus dihindari untuk menghasilkan gambar berkualitas tinggi, seperti 'low quality, blurry, watermark, text, signature, deformed'. 
6.  **ATURAN BAHASA YANG SANGAT KETAT:**
    * **SEMUA OUTPUT TEKS SKRIP WAJIB DALAM BAHASA INDONESIA:** Ini termasuk hook.text, body.text, cta.text, hook_variants, body_variants, cta_variants, body_intro, dan selling_points.
    * **HANYA text_to_image_prompt dan image_to_video_prompt yang boleh dalam Bahasa Inggris.**
    * **JANGAN PERNAH** menggunakan bahasa Inggris untuk konten skrip, narasi, atau teks yang akan dibaca pengguna.
    * **KONSISTEN:** Pastikan semua variasi hook, body, dan CTA menggunakan bahasa Indonesia yang natural dan sesuai target audiens.
7.  **Bahasa & Format:** Balas HANYA dalam format JSON yang diminta. Narasi skrip dalam Bahasa Indonesia.
8.  **PLATFORM-SPECIFIC NOTES** [[PLATFORM_NOTES]]
9.  **STRUCTURED PLAN (JSON)** [[PLATFORM_PLAN_JSON]]

Analisis permintaan pengguna di bawah ini dan hasilkan storyboard sinematik terbaikmu.`;function fn(){const t=m.apiKeyModal.input.value.trim();t?(localStorage.setItem("direktiva_user_api_key",t),localStorage.setItem("direktiva_settings_last_modified",new Date().toISOString()),m.customApiKeySettingsInput.value=t,m.apiKeyModal.el.classList.add("hidden"),v(d("notification_api_key_saved")),Ke()):v(d("notification_api_key_empty"),"error")}async function _n(){const t=localStorage.getItem("direktiva_user_api_key")||"",a=(localStorage.getItem("direktiva_language")||"id")==="en"?va:ba;localStorage.setItem("direktiva_system_prompt",a),m.customApiKeySettingsInput.value=t,m.systemPromptTextarea.value=a,ht(localStorage.getItem("direktiva_theme")||"dark"),Ke()}function vn(){localStorage.setItem("direktiva_user_api_key",m.customApiKeySettingsInput.value),localStorage.setItem("direktiva_system_prompt",m.systemPromptTextarea.value),localStorage.setItem("direktiva_settings_last_modified",new Date().toISOString()),v(d("notification_settings_saved")),Ke()}window.APP_SETTINGS=window.APP_SETTINGS||{};window.APP_SETTINGS.PROMPT_PIPELINE={ENABLED:!0,DEFAULT_T2I_MODEL:"imagen"};const Bo=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_SYSTEM_PROMPT:ba,ENGLISH_SYSTEM_PROMPT:va,loadSettings:_n,saveApiKeyFromModal:fn,saveSettings:vn},Symbol.toStringTag,{value:"Module"})),ce={NOT_STARTED:"not_started",IN_PROGRESS:"in_progress",COMPLETED:"completed",FAILED:"failed"},le={STATUS:"aethera_migration_status",COMPLETED_AT:"aethera_migration_completed_at",VERSION:"aethera_migration_version"};class No{constructor(){this.migrationVersion="1.0",this.migrationStatus=this.getMigrationStatus()}getMigrationStatus(){return localStorage.getItem(le.STATUS)||ce.NOT_STARTED}setMigrationStatus(e){this.migrationStatus=e,localStorage.setItem(le.STATUS,e),e===ce.COMPLETED&&(localStorage.setItem(le.COMPLETED_AT,new Date().toISOString()),localStorage.setItem(le.VERSION,this.migrationVersion))}needsMigration(){const e=this.getMigrationStatus(),a=localStorage.getItem(le.VERSION);return e!==ce.COMPLETED||a!==this.migrationVersion}hasDataToMigrate(){return["aethera_personas","aethera_history","aethera_settings_presets","aethera_character_presets","aethera_system_prompt"].some(a=>{const n=localStorage.getItem(a);if(!n)return!1;try{const o=JSON.parse(n);return Array.isArray(o)?o.length>0:Object.keys(o).length>0}catch{return n.length>0}})}async startMigration(){if(!this.needsMigration())return console.log("Migration not needed"),{success:!0,message:"Migration not needed"};const{data:{session:e}}=await x.auth.getSession();if(!e)return console.log("User not logged in, skipping migration"),{success:!1,message:"User not logged in"};if(!this.hasDataToMigrate())return console.log("No data to migrate"),this.setMigrationStatus(ce.COMPLETED),{success:!0,message:"No data to migrate"};this.setMigrationStatus(ce.IN_PROGRESS);try{return console.log("Starting cloud migration..."),await this.migrateSettings(),await this.migratePersonas(),await this.migratePresets(),await this.migrateHistory(),this.setMigrationStatus(ce.COMPLETED),v(d("notification_migration_success")||"Data successfully migrated to cloud!","success"),console.log("Cloud migration completed successfully"),{success:!0,message:"Migration completed successfully"}}catch(a){return console.error("Migration failed:",a),this.setMigrationStatus(ce.FAILED),v(d("notification_migration_failed")||"Failed to migrate data to cloud. Your local data is safe.","error"),{success:!1,message:a.message}}}async migrateSettings(){console.log("Migrating settings...");const{data:{user:e}}=await x.auth.getUser();if(!e)throw new Error("User not authenticated");const a={theme:localStorage.getItem("aethera_theme")||"dark",language:localStorage.getItem("aethera_language")||"id",system_prompt:localStorage.getItem("aethera_system_prompt")},{data:n,error:o}=await x.from("user_settings").select("*").single();if(o&&o.code!=="PGRST116")throw o;if(n)console.log("Settings already exist in cloud, skipping");else{const{error:s}=await x.from("user_settings").insert([{user_id:e.id,theme:a.theme,language:a.language,system_prompt:a.system_prompt}]);if(s)throw s;console.log("Settings migrated successfully")}}async migratePersonas(){console.log("Migrating personas...");const{data:{user:e}}=await x.auth.getUser();if(!e)throw new Error("User not authenticated");const a=JSON.parse(localStorage.getItem("aethera_personas")||"[]");if(a.length===0){console.log("No personas to migrate");return}const{data:n,error:o}=await x.from("user_personas").select("*");if(o)throw o;const s=new Set((n||[]).map(c=>c.name)),i=a.filter(c=>!s.has(c.name));if(i.length===0){console.log("All personas already exist in cloud");return}const{error:r}=await x.from("user_personas").insert(i.map(c=>({user_id:e.id,name:c.name,description:c.description,avatar:c.avatar,personality:c.personality||{}})));if(r)throw r;console.log(`${i.length} personas migrated successfully`)}async migratePresets(){console.log("Migrating presets...");const e=JSON.parse(localStorage.getItem("aethera_settings_presets")||"[]"),a={};e.forEach(o=>{a[o.name]=o.settings});const n=JSON.parse(localStorage.getItem("aethera_character_presets")||"[]");Object.keys(a).length>0&&await this.migrateGeneratorPresets(a),n.length>0&&await this.migrateCharacterPresets(n)}async migrateGeneratorPresets(e){const{data:{user:a}}=await x.auth.getUser();if(!a)throw new Error("User not authenticated");const{data:n,error:o}=await x.from("user_presets").select("*").eq("type","generator");if(o)throw o;const s=new Set((n||[]).map(c=>c.name)),i=[];if(Object.entries(e).forEach(([c,l])=>{s.has(c)||i.push({user_id:a.id,name:c,type:"generator",settings:l})}),i.length===0){console.log("All generator presets already exist in cloud");return}const{error:r}=await x.from("user_presets").insert(i);if(r)throw r;console.log(`${i.length} generator presets migrated successfully`)}async migrateCharacterPresets(e){const{data:{user:a}}=await x.auth.getUser();if(!a)throw new Error("User not authenticated");const{data:n,error:o}=await x.from("user_presets").select("*").eq("type","character");if(o)throw o;const s=new Set((n||[]).map(c=>c.name)),i=e.filter(c=>!s.has(c.name)).map(c=>({user_id:a.id,name:c.name,type:"character",settings:c}));if(i.length===0){console.log("All character presets already exist in cloud");return}const{error:r}=await x.from("user_presets").insert(i);if(r)throw r;console.log(`${i.length} character presets migrated successfully`)}async migrateHistory(){try{console.log("Migrating history...");const{data:{user:e}}=await x.auth.getUser();if(!e)throw new Error("User not authenticated");const a=JSON.parse(localStorage.getItem("aethera_history")||"[]");if(a.length===0){console.log("No history to migrate");return}const{data:n,error:o}=await x.from("user_history").select("product_name, created_at").order("created_at",{ascending:!1}).limit(100);if(o)throw o;const s=new Set;(n||[]).forEach(c=>{try{const l=c.created_at?new Date(c.created_at):new Date,u=`${c.product_name}_${l.toDateString()}`;s.add(u)}catch{console.warn("Invalid created_at date in cloud history:",c.created_at)}});const i=a.filter(c=>{const l=c.timestamp||Date.now(),u=isNaN(l)?Date.now():l,p=`${c.productName||c.product_name||"Untitled Script"}_${new Date(u).toDateString()}`;return!s.has(p)}).slice(0,50).map(c=>{const l=c.timestamp||Date.now(),u=isNaN(l)?Date.now():l,y=c.productName||c.product_name||"Untitled Script";return{user_id:e.id,product_name:y,scripts:c.scripts||[],post_type:c.postType||c.post_type||"single",image_url:c.imageUrl||c.image_url||null,created_at:new Date(u).toISOString()}});if(i.length===0){console.log("All history entries already exist in cloud");return}const r=10;for(let c=0;c<i.length;c+=r){const l=i.slice(c,c+r),{error:u}=await x.from("user_history").insert(l);if(u)throw u}console.log(`${i.length} history entries migrated successfully`)}catch(e){console.warn("Failed to migrate history, continuing with other data:",e.message)}}async showMigrationPrompt(){if(!this.needsMigration()||!this.hasDataToMigrate())return;await new Promise(o=>setTimeout(o,500));const e=document.createElement("div");e.className="modal migration-modal",e.innerHTML=`
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${d("migration_title")||"Migrate Your Data to Cloud"}</h3>
                </div>
                <div class="modal-body">
                    <p>${d("migration_description")||"We found existing data on your device. Would you like to migrate it to the cloud for backup and sync across devices?"}</p>
                    <ul>
                        <li>${d("migration_benefit_1")||"Automatic backup of your data"}</li>
                        <li>${d("migration_benefit_2")||"Sync across multiple devices"}</li>
                        <li>${d("migration_benefit_3")||"Never lose your presets and history"}</li>
                    </ul>
                    <p class="migration-note">
                        <strong>${d("migration_note")||"Note:"}</strong> 
                        ${d("migration_note_text")||"Your local data will remain safe. This process only copies data to the cloud."}
                    </p>
                </div>
                <div class="modal-footer">
                    <button id="migration-later-btn" class="btn btn-secondary">
                        ${d("migration_later")||"Maybe Later"}
                    </button>
                    <button id="migration-start-btn" class="btn btn-primary">
                        ${d("migration_start")||"Start Migration"}
                    </button>
                </div>
            </div>
        `,document.body.appendChild(e);const a=e.querySelector("#migration-later-btn"),n=e.querySelector("#migration-start-btn");a.addEventListener("click",()=>{document.body.removeChild(e)}),n.addEventListener("click",async()=>{n.disabled=!0,n.textContent=d("migration_in_progress")||"Migrating...",(await this.startMigration()).success?document.body.removeChild(e):(n.disabled=!1,n.textContent=d("migration_start")||"Start Migration")}),setTimeout(()=>e.classList.add("show"),100)}resetMigration(){localStorage.removeItem(le.STATUS),localStorage.removeItem(le.COMPLETED_AT),localStorage.removeItem(le.VERSION),this.migrationStatus=ce.NOT_STARTED}}const $o=new No;async function Oo(){setTimeout(async()=>{await $o.showMigrationPrompt()},2e3)}const bn="aethera_settings_presets",Be=["writing-style","tone-vibe","persona-selector","target-audience","hook-type","cta-type"];function ae(){return JSON.parse(localStorage.getItem(bn))||[]}function yt(t){localStorage.setItem(bn,JSON.stringify(t)),localStorage.setItem("aethera_presets_last_modified",new Date().toISOString())}function ue(){const t=ae(),e=m.settingsPresetSelector,a=e.value;e.innerHTML='<option value="" data-lang-key="load_preset_option">-- Load Preset --</option>',t.forEach(n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,e.appendChild(o)}),e.value=a}function Sn(){ut(d("save_preset_title")||"Simpan Preset",d("enter_preset_name")||"Masukkan nama untuk preset ini:",d("preset_name_placeholder")||"Nama preset...",async t=>{if(!t||!t.trim()){v(d("preset_name_empty")||"Nama preset tidak boleh kosong.","warning");return}await kn(t.trim())})}async function kn(t){if(ae().some(i=>i.name.toLowerCase()===t.toLowerCase())){v(d("preset_name_duplicate",{name:t})||`Nama preset "${t}" sudah digunakan. Silakan pilih nama lain.`,"warning");return}try{const{getCharacterPresets:i}=await $(async()=>{const{getCharacterPresets:l}=await Promise.resolve().then(()=>Jo);return{getCharacterPresets:l}},void 0);if(i().some(l=>l.name.toLowerCase()===t.toLowerCase())){v(d("preset_name_duplicate",{name:t})||`Nama preset "${t}" sudah digunakan untuk preset karakter. Silakan pilih nama lain.`,"warning");return}}catch(i){console.warn("Could not check character presets for duplicates:",i)}const n={id:`preset_${Date.now()}`,name:t,settings:{}};Be.forEach(i=>{const r=document.getElementById(i);r&&(n.settings[i]=r.value)});const o=ae();o.push(n),yt(o),ue();const s=d("preset_saved_success",{name:n.name})||`Preset "${n.name}" berhasil disimpan!`;v(s,"success")}function wn(){const e=m.settingsPresetSelector.value;if(!e)return;const n=ae().find(o=>o.id===e);if(n){Be.forEach(s=>{const i=document.getElementById(s);i&&n.settings[s]!==void 0&&(i.value=n.settings[s],i.dispatchEvent(new Event("change")))});const o=d("preset_loaded_success",{name:n.name})||`Preset "${n.name}" dimuat.`;v(o,"success")}}function En(){const t={};Be.forEach(e=>{const a=document.getElementById(e);a&&(t[e]=a.value)}),localStorage.setItem("aethera_last_settings",JSON.stringify(t)),localStorage.setItem("aethera_presets_last_modified",new Date().toISOString())}function xn(){const t=JSON.parse(localStorage.getItem("aethera_last_settings"));t&&Be.forEach(e=>{const a=document.getElementById(e);a&&t[e]!==void 0&&(a.value=t[e],a.dispatchEvent(new Event("change")))})}function Sa(){const t=ae(),e=document.getElementById("preset-list-container"),a=document.getElementById("preset-item-template");if(e.innerHTML="",t.length===0){e.innerHTML=`<p class="text-sm text-center text-gray-500 p-4">${d("no_presets_yet")||"Anda belum memiliki preset."}</p>`;return}t.forEach(n=>{const o=a.content.cloneNode(!0),s=o.querySelector(".preset-item");s.dataset.presetId=n.id;const i=o.querySelector(".preset-name-input");i.value=n.name;const r=s.querySelector(".flex"),c=document.createElement("button");c.className="edit-preset-btn p-2 text-gray-400 hover:text-blue-400",c.title=d("edit_button")||"Edit",c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793z"/><path d="M11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/></svg>',r.prepend(c),c.addEventListener("click",()=>Mo(n)),e.appendChild(o)})}function Mo(t){try{rt();const e=document.getElementById("edit-settings-preset-modal"),a=document.getElementById("edit-settings-preset-content");a.innerHTML="",Be.map(s=>{const i=document.getElementById(s),r=document.querySelector(`label[for="${s}"]`),c=document.createElement("div");c.className="space-y-1";const l=document.createElement("div");l.className="text-xs text-gray-400",l.textContent=r&&r.textContent||s;const u=i?i.cloneNode(!0):null;return u&&(u.id=`edit-${s}`,u.classList.add("w-full"),u.value=(t.settings||{})[s]??i.value),c.appendChild(l),u&&c.appendChild(u),c}).forEach(s=>a.appendChild(s)),e.classList.remove("hidden"),e.classList.add("flex");const o=()=>{e.classList.add("hidden"),e.classList.remove("flex")};document.getElementById("edit-settings-preset-close").onclick=o,document.getElementById("edit-settings-preset-cancel").onclick=o,document.getElementById("edit-settings-preset-save").onclick=async()=>{await Ro(t.id),o()},document.getElementById("edit-settings-preset-save-as-new").onclick=async()=>{await kn((t.name||"")+" Copy"),o()}}catch(e){console.warn("openEditPresetOverlay failed",e)}}async function Ro(t){const e=ae(),a=e.findIndex(o=>o.id===t);if(a<0)return;const n={...e[a],settings:{}};Be.forEach(o=>{const s=document.getElementById(`edit-${o}`);s&&(n.settings[o]=s.value)}),e[a]=n,yt(e),ue(),v(d("preset_saved_success",{name:n.name})||"Preset saved","success")}function In(){Sa();const t=document.getElementById("manage-presets-modal");t.classList.remove("opacity-0","pointer-events-none"),t.querySelector(".modal-content").classList.remove("scale-95")}function rt(){const t=document.getElementById("manage-presets-modal");t.classList.add("opacity-0","pointer-events-none"),t.querySelector(".modal-content").classList.add("scale-95")}async function Do(t){let e=ae();const a=e.find(o=>o.id===t);e=e.filter(o=>o.id!==t),yt(e),Sa(),ue();try{const{cloudStorage:o}=await $(async()=>{const{cloudStorage:s}=await Promise.resolve().then(()=>pt);return{cloudStorage:s}},void 0);if(a){const{data:s}=await x.from("user_presets").select("id").eq("name",a.name).eq("type","generator").single();s&&await o.addPendingOperation("presets","delete",{id:s.id,name:a.name,type:"generator"})}}catch(o){console.warn("Failed to sync preset deletion with cloud:",o.message)}const n=d("preset_deleted_success")||"Preset deleted successfully.";v(n,"success")}function qo(t,e){if(!e||!e.trim()){v(d("preset_name_empty")||"Nama preset tidak boleh kosong.","warning");return}const a=e.trim();if(ae().some(r=>r.id!==t&&String(r.name||"").toLowerCase()===a.toLowerCase())){v(d("preset_name_duplicate",{name:a})||`Nama preset "${a}" sudah digunakan. Silakan pilih nama lain.`,"warning");return}let s=ae();const i=s.findIndex(r=>r.id===t);if(i>-1){const r=s[i].name;s[i].name=a,yt(s),Sa(),ue(),v(d("preset_name_updated")||"Nama preset berhasil diperbarui.","success"),(async()=>{try{const{data:{session:c}}=await x.auth.getSession();if(c!=null&&c.user){const l=s[i].settings||{},{data:u}=await x.from("user_presets").select("id, settings").eq("user_id",c.user.id).eq("type","generator").eq("name",r).order("created_at",{ascending:!1}).limit(1).maybeSingle();u!=null&&u.id?await x.from("user_presets").update({name:a,settings:l}).eq("id",u.id):await x.from("user_presets").update({name:a,settings:l}).eq("user_id",c.user.id).eq("type","generator").eq("name",r),localStorage.setItem("aethera_presets_last_modified",new Date().toISOString());try{await U.syncGeneratorPresets()}catch{}}else try{U.addPendingOperation("presets","update",{name:a,type:"generator",previous_name:r,settings:s[i].settings||{}})}catch{}}catch{try{U.addPendingOperation("presets","update",{name:a,type:"generator",previous_name:r,settings:s[i].settings||{}})}catch{}}})()}}function Ln(t){const e=t.target,a=e.closest(".preset-item");if(!a)return;const n=a.dataset.presetId;if(e.closest(".delete-preset-btn")){const o=a.querySelector(".preset-name-input").value,s=d("confirm_delete_preset",{name:o})||`Anda yakin ingin menghapus preset "${o}"?`;ye(s,()=>{Do(n).catch(i=>{console.error("Error deleting preset:",i),v("Gagal menghapus preset","error")})})}if(e.closest(".save-preset-name-btn")){const o=a.querySelector(".preset-name-input").value;qo(n,o)}}const Ho=Object.freeze(Object.defineProperty({__proto__:null,closeManagePresetsModal:rt,getPresets:ae,handleLoadPreset:wn,handlePresetManagement:Ln,handleSavePreset:Sn,loadLastSettings:xn,openManagePresetsModal:In,populatePresetSelector:ue,saveLastSettings:En},Symbol.toStringTag,{value:"Module"})),An="aethera_character_presets",ft=["name","gender","age","ethnicity","face_shape","eye_color","eye_shape","lip_shape","nose_shape","eyebrow_style","hair_style","hair_color","unique_features","makeup_style","skin_tone","body_shape","height","clothing_style","color_palette","specific_outfit","vibe","notes"];function ne(){return JSON.parse(localStorage.getItem(An))||[]}function _t(t){localStorage.setItem(An,JSON.stringify(t)),localStorage.setItem("aethera_character_presets_last_modified",new Date().toISOString())}function me(){try{const t=getAllPresets(),e=document.getElementById("character-quick-picks");if(e){const a=new Set(JSON.parse(localStorage.getItem("aethera_pinned_characters")||"[]")),n=JSON.parse(localStorage.getItem("aethera_character_usage")||"{}"),o=new Map;t.forEach(c=>{c!=null&&c.name&&o.set(c.name,c)});const r=[...Array.from(o.values())].sort((c,l)=>{const u=a.has(String(c.id||c.name||"")),y=a.has(String(l.id||l.name||""));if(u!==y)return u?-1:1;const p=n[c.id||c.name]||0,h=n[l.id||l.name]||0;return p!==h?h-p:String(c.name||"").localeCompare(String(l.name||""))}).slice(0,6);e.innerHTML="",r.forEach(c=>{const l=document.createElement("button");l.className="px-2 py-1 text-xs rounded-full bg-yellow-900/40 border border-yellow-800/70 text-yellow-200 hover:bg-yellow-800/60",l.textContent=c.name||"Preset",l.title=(c.notes||"").slice(0,140),l.addEventListener("click",async()=>{const f=document.getElementById("character-preset-selector");if(f){f.value=c.id||"",await ka();try{U.incrementCharacterPresetUsage(c.id||c.name,c.name)}catch{}}});const u=document.createElement("button");u.className="ml-1 text-yellow-400 text-xs hover:opacity-80";const y=c.id||c.name,p=a.has(String(y));u.textContent=p?"":"",u.addEventListener("click",f=>{f.stopPropagation();const g=!a.has(String(y));g?a.add(String(y)):a.delete(String(y)),localStorage.setItem("aethera_pinned_characters",JSON.stringify([...a]));try{U.toggleCharacterPin(y,g)}catch{}u.textContent=g?"":""});const h=document.createElement("div");h.className="inline-flex items-center",h.appendChild(l),h.appendChild(u),e.appendChild(h)})}}catch{}try{const t=ne(),e=new Map;t.forEach(o=>{o!=null&&o.name&&e.set(o.name,o)});const a=Array.from(e.values()),n=document.getElementById("character-preset-selector");if(!n)return;n.innerHTML='<option value="" data-lang-key="load_character_option">-- Load Character --</option>',a.forEach(o=>{const s=document.createElement("option");s.value=o.id,s.textContent=o.name,n.appendChild(s)})}catch(t){console.warn("Failed to populate character preset selector:",t.message)}}function Tn(){ut("Simpan Preset Karakter","Masukkan nama untuk preset karakter ini:","Contoh: Model Pria Casual, Pasangan Kenji & Luna",async t=>{if(!t||!t.trim()){v(d("character_preset_name_empty")||"Nama preset tidak boleh kosong.","warning");return}await Cn(t.trim())})}async function Cn(t){if(ne().some(r=>r.name.toLowerCase()===t.toLowerCase())){v(d("preset_name_duplicate",{name:t})||`Nama preset "${t}" sudah digunakan. Silakan pilih nama lain.`,"warning");return}try{const{getPresets:r}=await $(async()=>{const{getPresets:u}=await Promise.resolve().then(()=>Ho);return{getPresets:u}},void 0);if(r().some(u=>u.name.toLowerCase()===t.toLowerCase())){v(d("preset_name_duplicate",{name:t})||`Nama preset "${t}" sudah digunakan untuk preset generator. Silakan pilih nama lain.`,"warning");return}}catch(r){console.warn("Could not check generator presets for duplicates:",r)}const n=[];if(document.querySelectorAll(".character-sheet-instance").forEach(r=>{const c={};ft.forEach(l=>{const u=r.querySelector(`[data-field="${l}"]`);u&&u.value.trim()!==""&&(c[l]=u.value.trim())}),Object.keys(c).length>0&&n.push(c)}),n.length===0){v(d("character_no_data_to_save")||"Tidak ada data karakter untuk disimpan.","warning");return}const o={id:`char_preset_${Date.now()}`,name:t,characters:n},s=ne();s.push(o),_t(s);try{me()}catch(r){console.warn("Failed to populate character preset selector after save:",r.message)}const i=d("character_preset_saved_success",{name:o.name})||`Preset karakter "${o.name}" berhasil disimpan!`;v(i,"success")}async function ka(){const t=document.getElementById("character-preset-selector"),e=t.value;if(!e)return;const n=ne().find(o=>o.id===e);if(n){const o=document.getElementById("dynamic-character-sheet-area");if(o.innerHTML="",n.characters.forEach((y,p)=>{const h=gt(p);ft.forEach(f=>{const g=h.querySelector(`[data-field="${f}"]`);g&&y[f]&&(g.value=y[f])}),o.appendChild(h)}),st(),n.characters.length>1&&document.getElementById("character-mode").value==="group"){const p=document.createElement("button");p.id="add-character-btn",p.textContent="+ Tambah Karakter Lain",p.type="button",p.className="btn-secondary text-sm font-semibold px-3 py-1.5 rounded-md w-full mt-4",o.appendChild(p)}const i=document.getElementById("save-character-button-template").content.cloneNode(!0);o.appendChild(i);const{t:r}=await $(async()=>{const{t:y}=await Promise.resolve().then(()=>Qt);return{t:y}},void 0),c=o.querySelector('[data-lang-key="save_character_button"]');c&&r("save_character_button")&&(c.textContent=r("save_character_button"));const l=document.getElementById("character-mode");n.characters.length===1?l.value="single":n.characters.length===2?l.value="couple":l.value="group";const u=r("character_preset_loaded_success",{name:n.name})||`Preset karakter "${n.name}" dimuat.`;v(u,"success"),t.value=""}}function wa(){const t=ne(),e=new Map;t.forEach(s=>{s!=null&&s.name&&e.set(s.name,s)});const a=Array.from(e.values()),n=document.getElementById("character-preset-list-container"),o=document.getElementById("preset-item-template");if(n.innerHTML="",a.length===0){n.innerHTML='<p class="text-sm text-center text-gray-500 p-4">Anda belum memiliki preset karakter.</p>';return}a.forEach(s=>{const i=o.content.cloneNode(!0),r=i.querySelector(".preset-item");r.dataset.presetId=s.id;const c=i.querySelector(".preset-name-input");c.value=s.name;const l=r.querySelector(".flex"),u=document.createElement("button");u.className="edit-char-preset-btn p-2 text-gray-400 hover:text-amber-400",u.title=d("edit_button")||"Edit",u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793z"/><path d="M11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/></svg>',l.prepend(u),u.addEventListener("click",()=>jo(s)),n.appendChild(i)})}function jo(t){try{it();const e=document.getElementById("edit-character-preset-modal"),a=document.getElementById("edit-character-preset-content");a.innerHTML="",t.characters.forEach((o,s)=>{const i=gt(s);ft.forEach(r=>{const c=i.querySelector(`[data-field="${r}"]`);c&&o[r]&&(c.value=o[r])}),a.appendChild(i)}),e.classList.remove("hidden"),e.classList.add("flex");const n=()=>{e.classList.add("hidden"),e.classList.remove("flex")};document.getElementById("edit-character-preset-close").onclick=n,document.getElementById("edit-character-preset-cancel").onclick=n,document.getElementById("edit-character-preset-save").onclick=async()=>{await Uo(t.id),n()},document.getElementById("edit-character-preset-save-as-new").onclick=async()=>{await Cn((t.name||"")+" Copy"),n()}}catch(e){console.warn("openEditCharacterPresetOverlay failed",e)}}async function Uo(t){const e=ne(),a=e.findIndex(o=>o.id===t);if(a<0)return;const n=[];if(document.querySelectorAll("#edit-character-preset-content .character-sheet-instance").forEach(o=>{const s={};ft.forEach(i=>{const r=o.querySelector(`[data-field="${i}"]`);r&&r.value.trim()&&(s[i]=r.value.trim())}),Object.keys(s).length&&n.push(s)}),!n.length){v(d("character_no_data_to_save")||"Tidak ada data karakter untuk disimpan.","warning");return}e[a]={...e[a],characters:n},_t(e);try{me()}catch{}v(d("character_preset_saved_success",{name:e[a].name})||"Preset karakter disimpan","success")}function Pn(){wa();const t=document.getElementById("manage-character-presets-modal");t.classList.remove("opacity-0","pointer-events-none"),t.querySelector(".modal-content").classList.remove("scale-95")}function it(){const t=document.getElementById("manage-character-presets-modal");t.classList.add("opacity-0","pointer-events-none"),t.querySelector(".modal-content").classList.add("scale-95")}async function Fo(t){let e=ne();const a=e.find(o=>o.id===t);e=e.filter(o=>o.id!==t),_t(e),wa();try{me()}catch(o){console.warn("Failed to populate character preset selector after delete:",o.message)}try{const{cloudStorage:o}=await $(async()=>{const{cloudStorage:s}=await Promise.resolve().then(()=>pt);return{cloudStorage:s}},void 0);if(a){const{data:s}=await x.from("user_presets").select("id").eq("name",a.name).eq("type","character").single();s&&await o.addPendingOperation("presets","delete",{id:s.id,name:a.name,type:"character"})}}catch(o){console.warn("Failed to sync character preset deletion with cloud:",o.message)}const n=d("character_preset_deleted_success")||"Preset karakter berhasil dihapus.";v(n,"success");try{await U.syncCharacterPresets()}catch{}}function Go(t,e){if(!e||!e.trim()){v(d("character_preset_name_empty")||"Preset name cannot be empty.","warning");return}const a=e.trim();if(ne().some(r=>r.id!==t&&String(r.name||"").toLowerCase()===a.toLowerCase())){v(d("preset_name_duplicate",{name:a})||`Nama preset "${a}" sudah digunakan. Silakan pilih nama lain.`,"warning");return}let s=ne();const i=s.findIndex(r=>r.id===t);if(i>-1){const r=s[i].name;s[i].name=a,_t(s),wa();try{me()}catch(c){console.warn("Failed to populate character preset selector after rename:",c.message)}v(d("character_preset_name_updated")||"Nama preset berhasil diperbarui.","success"),(async()=>{try{const{data:{session:c}}=await x.auth.getSession();if(c!=null&&c.user){const l=s[i].id,u=typeof l=="string"&&/^(char_)?preset_/.test(l);if(l&&!u){const{data:y}=await x.from("user_presets").select("id, settings").eq("id",l).single(),p=y!=null&&y.settings?{...y.settings,name:a}:{id:l,name:a,characters:s[i].characters};await x.from("user_presets").update({name:a,settings:p}).eq("id",l)}else{const{data:y}=await x.from("user_presets").select("id, settings").eq("user_id",c.user.id).eq("type","character").eq("name",r).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(y!=null&&y.id){const p=y.settings?{...y.settings,name:a}:{id:s[i].id,name:a,characters:s[i].characters};await x.from("user_presets").update({name:a,settings:p}).eq("id",y.id)}}localStorage.setItem("aethera_character_presets_last_modified",new Date().toISOString());try{await U.syncCharacterPresets()}catch{}}else try{U.addPendingOperation("presets","update",{name:a,type:"character",previous_name:r})}catch{}}catch{try{U.addPendingOperation("presets","update",{name:a,type:"character",previous_name:r})}catch{}}})()}}function Bn(t){const e=t.target,a=e.closest(".preset-item");if(!a)return;const n=a.dataset.presetId;if(e.closest(".delete-preset-btn")){const o=a.querySelector(".preset-name-input").value,s=d("confirm_delete_preset",{name:o})||`Are you sure you want to delete preset "${o}"?`;ye(s,()=>{Fo(n).catch(i=>{console.error("Error deleting character preset:",i)})})}if(e.closest(".save-preset-name-btn")){const o=a.querySelector(".preset-name-input").value;Go(n,o)}}const Jo=Object.freeze(Object.defineProperty({__proto__:null,closeManageCharacterPresetsModal:it,getCharacterPresets:ne,handleCharacterPresetManagement:Bn,handleLoadCharacterPreset:ka,handleSaveCharacterPreset:Tn,openManageCharacterPresetsModal:Pn,populateCharacterPresetSelector:me},Symbol.toStringTag,{value:"Module"}));let We=null;async function Nn(){try{const t=new Uint8Array(16);return crypto.getRandomValues(t),Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}catch{return String(Date.now())+Math.random().toString(36).slice(2)}}async function Vo(){try{const{data:{session:t}}=await x.auth.getSession();if(!(t!=null&&t.user))return;const e=t.user.id;let a=localStorage.getItem("direktiva_session_id");a||(a=await Nn(),localStorage.setItem("direktiva_session_id",a)),await x.from("profiles").upsert({id:e,last_session_id:a,email:t.user.email});const n=async()=>{try{const{data:o,error:s}=await x.from("profiles").select("last_session_id").eq("id",e).single();!s&&o&&o.last_session_id&&o.last_session_id!==a&&(v(d("session_conflict")||"Akun Anda digunakan di perangkat lain. Anda akan keluar.","error"),await Ut())}catch{}};We&&(clearInterval(We),We=null),We=setInterval(n,2e4),window.addEventListener("focus",n,{passive:!0})}catch{}}async function jt(){const{data:{session:t}}=await x.auth.getSession();if(t){m.loginOverlay.classList.add("hidden"),m.appContainer.classList.remove("hidden"),_n(),ee("generator"),dn(),un(),ua(),Vo();try{await U.syncAll(),setTimeout(()=>{try{ue(),me()}catch(e){console.warn("Failed to populate selectors after sync:",e.message)}},500),U.startAutoSync()}catch(e){console.warn("Failed to sync data after login:",e.message);try{ue(),me()}catch(a){console.warn("Failed to populate selectors with local data:",a.message)}Oo()}}else m.loginOverlay.classList.remove("hidden"),m.appContainer.classList.add("hidden")}async function Lt(){var o;const t=document.getElementById("login-email").value,e=document.getElementById("login-password").value,{data:a,error:n}=await x.auth.signInWithPassword({email:t,password:e});if(n)n.message.includes("Invalid login credentials")?v(d("notification_login_invalid"),"error"):v(`${d("notification_login_failed")} ${n.message}`,"error");else{const s="notification_login_success",i=d(s);v(i&&i!==s?i:localStorage.getItem("aethera_language")==="en"?"Login successful":"Berhasil masuk");try{let r=await Nn();localStorage.setItem("direktiva_session_id",r);const{data:{session:c}}=await x.auth.getSession();(o=c==null?void 0:c.user)!=null&&o.id&&await x.from("profiles").upsert({id:c.user.id,last_session_id:r,email:c.user.email})}catch{}await jt()}}async function Yo(){var t,e;try{const a=(e=(t=document.getElementById("login-email"))==null?void 0:t.value)==null?void 0:e.trim();if(!a){v(d("email_label")||"Email","warning");return}const n=window.location.origin,{error:o}=await x.auth.resetPasswordForEmail(a,{redirectTo:n});if(o)throw o;v(d("password_reset_sent")||"Password reset link sent to your email.","success")}catch(a){v(a.message||"Failed to send reset link","error")}}async function Ut(){try{x.auth.signOut({scope:"local"}).catch(a=>{console.warn("Network error during logout (ignored):",a.message)});const t=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith("direktiva_")&&t.push(n)}t.forEach(a=>localStorage.removeItem(a));const e=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith("sb-")&&e.push(n)}e.forEach(a=>localStorage.removeItem(a)),v(d("notification_logout_success"),"success"),setTimeout(()=>{window.location.reload()},1e3)}catch(t){console.warn("Logout error:",t.message),localStorage.clear(),sessionStorage.clear(),window.location.reload()}}function At(t){localStorage.setItem("currentMode",t);const e=t==="single";m.modeSingleBtn.classList.toggle("bg-blue-600",e),m.modeSingleBtn.classList.toggle("text-white",e),m.modeSingleBtn.classList.toggle("text-gray-400",!e),m.modeSingleBtn.classList.toggle("hover:bg-gray-700",!e),m.modeCarouselBtn.classList.toggle("bg-blue-600",!e),m.modeCarouselBtn.classList.toggle("text-white",!e),m.modeCarouselBtn.classList.toggle("text-gray-400",e),m.modeCarouselBtn.classList.toggle("hover:bg-gray-700",e),m.modeSingleBtn.classList.toggle("is-active",e),m.modeCarouselBtn.classList.toggle("is-active",!e);const a=document.getElementById("duration-group");e?(m.scriptCountGroup.classList.remove("hidden"),a&&a.classList.remove("hidden"),m.visualStrategyGroup.classList.remove("hidden"),m.slideCountGroup.classList.add("hidden"),m.carouselTemplateGroup.classList.add("hidden")):(m.scriptCountGroup.classList.add("hidden"),a&&a.classList.add("hidden"),m.visualStrategyGroup.classList.add("hidden"),m.slideCountGroup.classList.remove("hidden"),m.carouselTemplateGroup.classList.remove("hidden"))}function Tt(t){localStorage.setItem("visualStrategy",t),document.querySelectorAll("#visual-strategy-group .track-btn").forEach(i=>{i.classList.remove("is-active")});const e=document.getElementById(`strategy-${t}`);e&&e.classList.add("is-active");const a=document.getElementById("character-mode-group"),n=document.getElementById("character-preset-controls"),o=document.getElementById("dynamic-character-sheet-area"),s=document.getElementById("interaction-description-container");t==="character"?(a.classList.remove("hidden"),n.classList.remove("hidden"),ma()):(a.classList.add("hidden"),n.classList.add("hidden"),o.innerHTML="",s.classList.add("hidden"))}function Ct(t){localStorage.setItem("aspectRatio",t),document.querySelectorAll(".ratio-toggle-track .track-btn").forEach(a=>{a.classList.remove("is-active")});const e=document.getElementById(`ratio-${t.replace(":","")}`);e&&e.classList.add("is-active")}let he=[];function fe(){if(he.length===0){const t=localStorage.getItem("aethera_lastGeneratedScripts");if(t)try{he=JSON.parse(t)}catch(e){console.error("Gagal mem-parsing skrip dari localStorage:",e),he=[]}}return he}function $n(t,e,a){he=t,localStorage.setItem("aethera_lastGeneratedScripts",JSON.stringify(t)),localStorage.setItem("aethera_scripts_last_modified",new Date().toISOString()),t&&t.length>0&&tn(t,e,a)}function ct(t){const e=fe(),a=e.findIndex(n=>n.id===t.id);a>-1&&(e[a]=t,he=e,localStorage.setItem("aethera_lastGeneratedScripts",JSON.stringify(e)),localStorage.setItem("aethera_scripts_last_modified",new Date().toISOString()))}function On(){he=[],localStorage.removeItem("aethera_lastGeneratedScripts"),localStorage.setItem("aethera_scripts_last_modified",new Date().toISOString())}const Ko=Object.freeze(Object.defineProperty({__proto__:null,clearScripts:On,getScripts:fe,setScripts:$n,updateSingleScript:ct},Symbol.toStringTag,{value:"Module"}));async function zo(){var t;return(t=window.jspdf)!=null&&t.jsPDF||await new Promise((e,a)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",n.onload=e,n.onerror=a,document.head.appendChild(n)}),window.jspdf.jsPDF}async function Wo(){return window.XLSX||await new Promise((t,e)=>{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",a.onload=t,a.onerror=e,document.head.appendChild(a)}),window.XLSX}let Pt;async function Xo(){var t;return(t=window.jspdf)!=null&&t.jsPDF?window.jspdf.jsPDF:(Pt=Pt||zo(),Pt)}function Zo(t){const e=fe();if(e.length===0){v(d("notification_no_script_to_download"),"warning");return}const n=`Aethera Studio - ${(m.inputs.productName.value.trim()||"Aethera_Studio_Script").replace(/[^a-z0-9]/gi,"_").toLowerCase()}`;t==="pdf"&&Qo(e,n),t==="docx"&&es(e,n),t==="xlsx"&&ts(e,n)}async function Qo(t,e){const a=await Xo();if(!a){v(d("export_pdf_unavailable")||"Export PDF unavailable: jsPDF not loaded.","error");return}const n=new a;t.forEach((o,s)=>{s>0&&n.addPage(),n.setFont("helvetica","bold"),n.text(`${d("script_option")} #${s+1}: ${o.title}`,10,10),n.setFont("helvetica","normal");const i=Te(o),r=n.splitTextToSize(i,180);n.text(r,10,20)}),n.save(`${e}.pdf`)}function vt(t){const e=[];return t.body_intro&&e.push({section:"Body",scene:"intro",text:t.body_intro,t2i:"",i2v:""}),t.hook&&(e.push({section:"Hook",scene:"main",text:t.hook.text||"",t2i:"",i2v:""}),t.hook.shots&&t.hook.shots.forEach((a,n)=>{e.push({section:"Hook",scene:`shot_${n+1}`,text:a.visual_idea||"",t2i:a.text_to_image_prompt||"",i2v:a.image_to_video_prompt||""})})),t.body&&(e.push({section:"Body",scene:"main",text:t.body.text||"",t2i:"",i2v:""}),t.body.shots&&t.body.shots.forEach((a,n)=>{e.push({section:"Body",scene:`shot_${n+1}`,text:a.visual_idea||"",t2i:a.text_to_image_prompt||"",i2v:a.image_to_video_prompt||""})})),t.cta&&(e.push({section:"CTA",scene:"main",text:t.cta.text||"",t2i:"",i2v:""}),t.cta.shots&&t.cta.shots.forEach((a,n)=>{e.push({section:"CTA",scene:`shot_${n+1}`,text:a.visual_idea||"",t2i:a.text_to_image_prompt||"",i2v:a.image_to_video_prompt||""})})),e}function Mn(t){const e=vt(t),a={title:t.title||"Untitled Script",created_at:new Date().toISOString(),format:"prompt_pack",rows:e},n=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`${t.title||"script"}_prompt_pack.json`,s.click(),URL.revokeObjectURL(o),v(d("prompt_pack_json_downloaded_success")||"Prompt Pack JSON berhasil diunduh!","success")}function Rn(t){const e=vt(t);let n=["Section","Scene","Text","Text-to-Image Prompt","Image-to-Video Prompt"].join(",")+`
`;e.forEach(r=>{const c=[`"${r.section}"`,`"${r.scene}"`,`"${r.text.replace(/"/g,'""')}"`,`"${r.t2i.replace(/"/g,'""')}"`,`"${r.i2v.replace(/"/g,'""')}"`].join(",");n+=c+`
`});const o=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download=`${t.title||"script"}_prompt_pack.csv`,i.click(),URL.revokeObjectURL(s),v(d("prompt_pack_csv_downloaded_success")||"Prompt Pack CSV berhasil diunduh!","success")}function lt(t){const e=Math.floor(t/3600),a=Math.floor(t%3600/60),n=Math.floor(t%60),o=Math.floor(t%1*1e3);return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")},${o.toString().padStart(3,"0")}`}function Dn(t){const e=vt(t).filter(p=>p.text.trim()!=="");if(e.length===0){v(d("no_text_to_export_srt")||"Tidak ada teks untuk diekspor ke SRT","warning");return}const a=60,n=a*.25,o=a*.6,s=a*.15;let i="",r=0,c=1;e.forEach(p=>{let h;p.section==="Hook"?h=n/e.filter(E=>E.section==="Hook").length:p.section==="Body"?h=o/e.filter(E=>E.section==="Body").length:p.section==="CTA"?h=s/e.filter(E=>E.section==="CTA").length:h=2;const f=r,g=r+h;i+=`${c}
`,i+=`${lt(f)} --> ${lt(g)}
`,i+=`${p.text}

`,r=g,c++});const l=new Blob([i],{type:"text/plain;charset=utf-8;"}),u=URL.createObjectURL(l),y=document.createElement("a");y.href=u,y.download=`${t.title||"script"}_capcut.srt`,y.click(),URL.revokeObjectURL(u),v(d("capcut_srt_downloaded_success")||"CapCut SRT berhasil diunduh!","success")}function qn(t){const e=vt(t).filter(l=>l.text.trim()!=="");if(e.length===0){v(d("no_text_to_export_csv")||"Tidak ada teks untuk diekspor ke CSV","warning");return}const a=3;let o=["Index","Start Time","End Time","Text","Section"].join(",")+`
`,s=0;e.forEach((l,u)=>{const y=s,p=s+a,h=[u+1,lt(y),lt(p),`"${l.text.replace(/"/g,'""')}"`,`"${l.section}"`].join(",");o+=h+`
`,s=p});const i=new Blob([o],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`${t.title||"script"}_capcut.csv`,c.click(),URL.revokeObjectURL(r),v(d("capcut_csv_downloaded_success")||"CapCut CSV berhasil diunduh!","success")}function es(t,e){let a="";t.forEach((r,c)=>{a+=`<h1>${d("script_option")} #${c+1}: ${r.title}</h1>`,a+=Te(r).replace(/\n/g,"<br>"),c<t.length-1&&(a+='<br clear="all" style="page-break-before:always" />')});const n=`<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title></head><body>${a}</body></html>`,o=new Blob(["\uFEFF",n],{type:"application/msword"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download=`${e}.doc`,document.body.appendChild(i),i.click(),document.body.removeChild(i)}async function ts(t,e){const a=await Wo(),n=a.utils.book_new();t.forEach((o,s)=>{let i=[];if(o.hook){i.push([d("part_label"),d("script_text_label"),d("visual_idea_label_short"),d("t2i_prompt_label_short"),d("i2v_prompt_label_short")]),i.push([d("script_title_label")||"Judul",o.title,"","",""]),o.character_sheet&&o.character_sheet.length>0&&o.character_sheet.forEach(l=>{i.push([d("character_label")||"Karakter",aa(l)])});const c=(l,u)=>{u.shots.forEach((y,p)=>{i.push([p===0?l:"",p===0?u.text:"",y.visual_idea,y.text_to_image_prompt,y.image_to_video_prompt])})};c(d("hook_title"),o.hook),c(d("body_title"),o.body),c(d("cta_title"),o.cta)}else o.slides&&(i.push([d("slide_label_short"),d("slide_text_label"),d("t2i_prompt_label"),d("slide_layout_suggestion"),d("slide_engagement_idea")]),o.slides.forEach((c,l)=>{i.push([l+1,c.slide_text,c.text_to_image_prompt,c.layout_suggestion||"-",c.engagement_idea||"-"])}));const r=a.utils.aoa_to_sheet(i);a.utils.book_append_sheet(n,r,`${d("option_label")||"Opsi"} ${s+1}`)}),a.writeFile(n,`${e}.xlsx`)}const Ft={tiktok_video:{id:{rate:"+12%",pitch:"+2st",pauseMs:220,voiceHint:"energetic, upbeat, Indonesian"},en:{rate:"+10%",pitch:"+1st",pauseMs:220,voiceHint:"energetic, upbeat, American English"}},shopee_video:{id:{rate:"+8%",pitch:"+1st",pauseMs:260,voiceHint:"clear, friendly promo, Indonesian"},en:{rate:"+6%",pitch:"+1st",pauseMs:260,voiceHint:"clear, friendly promo, English"}},igreels:{id:{rate:"+8%",pitch:"+1st",pauseMs:240,voiceHint:"aesthetic, calm assertive, Indonesian"},en:{rate:"+6%",pitch:"+1st",pauseMs:240,voiceHint:"aesthetic, calm assertive, English"}},threads:{id:{rate:"+4%",pitch:"+0st",pauseMs:260,voiceHint:"conversational, friendly, Indonesian"},en:{rate:"+4%",pitch:"+0st",pauseMs:260,voiceHint:"conversational, friendly, English"}},shorts:{id:{rate:"+10%",pitch:"+1st",pauseMs:220,voiceHint:"punchy, confident, Indonesian"},en:{rate:"+10%",pitch:"+1st",pauseMs:220,voiceHint:"punchy, confident, English"}}},as={tiktok:"tiktok_video","tiktok video":"tiktok_video",shopee:"shopee_video","shopee video":"shopee_video",reels:"igreels","ig reels":"igreels",instagram:"igreels","youtube shorts":"shorts",ytshorts:"shorts","yt shorts":"shorts",shorts:"shorts",thread:"threads","instagram threads":"threads"};function ns(t="tiktok_video"){const e=String(t||"").toLowerCase().trim();return Ft[e]?e:as[e]||"tiktok_video"}function os(t="tiktok_video",e="id"){const a=ns(t),n=Ft[a]||Ft.tiktok_video;return String(e).toLowerCase()==="en"?n.en:n.id}const ss={Elavoz:"E-la-voz",viscose:"vis-kos",niacinamide:"nia-si-na-mayd",keranjang:"ke-ranjang"},rs={niacinamide:"nai-uh-SIN-uh-mide",viscose:"VIS-kohss"};function is(t,e="id"){const a=e==="en"?rs:ss;let n=t;for(const[o,s]of Object.entries(a)){const i=new RegExp(`\\b${o}\\b`,"g");n=n.replace(i,`<sub alias="${s}">${o}</sub>`)}return n}function cs(t,e="id"){const a=(t||"").trim().split(/\s+/).filter(Boolean).length;return Math.round(a/(e==="en"?180:170)*6e4)}function Gt(t){return(t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")}const Bt=t=>`<break time="${t}ms"/>`,ls=t=>`<s>${Gt(t)}</s>`;function ds(t,e,a="id",n={}){const{hook:o="",scenes:s=[],cta:i=""}=t||{},r=e.pauseMs??240,c=(s||[]).map(u=>ls(Array.isArray(u)?u.join(" "):u||"")).join(Bt(r));let l=`
<speak>
  <prosody rate="${e.rate}" pitch="${e.pitch}">
    <emphasis level="strong">${Gt(o)}</emphasis>${Bt(300)}
    ${c}${Bt(300)}
    <emphasis level="moderate">${Gt(i)}</emphasis>
  </prosody>
</speak>`.trim();return n.applyPronDict!==!1&&(l=is(l,a)),l}function us(t,e,a="id"){const{hook:n="",scenes:o=[],cta:s=""}=t||{},i=c=>Array.isArray(c)?c.join(" "):String(c||"");return[`${a==="en"?"Read in clear American English.":"Bacakan dalam Bahasa Indonesia yang jelas."} Style: ${e.voiceHint}. Pace ${e.rate}, pitch ${e.pitch}. Add natural short pauses between sentences. Emphasize key benefits.`,`HOOK: ${n}`,...(o||[]).map((c,l)=>`SCENE ${l+1}: ${i(c)}`),`CTA: ${s}`].join(`
`)}function ms(t,e="id"){const{scenes:a=[]}=t||{};return(a||[]).map(n=>{const o=Array.isArray(n)?n.join(" "):String(n||"");return{text:o,estMs:cs(o,e)}})}function ze(t,e={}){const a=(e.lang||"id").toLowerCase()==="en"?"en":"id",n=e.platform||"tiktok_video",o=os(n,a),s=ds(t,o,a,{applyPronDict:!0}),i=us(t,o,a),r=ms(t,a);return{lang:a,platform:n,recipe:o,ssml:s,geminiText:i,readTimes:r}}let Nt=[];function ps(){"speechSynthesis"in window&&(Nt=window.speechSynthesis.getVoices(),Nt.length||(window.speechSynthesis.onvoiceschanged=()=>{Nt=window.speechSynthesis.getVoices()}))}ps();async function gs(){return window.JSZip||await new Promise((t,e)=>{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",a.onload=t,a.onerror=e,document.head.appendChild(a)}),window.JSZip}function hs(t){return`<!doctype html>
<html lang="en"><meta charset="utf-8">
<title>VO Preview (Gemini)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;padding:16px;background:#0b1220;color:#e5e7eb}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  textarea{width:100%;height:200px;background:#0f1629;color:#e5e7eb;border:1px solid #23314d;border-radius:8px;padding:10px}
  select,button{padding:8px 12px;border-radius:8px;border:1px solid #23314d;background:#111a2e;color:#e5e7eb;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .hint{color:#9aa4b2;font-size:12px}
</style>
<h2>VO Preview (Gemini)</h2>
<div class="row">
  <label>Voice:</label>
  <select id="voice">
    <option value="Kore" selected>Kore</option>
    <option value="Puck">Puck</option>
  </select>
</div>
<textarea id="text"></textarea>
<div class="row">
  <button id="play"> Preview Gemini</button>
  <span id="status" class="hint"></span>
</div>
<script>
  const ta = document.getElementById('text');
  ta.value = ${JSON.stringify(t||"")};
  const btn = document.getElementById('play');
  const status = document.getElementById('status');
  let audioRef = null, busy = false;
  async function play() {
    if (busy) return;
    busy = true; btn.disabled = true; status.textContent = 'Generating audio...';
    try {
      if (audioRef) { try{ audioRef.pause(); }catch(e){} }
      const voiceName = document.getElementById('voice').value || 'Kore';
      const r = await fetch('/api/tts/gemini', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text: ta.value, voiceName })
      });
      const txt = await r.text();
      if (!r.ok) { let msg = txt; try{ const j=JSON.parse(txt); msg=j.error||txt; }catch{} throw new Error(msg); }
      const { audio_base64, mime } = JSON.parse(txt);
      audioRef = new Audio(\`data:\${mime||'audio/wav'};base64,\${audio_base64}\`);
      audioRef.onended = ()=>{ busy=false; btn.disabled=false; status.textContent=''; };
      audioRef.onerror = ()=>{ busy=false; btn.disabled=false; status.textContent='(audio error)'; };
      audioRef.play().then(()=>{ status.textContent='Playing...'; });
    } catch(e) {
      status.textContent = e.message || String(e);
      busy=false; btn.disabled=false;
    }
  }
  btn.addEventListener('click', play);
<\/script>
</html>`}async function Hn(t,e={}){const{geminiText:a}=ze(t,e);await navigator.clipboard.writeText(a)}async function jn(t,e={}){const{ssml:a}=ze(t,e);await navigator.clipboard.writeText(a)}async function Un(t,e={}){const{ssml:a,geminiText:n,lang:o,platform:s}=ze(t,e),i=await gs(),r=new i,c=r.folder(`VO/${s}_${o}`);c.file(`vo_${s}_${o}_gemini.txt`,n),c.file(`vo_${s}_${o}.ssml`,a),c.file("vo_preview_gemini.html",hs(n));const l=await r.generateAsync({type:"blob"}),u=document.createElement("a");u.href=URL.createObjectURL(l),u.download=`vo_${s}_${o}.zip`,u.click(),URL.revokeObjectURL(u.href)}function Jt(){let t=document.getElementById("aethera-vo-audio");return t||(t=document.createElement("audio"),t.id="aethera-vo-audio",t.style.display="none",document.body.appendChild(t)),t}window.__voCache||(window.__voCache=new Map);window.__voState||(window.__voState={});function ys(t){let e=2166136261;for(let a=0;a<t.length;a++)e^=t.charCodeAt(a),e=Math.imul(e,16777619);return(e>>>0).toString(36)}function fs(t,e){var n;const a=[(t==null?void 0:t.hook)||"",((n=t==null?void 0:t.scenes)==null?void 0:n[0])||"",(t==null?void 0:t.cta)||"",(e==null?void 0:e.platform)||"",(e==null?void 0:e.lang)||""].join("|");return"vo:"+ys(a)}function K(t,e){t&&(t.__busy=e,t.disabled=e,t.classList.toggle("opacity-50",e),t.textContent=e?" Generating":" Preview Gemini (API)")}async function Fn(t,e={},a="Kore",n={}){const{geminiText:o}=ze(t,e),s=(n==null?void 0:n.button)||null,i=(n==null?void 0:n.cacheKey)||fs(t,e);if(s&&s.__busy)return;Ea();const r=window.__voCache.get(i);if(r!=null&&r.src){const l=Jt();l.src=r.src,window.__voState.playingKey=i,window.__voState.busyBtn=s||null,l.onended=()=>{K(s,!1),window.__voState.busyBtn=null},l.onerror=()=>{K(s,!1),window.__voState.busyBtn=null};try{K(s,!0),v("Playing cached preview","success"),await l.play()}catch(u){K(s,!1),window.__voState.busyBtn=null,v(u.message||"Failed to play","error")}return}if(r!=null&&r.speech)try{window.__voState.busyBtn=s||null,K(s,!0);const l=new SpeechSynthesisUtterance(r.speech);l.onend=()=>{K(s,!1),window.__voState.busyBtn=null},l.onerror=()=>{K(s,!1),window.__voState.busyBtn=null},window.speechSynthesis.cancel(),window.speechSynthesis.speak(l),v("Playing cached preview","success");return}catch(l){K(s,!1),window.__voState.busyBtn=null,v(l.message||"Failed to play","error");return}K(s,!0),v("Generating audio","info");const c=new AbortController;window.__voState.controller=c,window.__voState.busyBtn=s;try{const l=await fetch("/api/tts/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o,voiceName:a}),signal:c.signal}),u=await l.text();if(!l.ok){let g=u;try{g=JSON.parse(u).error||u}catch{}try{window.__voCache.set(i,{speech:o,createdAt:Date.now()});const E=new SpeechSynthesisUtterance(o);E.onend=()=>{K(s,!1),window.__voState.busyBtn=null},E.onerror=()=>{K(s,!1),window.__voState.busyBtn=null},window.__voState.busyBtn=s||null,window.speechSynthesis.cancel(),window.speechSynthesis.speak(E),v("Preview (browser TTS fallback)","info");return}catch{throw new Error(g)}}const{audio_base64:y,mime:p}=JSON.parse(u),h=`data:${p||"audio/wav"};base64,${y}`;window.__voCache.set(i,{src:h,mime:p||"audio/wav",createdAt:Date.now()});const f=Jt();f.src=h,window.__voState.playingKey=i,f.onended=()=>{K(s,!1),window.__voState.busyBtn=null},f.onerror=()=>{K(s,!1),window.__voState.busyBtn=null},await f.play(),v("Playing preview","success")}catch(l){(l==null?void 0:l.name)==="AbortError"?v("Preview canceled.","info"):(v(l.message||"Preview failed","error"),alert(l.message||l)),K(s,!1)}finally{window.__voState.controller=null}}function Ea(){var e;try{(e=window.__voState.controller)==null||e.abort()}catch{}try{const a=Jt();a.pause(),a.src="",a.load()}catch{}try{window.speechSynthesis&&window.speechSynthesis.cancel()}catch{}const t=window.__voState.busyBtn;t&&(K(t,!1),window.__voState.busyBtn=null),window.__voState.playingKey=null,v("Preview stopped.","info")}function _s(t){const e=(t||"")+"";let a=0;for(let n=0;n<e.length;n++)a=a*31+e.charCodeAt(n)>>>0;return a}function Gn(t,e,a,n){var y,p,h;const o=f=>Array.isArray(f)?f.map(g=>Number(g)).filter(Number.isFinite):[],s=f=>{const g=o(f);return g.length?Math.max(...g):0},i=s(t)*.5+s(e)*.3+s(a)*.2,r=`${((y=n==null?void 0:n.hook)==null?void 0:y.text)||(n==null?void 0:n.hook)||""}|${((p=n==null?void 0:n.body)==null?void 0:p.text)||(n==null?void 0:n.body)||""}|${((h=n==null?void 0:n.cta)==null?void 0:h.text)||(n==null?void 0:n.cta)||""}`,c=_s(r)%3,u=90+Math.max(0,Math.min(8,i*.1))+c;return Math.min(98,Math.round(u))}async function pe(t){if(!t)return 0;const a=t.trim().split(/\s+/).length;let n=0;a>=5&&a<=12?n+=30:a<5?n+=10:n-=(a-12)*3;const{t:o}=await $(async()=>{const{t:u}=await Promise.resolve().then(()=>Qt);return{t:u}},void 0),s=o("action_words"),i=Array.isArray(s)?s:["try","check","see","discount","promo","secret","turns out","free","viral","trending"],r=t.toLowerCase();i.forEach(u=>{r.includes(u)&&(n+=15)});const c=o("commerce_words");return(Array.isArray(c)?c:["cart","checkout","buy","order"]).forEach(u=>{r.includes(u)&&(n+=10)}),/\d+%|\d+/.test(t)&&(n+=10),Math.max(0,n)}async function re(t){if(!t)return 0;const a=t.trim().split(/\s+/).length;let n=0;a>=8&&a<=14?n+=25:a<8?n+=10:n-=(a-14)*2;const{t:o}=await $(async()=>{const{t:u}=await Promise.resolve().then(()=>Qt);return{t:u}},void 0),s=t.toLowerCase(),i=o("benefit_words")||["save","easy","fast","practical","effective","proven","quality"];Array.isArray(i)&&i.forEach(u=>{s.includes(u)&&(n+=12)});const r=o("problem_words")||["problem","difficult","complicated","expensive","slow"],c=o("solution_words")||["solution","answer","way","tips","tricks"];Array.isArray(r)&&Array.isArray(c)&&r.some(u=>s.includes(u))&&c.some(u=>s.includes(u))&&(n+=15);const l=o("social_words")||["many","thousands","millions","trusted","testimonial","review"];return Array.isArray(l)&&l.forEach(u=>{s.includes(u)&&(n+=10)}),Math.max(0,n)}function ve(t){if(!t)return 0;const a=t.trim().split(/\s+/).length;let n=0;a>=3&&a<=8?n+=30:a<3?n+=5:n-=(a-8)*4;const o=t.toLowerCase(),s=(l,u)=>{const y=d(l);return Array.isArray(y)?y.map(p=>String(p).toLowerCase().trim()).filter(Boolean):typeof y=="string"?y.split(",").map(p=>p.toLowerCase().trim()).filter(Boolean):u.split(",").map(p=>p.toLowerCase().trim()).filter(Boolean)};return s("cta_low_friction_words","tap,klik,keranjang,subscribe,follow,comment,reply,swipe").forEach(l=>{l&&o.includes(l)&&(n+=20)}),s("cta_action_words","beli,order,dapatkan,ambil,coba,download").forEach(l=>{l&&o.includes(l)&&(n+=10)}),s("cta_urgency_words","sekarang,segera,terbatas,hari ini,buruan").forEach(l=>{l&&o.includes(l)&&(n+=8)}),Math.max(0,n)}function Jn(t,e=7){if(!t)return t;const a=t.trim().split(/\s+/);return a.length<=e?t:a.slice(0,e).join(" ")+"..."}async function Vn(t){var o;const e=m.outputPanel,a=document.getElementById("results-toolbar");if(e&&(e.innerHTML=""),a){const s=Array.isArray(t)&&t.length>1;a.classList.toggle("hidden",!s);try{a.style.display=s?"flex":"none"}catch{}}try{if(e&&!e.__toolbarObserver){const s=()=>{const r=e.querySelectorAll(".result-card").length,c=document.getElementById("results-toolbar");if(!c)return;const l=r>1;c.classList.toggle("hidden",!l);try{c.style.display=l?"flex":"none"}catch{}},i=new MutationObserver(()=>s());i.observe(e,{childList:!0,subtree:!1}),e.__toolbarObserver=i,s()}}catch{}if(!t||t.length===0){xa(d("notification_script_generation_error"));return}const n=t.map(async(s,i)=>{const r=await Yn(s,i);return r.style.opacity="0",r.style.transform="translateY(20px)",m.outputPanel.appendChild(r),setTimeout(()=>{r.classList.add("animate-fadeInUp"),r.style.opacity="1",r.style.transform="translateY(0)"},i*150),s.slides&&ha(`#card-${s.id||i} .carousel-swiper-container`),setTimeout(()=>{try{Le()}catch{}},0),r});await Promise.all(n);try{const s=document.getElementById("results-toolbar");if(s){const r=document.querySelectorAll("#output-panel .result-card").length>1;s.classList.toggle("hidden",!r);try{s.style.display=r?"flex":"none"}catch{}}}catch{}try{Le()}catch{}setTimeout(()=>{try{const s=document.getElementById("results-toolbar");if(!s)return;const r=document.querySelectorAll("#output-panel .result-card").length>1;s.classList.toggle("hidden",!r);try{s.style.display=r?"flex":"none"}catch{}}catch{}try{Le()}catch{}},50);try{const s=document.getElementById("pipeline-warnings"),i=Array.isArray(t)&&t[0],r=((o=i==null?void 0:i.__pipeline)==null?void 0:o.warnings)||[];s&&(s.innerHTML=(r.length?r:[]).map(c=>`<div> ${c}</div>`).join(""))}catch{}}function xa(t){m.outputPanel.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-center text-red-400"><div class="text-6xl mb-4">:(</div><h3 class="text-xl font-semibold">${d("notification_script_generation_error_title")||"Oops!"}</h3><p class="max-w-sm mt-2">${t}</p></div>`}async function Yn(t,e){var s,i,r,c;const n=document.getElementById("result-card-template").content.cloneNode(!0).firstElementChild;t.id||(t.id=`script-${Date.now()}-${e}`),n.id=`card-${t.id}`,n.querySelector(".result-title").textContent=d("script_option_title",{index:e+1,title:t.title});try{const l=Array.isArray(t.hook_variants)?t.hook_variants:[],u=await Promise.all([...l.map(T=>pe(T)),pe(((s=t.hook)==null?void 0:s.text)||t.hook||"")]),y=Math.max(...u.map(Number).filter(Number.isFinite),0),h=[...(Array.isArray(t.cta_variants)?t.cta_variants:[]).map(T=>ve(T)),ve(((i=t.cta)==null?void 0:i.text)||t.cta||"")],f=Math.max(...h.map(Number).filter(Number.isFinite),0),g=(((r=t.body)==null?void 0:r.text)||t.body||"").toString().split(`
`)[0]||"",E=Array.isArray(t.body_variants)?t.body_variants:[],k=await Promise.all([...E.map(T=>re(T)),re(g)]),L=Math.max(...k.map(Number).filter(Number.isFinite),0),b=Gn([y],[L],[f],t);n.dataset.globalScore=String(b);const P=document.createElement("span"),_=localStorage.getItem("direktiva_theme")||"dark";P.textContent=`Score ${b}`,P.style.marginLeft="6px",P.style.padding="2px 8px",P.style.borderRadius="9999px",P.style.fontSize="12px",P.style.lineHeight="1",P.style.display="inline-flex",P.style.alignItems="center",P.style.fontWeight="600",_==="light"?(P.style.backgroundColor="#d1fae5",P.style.border="1px solid #6ee7b7",P.style.color="#065f46"):(P.style.backgroundColor="rgba(16,185,129,0.15)",P.style.border="1px solid rgba(16,185,129,0.25)",P.style.color="#a7f3d0");const S=n.querySelector(".result-title");if(S){const T=S.textContent;S.textContent="";const C=document.createElement("span");C.textContent=T,S.style.display="flex",S.style.alignItems="center",S.style.gap="8px",S.style.whiteSpace="normal",S.style.flex="1 1 auto",P.style.whiteSpace="nowrap",S.appendChild(C),S.appendChild(P)}}catch(l){console.warn("Scoring badge failed:",l)}n.querySelector(".edit-btn").title=d("edit_button")||"Edit",n.querySelector(".copy-btn").title=d("copy_full_script")||"Copy Full Script",_a(n,t);try{const l=n.querySelector(".card-content");if(l){const u=(((c=t.hook)==null?void 0:c.text)||t.hook||"").toString().split(`
`)[0]||"",y=document.createElement("p");y.className="text-sm text-gray-400",y.textContent=u.slice(0,120)+(u.length>120?"":""),l.innerHTML="",l.style.display="none"}}catch{}try{n.querySelectorAll(".edit-btn, .copy-btn, .view-btn").forEach(l=>{l.style.display="none"})}catch{}n.querySelector(".copy-btn").addEventListener("click",()=>{const l=n.querySelector(".copy-btn");z(!0,l);try{Ee(Te(n),l)}finally{setTimeout(()=>{z(!1,l)},500)}}),n.querySelector(".edit-btn").addEventListener("click",()=>ta(n));const o=n.querySelector(".view-btn");o&&o.addEventListener("click",l=>{l.stopPropagation(),Ae(n,JSON.parse(n.dataset.script))}),n.addEventListener("click",l=>{l.target.closest(".export-dropdown")||l.target.closest(".edit-btn")||l.target.closest(".copy-btn")||l.target.closest(".view-btn")||Ae(n,JSON.parse(n.dataset.script))});try{const l=n.querySelector(".export-btn"),u=n.querySelector(".export-menu");(l||u)&&(l==null||l.remove(),u==null||u.remove())}catch{}return setTimeout(()=>{try{Le()}catch{}},0),n}async function Kn(t){if(!t.hook_variants&&!t.body_variants&&!t.cta_variants)return"";localStorage.getItem("direktiva_theme");let e=`
        <div class="ab-variants p-4 rounded-lg bg-gray-900/40 border border-gray-800/40">
            <h4 class="text-lg font-semibold text-blue-300 mb-2">A/B Variants - Pilih Copy Terbaik</h4>
    `;return t.hook_variants&&t.hook_variants.length>0&&(e+=await qe("Hook",t.hook_variants,pe,"hook")),t.body_intro&&(e+=await qe("Body Intro",[t.body_intro],re,"body_intro")),t.body_variants&&t.body_variants.length>0&&(e+=await qe("Body",t.body_variants,re,"body")),t.cta_variants&&t.cta_variants.length>0&&(e+=await qe("CTA",t.cta_variants,ve,"cta")),e+="</div>",e}async function qe(t,e,a,n){const o=await Promise.all(e.map(async(i,r)=>({text:i,score:await a(i),index:r})));o.sort((i,r)=>r.score-i.score),o[0];let s=`
        <div class="variant-section mb-4">
            <h6 class="text-xs font-semibold text-blue-200 mb-2 light-mode:text-blue-600">${t} (${e.length} ${d("options")||"opsi"})</h6>
            <div class="space-y-2">
    `;return o.forEach((i,r)=>{const c=r===0,l=c?"bg-green-600":i.score>=50?"bg-blue-600":"bg-gray-600",u=c?d("best")||"TERBAIK":`${i.score}pts`;s+=`
            <div class="variant-item flex items-start space-x-3 p-2 rounded ${c?"bg-green-900/20 border border-green-700/30":"bg-gray-800/30"}">
                <span class="${l} text-white text-xs px-2 py-1 rounded font-bold flex-shrink-0">${u}</span>
                <p class="text-sm text-gray-300 flex-1">${i.text}</p>
                <div class="flex space-x-1 flex-shrink-0">
                    ${n==="hook"?`<button class="shorten-btn text-xs bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded" data-section="${n}" data-index="${i.index}" title="${d("shorten_tooltip")||"Pendekkan (7 kata)"}">${d("shorten_button")||"Pendek"}</button>`:""}
                    <button class="use-variant-btn text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded" data-section="${n}" data-index="${i.index}">${d("use_button")||"Gunakan"}</button>
                </div>
            </div>
        `}),s+=`
            </div>
            <div class="mt-2 flex space-x-2">
                <button class="use-best-btn text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded font-semibold" data-section="${n}"> ${d("use_best_button")||"Pakai Terbaik"}</button>
            </div>
        </div>
    `,s}function vs(t){const e=JSON.parse(t.dataset.script);t.querySelectorAll(".use-best-btn").forEach(a=>{a.addEventListener("click",n=>{const o=n.target.dataset.section;Ia(t,e,o)})}),t.querySelectorAll(".use-variant-btn").forEach(a=>{a.addEventListener("click",n=>{const o=n.target.dataset.section,s=parseInt(n.target.dataset.index);La(t,e,o,s)})}),t.querySelectorAll(".shorten-btn").forEach(a=>{a.addEventListener("click",n=>{const o=n.target.dataset.section,s=parseInt(n.target.dataset.index);Aa(t,e,o,s)})})}async function Ia(t,e,a){let n,o;switch(a){case"hook":n=e.hook_variants,o=pe;break;case"body":n=e.body_variants,o=re;break;case"body_intro":n=[e.body_intro],o=re;break;case"cta":n=e.cta_variants,o=ve;break;default:return}if(!n||n.length===0)return;const s=await Promise.all(n.map(c=>Promise.resolve(o(c))));let i=0,r=Number.NEGATIVE_INFINITY;s.forEach((c,l)=>{const u=Number(c);Number.isFinite(u)&&u>r&&(r=u,i=l)}),await bt(t,e,a,n[i])}async function La(t,e,a,n){let o;switch(a){case"hook":o=e.hook_variants;break;case"body":o=e.body_variants;break;case"body_intro":o=[e.body_intro];break;case"cta":o=e.cta_variants;break;default:return}!o||!o[n]||await bt(t,e,a,o[n])}async function Aa(t,e,a,n){let o;switch(a){case"hook":o=e.hook_variants;break;default:return}if(!o||!o[n])return;const s=Jn(o[n],7);await bt(t,e,a,s)}async function He(t,e,a){try{const n=localStorage.getItem("productName")||t.title||"Product",o=localStorage.getItem("productDescription")||"Product description",s=localStorage.getItem("visualStrategy")||"standard",i=localStorage.getItem("aspectRatio")||"9:16",r=localStorage.getItem("direktiva_language")||"id",c=localStorage.getItem("direktiva_system_prompt")||"",l=JSON.stringify(t.character_sheet||[],null,2),u=Array.isArray(t.original_character_descriptions)?t.original_character_descriptions.join("; "):"",y=`Characters (character_sheet): ${l}
Original character physical descriptions: ${u}`,p=`${c}

${r==="en"?`Based on the new ${e.toUpperCase()} text: "${a}"

Product: ${n}
Description: ${o}
Visual Strategy: ${s}
Aspect Ratio: ${i}
${y}

IMPORTANT LANGUAGE RULES (override any previous instructions):
- visual_idea MUST be in English only.
- text_to_image_prompt MUST be in English only.
- image_to_video_prompt MUST be in English only.
- DO NOT mix any other language.

CHARACTER CONSTRAINTS:
- Use ONLY the characters provided in character_sheet above. Keep names and personalities consistent.
- DO NOT invent, change, or swap characters.
- In text_to_image_prompt, put physical descriptions ONLY inside <char-desc>...</char-desc> tags.
- NEVER include <char-desc> in image_to_video_prompt.

Return strictly JSON with structure:
{
  "shots": [
    {
      "visual_idea": "concise cinematic description in English",
      "text_to_image_prompt": "very detailed T2I prompt in English (use <char-desc> for physical details only). END the prompt with compact blocks: ID[brand/model/colors; features=...] | CAM[...] | LIGHT[...] | MOOD[...].",
      "image_to_video_prompt": "I2V prompt in English (movement only, no physical descriptions)",
      "negative_prompt": "negative prompt for image quality"
    }
  ]
}`:`Berdasarkan teks ${e.toUpperCase()} yang baru: "${a}"

Produk: ${n}
Deskripsi: ${o}
Strategi Visual: ${s}
Rasio: ${i}
${y}

ATURAN BAHASA (menimpa instruksi sebelumnya):
- visual_idea WAJIB dalam Bahasa Indonesia saja.
- text_to_image_prompt (T2I) WAJIB dalam Bahasa Inggris saja.
- image_to_video_prompt (I2V) WAJIB dalam Bahasa Inggris saja.
- JANGAN campur bahasa dalam setiap field.

KONSTR A KARAKTER:
- Gunakan HANYA karakter dari character_sheet di atas. Nama dan kepribadian harus konsisten.
- JANGAN menciptakan/mengubah karakter.
- Di text_to_image_prompt, taruh deskripsi fisik HANYA di dalam tag <char-desc>...</char-desc>.
- JANGAN pernah menaruh <char-desc> pada image_to_video_prompt.

Kembalikan JSON murni dengan struktur:
{
  "shots": [
    {
      "visual_idea": "deskripsi sinematik singkat dalam Bahasa Indonesia",
      "text_to_image_prompt": "prompt T2I sangat detail dalam Bahasa Inggris (gunakan <char-desc> hanya untuk deskripsi fisik). AKHIRI dengan blok ringkas: ID[brand/model/colors; features=...] | CAM[...] | LIGHT[...] | MOOD[...].",
      "image_to_video_prompt": "prompt I2V dalam Bahasa Inggris (khusus pergerakan, tanpa deskripsi fisik)",
      "negative_prompt": "negative prompt untuk kualitas gambar"
    }
  ]
}`}`,h=localStorage.getItem("direktiva_user_api_key"),f={"Content-Type":"application/json"};h&&(f["x-user-api-key"]=h);const g=await fetch("/api/generateScript",{method:"POST",headers:f,body:JSON.stringify({prompt:p,scriptCount:1,mode:"visual_regeneration"})});if(!g.ok)throw new Error("Failed to regenerate visual prompts");return(await g.json()).shots||[]}catch(n){return console.error("Error regenerating visual prompts:",n),null}}async function bt(t,e,a,n){function o(c){if(!c)return"";let l=String(c);return l=l.replace(/^\((?:brand|model|must_keep_colors)[^)]*\)\s*/i,""),l=l.replace(/\bbrand\s*=\s*[^,;]+[;,]?\s*/gi,""),l=l.replace(/\bmodel\s*=\s*[^,;]+[;,]?\s*/gi,""),l=l.replace(/\bmust_keep_colors\s*=\s*[^,;]+[;,]?\s*/gi,""),l=l.replace(/\|?\s*ID\[[^\]]*\]\s*/gi,""),l.trim()}function s(){var g,E;let c=null;try{c=JSON.parse(localStorage.getItem("direktiva_visual_dna_tokens")||"null")}catch{}const l=((g=m.visualDnaStorage)==null?void 0:g.textContent)||"",u=(c==null?void 0:c.brand)||(l.match(/brand\s*=\s*([^,;]+)/i)||[])[1]||"",y=(c==null?void 0:c.model)||(l.match(/model\s*=\s*([^,;]+)/i)||[])[1]||"",p=((E=c==null?void 0:c.colors)==null?void 0:E.join("|"))||(l.match(/must_keep_colors\s*=\s*([^,;]+)/i)||[])[1]||"",h=(Array.isArray(c==null?void 0:c.colors)?c.colors:p.split(/[|,\s]+/)).filter(k=>/^#?[0-9A-Fa-f]{3,6}$/.test(k)).slice(0,3),f=[];return u&&f.push(`brand=${u}`),y&&f.push(`model=${y}`),h.length&&f.push(`must_keep_colors=${h.map(k=>k.startsWith("#")?k:"#"+k).join("|")}`),f.join(", ")}function i(c,l){var k,L;const u=o(c),y=s();if(!y)return u;let p="";try{const b=JSON.parse(localStorage.getItem("direktiva_visual_features")||"[]"),P=na(l||"",b);Array.isArray(P)&&P.length?p=P.slice(0,4).join(", "):Array.isArray(b)&&b.length&&(p=b.slice(0,4).join(", "))}catch{}const h=`ID[${y}${p?`; features=${p}`:""}]`,f=((L=(k=m.inputs)==null?void 0:k.productName)==null?void 0:L.value)||"";let g="";try{const b=JSON.parse(localStorage.getItem("direktiva_visual_dna_tokens")||"null");oa(l||"",f,(b==null?void 0:b.brand)||"")&&(g=` | ${h}`)}catch{g=` | ${h}`}let E="";try{if(localStorage.getItem("visualStrategy")==="character"){const b=localStorage.getItem("direktiva_char_id")||"";b&&(E=` ${b}`)}}catch{}return`${u}${g}${E}`}function r(c){return Array.isArray(c)?c.map(l=>({...l,text_to_image_prompt:i((l==null?void 0:l.text_to_image_prompt)||"",(l==null?void 0:l.visual_idea)||""),image_to_video_prompt:((l==null?void 0:l.image_to_video_prompt)||"").replace(/<\/?char-desc>/gi,"")})):c}switch($(async()=>{const{showNotification:c}=await Promise.resolve().then(()=>X);return{showNotification:c}},void 0).then(({showNotification:c})=>{c(d("regenerating_visual_prompts")||"Meregenerasi prompt visual...","info")}),a){case"hook":if(e.hook){e.hook.text=n;const c=await He(e,"hook",n);c&&c.length>0&&(e.hook.shots=r(c))}break;case"body":if(e.body){e.body.text=n;const c=await He(e,"body",n);c&&c.length>0&&(e.body.shots=r(c))}break;case"body_intro":if(e.body){if(e.body_intro=n,e.body.text){const l=e.body.text.split(". ");l[0]=n,e.body.text=l.join(". ")}const c=await He(e,"body",e.body.text);c&&c.length>0&&(e.body.shots=r(c))}break;case"cta":if(e.cta){e.cta.text=n;const c=await He(e,"cta",n);c&&c.length>0&&(e.cta.shots=r(c))}break}t.dataset.script=JSON.stringify(e),ct(e),_a(t,e),$(async()=>{const{showNotification:c}=await Promise.resolve().then(()=>X);return{showNotification:c}},void 0).then(({showNotification:c})=>{const l=d("variant_applied_with_visuals")||`${a.toUpperCase()} dan prompt visual berhasil diperbarui!`;c(l,"success")})}function bs(t){var L;const e=t.querySelector(".export-btn"),a=t.querySelector(".export-menu"),n=JSON.parse(t.dataset.script);function o(b,P="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"){const _=document.createElement("button");return _.type="button",_.className=P,_.textContent=b,_}const s=document.createElement("div");s.className="border-t border-gray-100 my-1";const i=o(" Copy VO  Gemini Text"),r=o(" Copy VO  ElevenLabs SSML"),c=o(" Download VO Files"),l=o(" Preview Gemini (API)"),u=o(" Stop Audio");a.append(s,i,r,c,l,u);const y={tiktok:"tiktok_video",shopee:"shopee_video",instagram:"igreels",threads:"threads",shorts:"shorts"},p=(((L=document.getElementById("platform-target"))==null?void 0:L.value)||"tiktok").toLowerCase(),h={platform:y[p]||"tiktok_video",lang:(q==null?void 0:q.current)==="en"?"en":"id"},g=(b=>{var P,_,S;return{hook:((P=b==null?void 0:b.hook)==null?void 0:P.text)||(b==null?void 0:b.hook)||"",scenes:[((_=b==null?void 0:b.body)==null?void 0:_.text)||(b==null?void 0:b.body)||""],cta:((S=b==null?void 0:b.cta)==null?void 0:S.text)||(b==null?void 0:b.cta)||""}})(n),E=n!=null&&n.id?`script:${n.id}`:void 0;i.addEventListener("click",async()=>{await Hn(g,h),a.classList.add("hidden")}),r.addEventListener("click",async()=>{await jn(g,h),a.classList.add("hidden")}),c.addEventListener("click",()=>{Un(g,h),a.classList.add("hidden")}),l.addEventListener("click",()=>{Fn(g,h,"Kore",{button:l,cacheKey:E}),a.classList.add("hidden")}),u.addEventListener("click",()=>{Ea(),a.classList.add("hidden")}),e.addEventListener("click",b=>{b.stopPropagation(),document.querySelectorAll(".export-menu").forEach(P=>{P!==a&&P.classList.add("hidden")}),a.classList.toggle("hidden")}),document.addEventListener("click",b=>{t.contains(b.target)||a.classList.add("hidden")}),t.querySelector(".export-prompt-json").addEventListener("click",async()=>{const b=t.querySelector(".export-prompt-json");b.disabled=!0,b.classList.add("opacity-50");try{await Mn(n)}finally{b.disabled=!1,b.classList.remove("opacity-50"),a.classList.add("hidden")}}),t.querySelector(".export-prompt-csv").addEventListener("click",async()=>{const b=t.querySelector(".export-prompt-csv");b.disabled=!0,b.classList.add("opacity-50");try{await Rn(n)}finally{b.disabled=!1,b.classList.remove("opacity-50"),a.classList.add("hidden")}}),t.querySelector(".export-capcut-srt").addEventListener("click",async()=>{const b=t.querySelector(".export-capcut-srt");b.disabled=!0,b.classList.add("opacity-50");try{await Dn(n)}finally{b.disabled=!1,b.classList.remove("opacity-50"),a.classList.add("hidden")}}),t.querySelector(".export-capcut-csv").addEventListener("click",async()=>{const b=t.querySelector(".export-capcut-csv");b.disabled=!0,b.classList.add("opacity-50");try{await qn(n)}finally{b.disabled=!1,b.classList.remove("opacity-50"),a.classList.add("hidden")}});const k=t.querySelector(".export-all-zip-item");k&&k.addEventListener("click",async()=>{k.disabled=!0,k.classList.add("opacity-50");try{const{exportZipForScripts:b}=await $(async()=>{const{exportZipForScripts:P}=await Promise.resolve().then(()=>Ca);return{exportZipForScripts:P}},void 0);await b([n],!1)}catch{}finally{k.disabled=!1,k.classList.remove("opacity-50"),a.classList.add("hidden")}})}function Le(){try{const t=[...document.querySelectorAll(".result-card")];if(t.length<2){t.forEach(n=>{var o;return(o=n.querySelector(".best-of-all"))==null?void 0:o.remove()});return}let e=null,a=-1/0;if(t.forEach(n=>{const o=n.dataset.globalScore,s=Number(o);Number.isFinite(s)&&s>a&&(a=s,e=n)}),t.forEach(n=>{var o;return(o=n.querySelector(".best-of-all"))==null?void 0:o.remove()}),e){const n=document.createElement("span"),o=localStorage.getItem("direktiva_theme")||"dark";n.textContent=d("best_of_all")||"Best of All",n.className="best-of-all",n.style.marginLeft="6px",n.style.padding="2px 8px",n.style.borderRadius="9999px",n.style.fontSize="12px",n.style.lineHeight="1",n.style.display="inline-flex",n.style.alignItems="center",n.style.fontWeight="700",o==="light"?(n.style.backgroundColor="#fef3c7",n.style.border="1px solid #fde68a",n.style.color="#92400e"):(n.style.backgroundColor="rgba(234,179,8,0.20)",n.style.border="1px solid rgba(234,179,8,0.35)",n.style.color="#fde68a");const s=e.querySelector(".result-title");if(s){const i=s.firstChild&&s.firstChild.nodeType===Node.ELEMENT_NODE?s.firstChild:null;s.style.display="inline-flex",s.style.alignItems="baseline",s.style.flexWrap="wrap",s.style.gap="8px",i?s.insertBefore(n,i.nextSibling):s.appendChild(n)}}}catch{}}var Va;try{(Va=document.getElementById("rank-all-btn"))==null||Va.addEventListener("click",()=>{try{Le()}catch{}})}catch{}async function Ae(t,e){var y,p,h;const a=document.getElementById("script-viewer-modal"),n=document.getElementById("script-viewer-content");if(!a||!n)return;try{const f=fe&&typeof fe=="function"?fe().find(g=>g.id===(e==null?void 0:e.id)):null;f&&(e=f)}catch{}const o=f=>(f||"").toString();let s=0;try{const f=await Promise.all([...(e.hook_variants||[]).map(L=>pe(L)),pe(((y=e.hook)==null?void 0:y.text)||e.hook||"")]),g=[...(e.cta_variants||[]).map(L=>ve(L)),ve(((p=e.cta)==null?void 0:p.text)||e.cta||"")],E=(((h=e.body)==null?void 0:h.text)||e.body||"").toString().split(`
`)[0]||"",k=await Promise.all([...(e.body_variants||[]).map(L=>re(L)),re(E)]);s=Gn(f,k,g,e)}catch{s=65}const r=(localStorage.getItem("direktiva_theme")||"dark")==="light"?"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-800 border border-emerald-300":"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-200 text-emerald-900 border border-emerald-300";let c=`<div class="mb-4 flex items-center justify-between"><h3 class="text-xl font-bold">${o(e.title)}</h3><span class="${r}" data-tooltip><span>Score ${s}</span><span class="tooltip-hint">${d("score_tooltip")||"Skor gabungan dari Hook/Body/CTA"}</span></span></div>`;c+=`
  <div class="mb-4 flex items-center gap-2">
    <button class="overlay-copy-btn px-3 py-1.5 text-xs rounded bg-gray-700 text-white hover:bg-gray-600" data-tooltip><span>${d("copy_full_script")||"Copy Full Script"}</span><span class="tooltip-hint">${d("copy_tooltip")||"Salin semua teks skrip"}</span></button>
    <div class="relative">
      <button class="overlay-export-btn px-3 py-1.5 text-xs rounded bg-blue-600 text-white hover:bg-blue-700" data-tooltip><span>${d("export_button")||"Export"}</span><span class="tooltip-hint">${d("export_tooltip")||"Export ke berbagai format"}</span></button>
      <div class="overlay-export-menu hidden absolute right-0 mt-1 w-48 bg-gray-900 border border-gray-700 rounded shadow-lg z-10">
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="prompt-json">Prompt Pack (JSON)</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="prompt-csv">Prompt Pack (CSV)</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="capcut-srt">CapCut (SRT)</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="capcut-csv">CapCut (CSV)</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="zip-single">Export This (ZIP)</button>
        <div class="border-t border-gray-800 my-1"></div>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="vo-copy-gemini"> Copy VO  Gemini Text</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="vo-copy-ssml"> Copy VO  ElevenLabs SSML</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="vo-download"> Download VO Files</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="vo-prev-gemini"> Preview Gemini (API)</button>
        <button class="overlay-export-item block w-full text-left px-3 py-2 text-xs hover:bg-gray-800" data-type="vo-stop"> Stop Audio</button>
      </div>
    </div>
    <button class="overlay-edit-btn px-3 py-1.5 text-xs rounded bg-yellow-600 text-white hover:bg-yellow-700" data-tooltip><span>${d("edit_button")||"Edit"}</span><span class="tooltip-hint">${d("edit_tooltip")||"Edit teks skrip & regenerasi visual"}</span></button>
  </div>`;const l=(f,g,E)=>{if(!E)return"";let k=`<div class="mb-4"><div class="flex items-center justify-between mb-2"><h4 class="font-semibold">${g}</h4><button class="overlay-section-copy-btn px-2 py-1 text-xs rounded bg-gray-700 text-white hover:bg-gray-600" data-section="${f}">${d("copy_button")||"Copy"}</button></div>`;k+=`<p class="mb-2 whitespace-pre-wrap">${o(E.text||E)}</p>`;const L=E.shots||[];return Array.isArray(L)&&L.length&&(k+='<div class="space-y-2">',L.forEach((b,P)=>{k+=`<div class="p-3 rounded bg-gray-900/40 border border-gray-700/40"><div class="text-xs text-gray-300"><strong>${d("visual_idea_label")||"Ide Visual"} ${P+1}:</strong> ${o(b.visual_idea)}</div><div class="text-xs text-gray-400 mt-1 flex items-center gap-2"><strong>${d("t2i_prompt_label")||"Image Prompt"}:</strong><span class="prompt-t2i-display">${o(b.text_to_image_prompt)}</span><button class="prompt-howto-btn flex-shrink-0" data-type="t2i" data-tooltip><div class="icon icon-sm icon-info text-gray-500 hover:text-white"></div><span class="tooltip-hint">${d("t2i_tooltip_models")||""}</span></button><button class="prompt-copy-btn flex-shrink-0" data-prompt="${o(b.text_to_image_prompt).replace(/\\/g,"\\\\").replace(/\"/g,"&quot;")}"><div class="icon icon-sm icon-copy text-gray-500 hover:text-white"></div></button></div><div class="text-xs text-gray-400 mt-1 flex items-center gap-2"><strong>${d("i2v_prompt_label")||"Video Prompt"}:</strong><span class="prompt-i2v-display">${o(b.image_to_video_prompt)}</span><button class="prompt-howto-btn flex-shrink-0" data-type="i2v" data-tooltip><div class="icon icon-sm icon-info text-gray-500 hover:text-white"></div><span class="tooltip-hint">${d("i2v_tooltip_models")||""}</span></button><button class="prompt-copy-btn flex-shrink-0" data-prompt="${o(b.image_to_video_prompt).replace(/\\/g,"\\\\").replace(/\"/g,"&quot;")}"><div class="icon icon-sm icon-copy text-gray-500 hover:text-white"></div></button></div></div>`}),k+="</div>"),k+="</div>",k};if(e.character_sheet&&e.character_sheet.length&&(c+=`<div class="mb-4"><h4 class="font-semibold mb-2">${d("character_sheet_title")||"Character Sheet"}</h4>`,e.character_sheet.forEach((f,g)=>{c+=`<div class="text-xs text-gray-300 mb-1">${d("character_label")||"Karakter"} ${g+1}: ${o((f.name||"")+" "+(f.age||""))}</div>`}),c+="</div>"),!e.slides)c+=l("hook",d("hook_title")||"Hook",e.hook),c+=l("body",d("body_title")||"Body",e.body),c+=l("cta",d("cta_title")||"CTA",e.cta);else{const f=(e.slides||[]).map((g,E)=>ya(g,E)).join("");c+=`
      <div class="mb-4">
        <h4 class="font-semibold mb-2">${d("slides_title")||"Slides"}</h4>
        <div class="swiper carousel-swiper-container bg-gray-900/40 p-4 rounded-lg border border-gray-800/40">
          <div class="swiper-wrapper">${f}</div>
          <div class="swiper-pagination !bottom-2"></div>
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
        </div>
      </div>`}n.innerHTML=c;try{n.dataset.script=JSON.stringify(e)}catch{}try{const f=await Kn(e);f&&n.insertAdjacentHTML("beforeend",f)}catch{}try{n.insertAdjacentHTML("beforeend",fa(e));try{if(e.additional_assets_html){const f=n.querySelector(".additional-assets-container"),g=n.querySelector(".asset-loader"),E=n.querySelector(".asset-content");f==null||f.classList.remove("hidden"),g==null||g.classList.add("hidden"),E&&(E.classList.remove("hidden"),E.innerHTML=e.additional_assets_html)}}catch{}}catch{}n.onclick=async f=>{var A,R,M,B;const g=f.target.closest(".overlay-export-btn");if(g){const O=g.parentElement.querySelector(".overlay-export-menu");O&&O.classList.toggle("hidden");try{const I=g.querySelector(".tooltip-hint");I&&(I.style.display="none")}catch{}return}const E=f.target.closest(".overlay-export-item");if(E){try{const I=E.dataset.type;if(I==="prompt-json")await Mn(e);else if(I==="prompt-csv")await Rn(e);else if(I==="capcut-srt")await Dn(e);else if(I==="capcut-csv")await qn(e);else if(I==="zip-single"){const{exportZipForScripts:N}=await $(async()=>{const{exportZipForScripts:F}=await Promise.resolve().then(()=>Ca);return{exportZipForScripts:F}},void 0);await N([e],!1)}else if(I==="vo-copy-gemini"||I==="vo-copy-ssml"||I==="vo-download"||I==="vo-prev-gemini"||I==="vo-stop"){const N={tiktok:"tiktok_video",shopee:"shopee_video",instagram:"igreels",threads:"threads",shorts:"shorts"},F=(((A=document.getElementById("platform-target"))==null?void 0:A.value)||"tiktok").toLowerCase(),Y={platform:N[F]||"tiktok_video",lang:(q==null?void 0:q.current)==="en"?"en":"id"},Z=(G=>{var Ne,be,Se;return{hook:((Ne=G==null?void 0:G.hook)==null?void 0:Ne.text)||(G==null?void 0:G.hook)||"",scenes:[((be=G==null?void 0:G.body)==null?void 0:be.text)||(G==null?void 0:G.body)||""],cta:((Se=G==null?void 0:G.cta)==null?void 0:Se.text)||(G==null?void 0:G.cta)||""}})(e),ge=e!=null&&e.id?`script:${e.id}`:void 0;I==="vo-copy-gemini"?await Hn(Z,Y):I==="vo-copy-ssml"?await jn(Z,Y):I==="vo-download"?Un(Z,Y):I==="vo-prev-gemini"?await Fn(Z,Y,"Kore",{button:E,cacheKey:ge}):I==="vo-stop"&&Ea()}}catch{}const O=f.target.closest(".overlay-export-menu");O==null||O.classList.add("hidden");return}const k=n.querySelector(".overlay-export-menu:not(.hidden)");k&&!f.target.closest(".overlay-export-menu")&&!f.target.closest(".overlay-export-btn")&&k.classList.add("hidden");const L=f.target.closest(".overlay-copy-btn");if(L){try{Ee(Te(e),L)}catch{}return}if(f.target.closest(".overlay-edit-btn")){try{ta(t);const O=document.getElementById("edit-modal"),I=document.getElementById("script-viewer-modal");O&&(O.style.zIndex="1001"),I&&(I.style.zIndex="1000")}catch{}return}const P=f.target.closest(".overlay-section-copy-btn");if(P){try{const O=P.dataset.section;let I="";O==="hook"?I=(((R=e.hook)==null?void 0:R.text)||e.hook||"").toString():O==="body"?I=(((M=e.body)==null?void 0:M.text)||e.body||"").toString():O==="cta"&&(I=(((B=e.cta)==null?void 0:B.text)||e.cta||"").toString()),Ee(I,P)}catch{}return}const _=f.target.closest(".prompt-copy-btn");if(_){const I=(_.dataset.prompt||"").replace(/<\/?char-desc>/gi,"");try{Ee(I,_)}catch{}return}const S=f.target.closest(".prompt-howto-btn");if(S){Ss(S.dataset.type==="i2v"?"i2v":"t2i");return}if(f.target.closest(".generate-assets-btn")){try{const{handleGenerateAssets:O}=await $(async()=>{const{handleGenerateAssets:I}=await Promise.resolve().then(()=>xs);return{handleGenerateAssets:I}},void 0);await O(n.closest(".result-card")||n)}catch{}return}const C=f.target.closest(".use-best-btn"),D=f.target.closest(".use-variant-btn"),w=f.target.closest(".shorten-btn");if(C){await Ia(t,e,C.dataset.section),Ae(t,e);return}if(D){await La(t,e,D.dataset.section,parseInt(D.dataset.index)),Ae(t,e);return}if(w){await Aa(t,e,w.dataset.section,parseInt(w.dataset.index)),Ae(t,e);return}};try{e.slides&&ha("#script-viewer-content .carousel-swiper-container")}catch{}a.classList.remove("opacity-0","pointer-events-none");const u=document.getElementById("script-viewer-close");a.__bound||(a.__bound=!0,u==null||u.addEventListener("click",()=>{a.classList.add("opacity-0","pointer-events-none")}),a.addEventListener("click",f=>{f.target===a&&a.classList.add("opacity-0","pointer-events-none")}),window.addEventListener("keydown",f=>{f.key==="Escape"&&a.classList.add("opacity-0","pointer-events-none")}))}function Ss(t){try{const e=document.getElementById("howto-modal"),a=document.getElementById("howto-body");if(!e||!a)return;const n=t!=="i2v",o=c=>`<div class="flex flex-wrap gap-2 mt-2">${c.map(l=>`<span class="px-2 py-0.5 text-xs rounded bg-gray-700 text-white border border-gray-600">${l}</span>`).join("")}</div>`,s=n?["Leonardo","Flux","Imagen","Gemini"]:["Pika","Runway","Veo"],i=(c,l,u="")=>`
      <div class="mb-4">
        <div class="text-sm font-semibold text-blue-300">${c}</div>
        <div class="text-sm text-gray-300">${l}</div>
        ${u}
      </div>`,r=[i(d("howto_step1_title")||"Open the App",n?d("howto_step1_desc_t2i")||"Open Leonardo, Flux, Imagen, or Gemini Image.":d("howto_step1_desc_i2v")||"Open Pika, Runway, or Google Veo.",o(s)),i(d("howto_step2_title")||"Paste the Prompt",n?d("howto_step2_desc_t2i")||"Paste the Image Prompt. Keep <char-desc> tags for physical details.":d("howto_step2_desc_i2v")||"Paste the Video Prompt. Do NOT include <char-desc> tags."),i(d("howto_step3_title")||"Set Parameters",n?d("howto_params_t2i")||"Steps 2840, CFG 69, 9:16, DPM++, random seed.":d("howto_params_i2v")||"Duration 35s, FPS 2430, Motion medium, 9:16.")].join("");if(a.innerHTML=`
      <div class="mb-3 text-sm font-semibold">${n?d("howto_t2i")||"Use the Image Prompt":d("howto_i2v")||"Use the Video Prompt"}</div>
      ${r}`,e.classList.remove("opacity-0","pointer-events-none"),!e.__bound){e.__bound=!0;const c=document.getElementById("howto-close");c==null||c.addEventListener("click",()=>{e.classList.add("opacity-0","pointer-events-none")}),e.addEventListener("click",l=>{l.target===e&&e.classList.add("opacity-0","pointer-events-none")}),window.addEventListener("keydown",l=>{l.key==="Escape"&&e.classList.add("opacity-0","pointer-events-none")})}}catch{}}const Fe=Object.freeze(Object.defineProperty({__proto__:null,applyVariantToScript:bt,attachABVariantsListeners:vs,attachExportListeners:bs,createABVariantsHTML:Kn,createResultCard:Yn,createVariantSection:qe,openScriptViewer:Ae,regenerateVisualPrompts:He,renderError:xa,renderResults:Vn,scoreBodyIntro:re,scoreCTA:ve,scoreHook:pe,shorten:Jn,updateGlobalBestBadge:Le,useBestVariant:Ia,useShortenedVariant:Aa,useSpecificVariant:La},Symbol.toStringTag,{value:"Module"})),ks={tiktok:{aspect:"9:16",maxDuration:23,cutsEverySec:.8,retentionHooksEvery:4,beatMap:[{t:0,action:"HOOK_PATTERN_INTERRUPT",textMaxWords:6},{t:3,action:"PROOF/DEMO_QUICK"},{t:7,action:"BENEFIT_1 + ON-SCREEN CAPTION"},{t:12,action:"BENEFIT_2 + B-ROLL"},{t:18,action:"MICRO_LOOP_SETUP"},{t:21,action:"CTA_SUPER_SHORT"}],caption:{maxChars:150,hashtagPolicy:{total:3,mix:["2 broad","1 niche"]}},audio:{useTrending:!0,fallback:"original"},cta:{style:"ultra-short",placement:"t=21-23"},commentBait:["Mau versi murahnya? ketik 'MURAH'"]},shopee:{aspect:"9:16",maxDuration:35,scriptMode:"DTC_SHORT + LIVE_MACROS",blocks:["ANCHOR_PRICE","USP_TRIPLE","TRUST_PROOF","URGENCY_TIMER","CTA_VOUCHER"],objections:["kualitas","kecepatan kirim","COD","garansi"],liveMacros:["Tanya warna: 'Hitam/Putih?'","Ketik 'BELI' untuk voucher"],cta:{copyID:"CTA_SHOPEE_BUY_NOW",mentions:["Voucher","Gratis Ongkir","COD"]},deepLink:!0},instagram:{targets:["reels","carousel","story"],reels:{aspect:"9:16",maxDuration:29,aestheticsFirst:!0,safeZones:["avoid bottom 15% for UI"],caption:{mode:"save/share oriented",includes:["line breaks","1 question"]},coverFrame:"auto-pick best frame at t0.5s",cta:{goal:"SAVE+SHARE",copy:"Save this for later"}},carousel:{slides:7,structure:["Slide1 HOOK big text","Slide2-6 value bites","Slide7 CTA save/share"],fontMaxWordsPerSlide:12}},threads:{threadLen:{min:3,max:7},tone:"conversational",ending:"open_question",media:{allowImage:!0,clipUnder10s:!0},caption:{skimmable:!0,lineBreaks:!0}},shorts:{aspect:"9:16",maxDuration:58,pacing:"fast",retentionHooksEvery:4,cta:{placement:"last 2s",copy:"Subscribe for the next tip"},commentsPinTemplate:"Link & resources in the pinned comment"}};function ws(t,e="id",a="post"){var h,f;const n=ks[t];if(!n)return{promptNotes:"",beats:[],cta:{},commentBait:[],meta:{},cfg:{}};const o=a==="carousel";let s=n;t==="instagram"&&(s=o?n.carousel||n:n.reels||n);const i=e==="en",r=[];if(!o)s.aspect&&r.push(`${i?"Aspect":"Rasio"}: ${s.aspect}`),s.maxDuration&&r.push(`${i?"Target duration":"Durasi target"}  ${s.maxDuration}s`),s.pacing&&r.push(`${i?"Pacing":"Tempo"}: ${s.pacing}`),s.cutsEverySec&&r.push(`${i?"Cut cadence":"Frekuensi cut"}  ${s.cutsEverySec} cut/s`),s.safeZones&&r.push(`${i?"Safe-zones":"Area aman"}: ${Array.isArray(s.safeZones)?s.safeZones.join(", "):s.safeZones}`),(h=s.caption)!=null&&h.mode&&r.push(`Caption: ${s.caption.mode}`),s.retentionHooksEvery&&r.push(`${i?"Retention hook every":"Hook retensi tiap"} ${s.retentionHooksEvery}s`);else{const g=s.slides||7;r.push(`${i?"Slides":"Jumlah slide"}: ${g}`),s.fontMaxWordsPerSlide&&r.push(`${i?"Max words/slide":"Maks kata/slide"}: ${s.fontMaxWordsPerSlide}`),s.structure&&r.push(`${i?"Structure":"Struktur"}: ${s.structure.join("  ")}`)}const c=r.length?`
- ${r.join(`
- `)}`:"",l=o?[]:s.beatMap||s.blocks||[],u=s.cta||{},y=s.commentBait||[],p=o?{slides:s.slides||7,fontMaxWordsPerSlide:s.fontMaxWordsPerSlide||12}:{hashtags:((f=s.caption)==null?void 0:f.hashtagPolicy)||null,audio:s.audio||null,deepLink:s.deepLink||!1,coverFrame:s.coverFrame||null};return{promptNotes:c,beats:l,cta:u,commentBait:y,meta:p,cfg:s}}async function Xe(t){try{return await t.clone().json()}catch{try{const a=await t.text();return a?JSON.parse(a):null}catch{return null}}}let Re=null;async function $t(t,e,a=""){try{try{Re==null||Re.abort()}catch{}Re=new AbortController;const{signal:n}=Re,o=localStorage.getItem("direktiva_user_api_key"),s={"Content-Type":"application/json"};o&&(s["x-user-api-key"]=o);const i=await fetch("/api/analyzeImage",{method:"POST",headers:s,body:JSON.stringify({base64Data:t,mimeType:e,mode:"fullDescription",focusLabel:a}),signal:n});if(!i.ok){const k=await Xe(i),L=(k==null?void 0:k.error)||i.statusText||"Terjadi kesalahan";throw new Error(`Tahap 1 Gagal: ${L}`)}const r=await Xe(i);if(!r||!r.description)throw new Error(d("notification_image_analysis_error")||"Image analysis error");const{description:c,palette:l,brand_guess:u,model_guess:y,ocr_text:p,distinctive_features:h}=r,f=await fetch("/api/analyzeImage",{method:"POST",headers:s,body:JSON.stringify({textData:{description:c,palette:l,brand_guess:u,model_guess:y,ocr_text:p,distinctive_features:h,focusLabel:a},mode:"extractKeywords",focusLabel:a}),signal:n});if(!f.ok){const k=await Xe(f),L=(k==null?void 0:k.error)||f.statusText||"Terjadi kesalahan";throw new Error(`Tahap 2 Gagal: ${L}`)}const g=await Xe(f);if(!g||!g.keywords)throw new Error(d("notification_image_analysis_error")||"Image analysis error");const{keywords:E}=g;return{description:c,palette:l,brand_guess:u,model_guess:y,ocr_text:p,distinctive_features:h,keywords:E}}catch(n){throw(n==null?void 0:n.name)==="AbortError"||console.error("Error dalam proses analisis gambar 2 tahap:",n),n}}const Da=Number(localStorage.getItem("direktiva_timeout_ms"))||12e4;async function Ge(t,e,a,n=Da){let o;const s=async(u,y="warning",p=4e3)=>{try{o||(o=(await $(()=>Promise.resolve().then(()=>X),void 0)).showNotification),o(u,y,p)}catch{}},i=u=>new Promise(y=>setTimeout(y,u)),r={"Content-Type":"application/json"};try{const{data:{session:u}}=await x.auth.getSession();u!=null&&u.access_token&&(r.Authorization=`Bearer ${u.access_token}`)}catch{}const c=localStorage.getItem("direktiva_user_api_key");c&&(r["x-user-api-key"]=c);const l=Math.max(1,Number(localStorage.getItem("direktiva_retry_max"))||3);for(let u=1;u<=l;u++)try{const y=new AbortController,p=setTimeout(()=>y.abort(new DOMException("timeout","AbortError")),n),h=await fetch("/api/generateScript",{method:"POST",headers:r,body:JSON.stringify({prompt:t,schema:e,temperature:a}),signal:y.signal});if(clearTimeout(p),!h.ok){let f=d("notification_api_error")||"Terjadi kesalahan pada server.",g=!1;try{const k=await h.json();k!=null&&k.error&&(f=k.error)}catch{}const E=String(f||"").toLowerCase();if(g=h.status===429||h.status===503||/overloaded|exhausted|busy|quota|temporar/i.test(E),g&&u<l){const k=Math.min(15e3,1500*Math.pow(2,u-1)+Math.floor(Math.random()*500));await s((d("model_overloaded_retry")||"Model penuh, mencoba lagi...")+` (${u}/${l})`),await i(k);continue}throw new Error(f)}return await h.json()}catch(y){if((y==null?void 0:y.name)==="AbortError"){const f=Math.round((n||Da)/1e3),g=new Error(`Request timeout after ${f}s. Server lambat atau antrian penuhcoba lagi atau naikkan timeout.`);throw g.code="TIMEOUT",g}const p=String((y==null?void 0:y.message)||"").toLowerCase();if(/overloaded|exhausted|busy|temporar|network|fetch/i.test(p)&&u<l){const f=Math.min(15e3,1500*Math.pow(2,u-1)+Math.floor(Math.random()*500));await s((d("model_overloaded_retry")||"Model penuh, mencoba lagi...")+` (${u}/${l})`),await i(f);continue}throw console.error("Error calling backend function:",y),y}}function Es(){return{type:"OBJECT",properties:{titles:{type:"ARRAY",items:{type:"STRING"},minItems:3,maxItems:3},platform:{type:"STRING",enum:["tiktok","instagram_reels","youtube_shorts","shopee"]},hashtags:{type:"ARRAY",items:{type:"STRING"}},platform_hashtags:{type:"OBJECT",properties:{tiktok:{type:"ARRAY",items:{type:"STRING"}},instagram_reels:{type:"ARRAY",items:{type:"STRING"}},youtube_shorts:{type:"ARRAY",items:{type:"STRING"}},shopee:{type:"ARRAY",items:{type:"STRING"}}}},trending_tags:{type:"ARRAY",items:{type:"STRING"}},thumbnail_ideas:{type:"ARRAY",items:{type:"STRING"},minItems:3,maxItems:3}},required:["titles","hashtags","thumbnail_ideas"]}}const Ve={hooksConfig:null,ctaMapping:null,hookInstructions:null,ctaInstructions:null,async init(){const t=(await $(async()=>{const{default:o}=await import("./hooks_config-dN3H1HBZ.js");return{default:o}},[])).default,e=(await $(async()=>{const{default:o}=await import("./cta_mapping-COptbEKR.js");return{default:o}},[])).default,a=(await $(async()=>{const{default:o}=await import("./instructions.hooks-DfQTWXag.js");return{default:o}},[])).default,n=(await $(async()=>{const{default:o}=await import("./instructions.cta-C7HH3H5D.js");return{default:o}},[])).default;this.hooksConfig=t,this.ctaMapping=e,this.hookInstructions=a,this.ctaInstructions=n},suggestCtas(t,e){var a,n;return((n=(a=this.ctaMapping)==null?void 0:a[t])==null?void 0:n[e])||[]},getHookInstruction(t,e="id"){var a,n;return((n=(a=this.hookInstructions)==null?void 0:a[t])==null?void 0:n[e])||null},getCtaInstruction(t,e="id"){var a,n;return((n=(a=this.ctaInstructions)==null?void 0:a[t])==null?void 0:n[e])||null},listHookGroups(){var t;return((t=this.hooksConfig)==null?void 0:t.categories)||[]},listFormats(){var t;return((t=this.hooksConfig)==null?void 0:t.formats)||[]}};localStorage.getItem("visualStrategy");let Vt=localStorage.getItem("aspectRatio")||"9:16",Ze=0;function zn(t){const e=q.current==="en"?"en":"id",a=Ve.getHookInstruction(t,e);return a||(console.warn("[HookInstructions] Missing for:",t),e==="en"?"Create a strong scrol-stopping hook in the first 3 seconds. Keep it concrete and audience-specific.":"Buat hook kuat yang menghentikan scroll dalam 3 detik pertama. Harus konkret dan spesifik untuk audiens.")}function Wn(t){const e=q.current==="en"?"en":"id",a=Ve.getCtaInstruction(t,e);return a||(console.warn("[CTAInstructions] Missing for:",t),e==="en"?"Use a clear, actionable CTA that tells exactly what to do next.":"Gunakan CTA yang jelas dan langsung mengarahkan langkah berikutnya.")}function Xn(){const{productName:t,productDesc:e}=m.inputs;return t.value.trim()?e.value.trim()?null:d("notification_product_desc_empty")||"Deskripsi produk tidak boleh kosong!":d("notification_product_name_empty")||"Nama produk tidak boleh kosong!"}async function Zn(t){var l;const e=++Ze,a=t.target.files[0];if(!a)return;if(a.size>5*1024*1024){v(d("notification_image_size_error")||"Image size too large","error");return}m.imageLoader.classList.remove("hidden"),m.imageHelper.textContent=d("analyzing_image")||"Analyzing image...",m.visualDnaStorage.textContent="",m.imagePreviewContainer.classList.add("hidden");try{m.generateBtn.disabled=!0}catch{}let n=a,o="",s=null,i=null,r=!1;const c=[];try{const u=document.getElementById("image-cropper-modal"),y=document.getElementById("cropper-target"),p=document.getElementById("cropper-use-btn"),h=document.getElementById("cropper-skip-btn");if(u&&y&&window.Cropper){o=URL.createObjectURL(a),y.src=o,u.classList.remove("opacity-0","pointer-events-none"),(l=u.querySelector(".modal-content"))==null||l.classList.remove("scale-95");const _=document.createElement("div");_.style.display="flex",_.style.gap="8px",_.style.margin="8px 0",_.style.flexWrap="wrap";const S=document.createElement("div");S.className="text-xs text-gray-300",S.textContent=q.current==="en"?"Crop mode: choose Single product or Multi areas":"Mode crop: pilih Satu produk atau Multi area";const T=document.createElement("button");T.type="button",T.className="px-2 py-1 rounded bg-blue-600 text-white text-xs",T.textContent=q.current==="en"?"Single Crop":"Satu Produk";const C=document.createElement("button");C.type="button",C.className="px-2 py-1 rounded bg-emerald-600 text-white text-xs",C.textContent=(q.current==="en","Multi Crop"),_.append(S,T,C);const D=u.querySelector(".modal-content")||u;D.insertBefore(_,D.firstChild),await new Promise(A=>{const R=O=>{r=!!O,T.removeEventListener("click",M),C.removeEventListener("click",B),_.remove(),A()},M=()=>R(!1),B=()=>R(!0);T.addEventListener("click",M,{once:!0}),C.addEventListener("click",B,{once:!0})}),await new Promise(A=>setTimeout(A,50));try{s==null||s.destroy()}catch{}s=new window.Cropper(y,{viewMode:1,movable:!0,zoomable:!0,dragMode:"move",autoCropArea:.88,background:!1,responsive:!0});try{r?(p.textContent=q.current==="en"?"Add Area":"Tambah Area",h.textContent=q.current==="en"?"Done":"Selesai"):(p.textContent=q.current==="en"?"Use Crop":"Gunakan Crop",h.textContent=q.current==="en"?"Continue without Crop":"Lanjut tanpa crop")}catch{}const w=()=>{try{s==null||s.destroy()}catch{}s=null,u.classList.add("opacity-0","pointer-events-none");try{u.querySelector(".modal-content").classList.add("scale-95")}catch{}};await new Promise(A=>{const R=async()=>{if(!s)return;const B=s.getCroppedCanvas({imageSmoothingEnabled:!0,imageSmoothingQuality:"high"}),O=await new Promise(I=>B.toBlob(I,a.type||"image/jpeg",.92));if(O){const I=B.toDataURL(a.type||"image/jpeg",.92);if(i||(i=I),r){c.push(I);try{v(q.current==="en"?"Area added":"Area ditambahkan","success",1500)}catch{}return}else n=new File([O],a.name,{type:a.type||"image/jpeg"}),p.removeEventListener("click",R),h.removeEventListener("click",M),w(),A()}},M=async()=>{p.removeEventListener("click",R),h.removeEventListener("click",M),w(),A()};p&&p.addEventListener("click",R),h&&h.addEventListener("click",M)})}const f=new FileReader;f.onload=_=>{m.imagePreview.src=_.target.result,m.imagePreviewContainer.classList.remove("hidden")},f.readAsDataURL(n);let g=null;const E=(m.inputs.productName.value||"").trim();if(r&&c.length>0){const _=c[0].split(",")[1];g=await $t(_,a.type||"image/jpeg",E);for(let S=1;S<c.length;S++){const T=c[S].split(",")[1],C=await $t(T,a.type||"image/jpeg",E),D=Array.from(new Set([...g.palette||[],...C.palette||[]])).slice(0,6),w=[g.keywords,C.keywords].filter(Boolean).join(", "),A=Array.from(new Set([...g.distinctive_features||[],...C.distinctive_features||[]])),R=g.brand_guess||C.brand_guess||"",M=g.model_guess||C.model_guess||"";g={...g,palette:D,keywords:w,distinctive_features:A,brand_guess:R,model_guess:M}}m.imagePreview.src=c[0],m.imagePreviewContainer.classList.remove("hidden")}else{const _=await Ka(n);g=await $t(_,n.type,E)}if(e!==Ze)return;try{const _={brand:g.brand_guess||"",model:g.model_guess||"",colors:Array.isArray(g.palette)?g.palette.slice(0,3):[]};localStorage.setItem("direktiva_visual_dna_tokens",JSON.stringify(_)),Array.isArray(g.distinctive_features)&&localStorage.setItem("direktiva_visual_features",JSON.stringify(g.distinctive_features.slice(0,12)))}catch{}const k=[g.brand_guess?`brand=${g.brand_guess}`:"",g.model_guess?`model=${g.model_guess}`:"",Array.isArray(g.palette)&&g.palette.length?`must_keep_colors=${g.palette.slice(0,3).join("|")}`:""].filter(Boolean).join(", "),L=Array.isArray(g.distinctive_features)?g.distinctive_features.join(", "):"",b=Array.isArray(g.ocr_text)?g.ocr_text.join(" "):"",P=[k,g.keywords,L,b].filter(Boolean).join(", ");m.visualDnaStorage.textContent=P,localStorage.setItem("productColorPalette",JSON.stringify(g.palette)),v(d("notification_image_analysis_success")||"Image analysis successful"),m.imageHelper.textContent=`${n.name} ${d("analysis_complete")||"analysis complete"}`}catch(u){(u==null?void 0:u.name)!=="AbortError"&&(console.error("Error during image analysis:",u),e===Ze&&(v(`${d("notification_image_analysis_error")||"Image analysis error"} ${u.message}`,"error"),Ta()))}finally{if(o)try{URL.revokeObjectURL(o)}catch{}if(e===Ze){m.imageLoader.classList.add("hidden");try{m.generateBtn.disabled=!1}catch{}}}}function Ta(){m.inputs.productImage.value="",m.imagePreview.src="",m.imagePreviewContainer.classList.add("hidden"),m.visualDnaStorage.textContent="",localStorage.removeItem("productColorPalette"),m.imageHelper.textContent=d("image_helper_text")||"Upload product image for better analysis";try{m.generateBtn.disabled=!1}catch{}}async function Qn(){var o,s,i;const t=Xn();if(t){v(t,"error");return}try{const r=parseInt(((o=document.getElementById("script-count"))==null?void 0:o.value)||"1",10),c=document.getElementById("results-toolbar");if(c){const l=r>1;c.classList.toggle("hidden",!l);try{c.style.display=l?"flex":"none"}catch{}}}catch{}const e=document.querySelector(".progress-bar"),a=document.querySelector(".progress-bar-fill");e&&(e.classList.remove("hidden"),a.style.width="0%"),z(!0,m.generateBtn),m.downloadAllContainer.classList.add("hidden");const n=document.getElementById("results-container");if(n){n.innerHTML="";const r=parseInt(document.getElementById("script-count").value)||3;for(let c=0;c<r;c++){const l=document.getElementById("skeleton-card-template");if(l){const u=l.content.cloneNode(!0);n.appendChild(u)}}}try{a&&(a.style.width="20%");const r=eo(),c=document.getElementById("creative-freedom"),l=c?parseFloat(c.value):.7;a&&(a.style.width="40%");const u=Number(localStorage.getItem("direktiva_timeout_ms"))||18e4;let y=await Ge(r,_e(),l,u);if(a&&(a.style.width="80%"),!y||y.length===0)throw new Error(d("notification_script_generation_error")||"Error generating script");const p=parseInt(((s=document.getElementById("script-count"))==null?void 0:s.value)||"1",10),h=w=>(w||"").toString().toLowerCase().replace(/\s+/g," ").replace(/[\-_,.;:!?"'`~()\[\]{}]/g,"").trim(),f=w=>{var A,R,M;return[h(((A=w==null?void 0:w.hook)==null?void 0:A.text)||(w==null?void 0:w.hook)||""),h(((R=w==null?void 0:w.body)==null?void 0:R.text)||(w==null?void 0:w.body)||""),h(((M=w==null?void 0:w.cta)==null?void 0:M.text)||(w==null?void 0:w.cta)||"")].join("|")},g=new Map;if(y.forEach(w=>{const A=f(w);g.has(A)||g.set(A,w)}),g.size<p){const w=Array.from(g.values()).map(I=>{var N;return((N=I==null?void 0:I.hook)==null?void 0:N.text)||(I==null?void 0:I.hook)||""}).filter(Boolean).slice(0,8),A=Array.from(g.values()).map(I=>{var N;return((N=I==null?void 0:I.body)==null?void 0:N.text)||(I==null?void 0:I.body)||""}).filter(Boolean).slice(0,8),R=Array.from(g.values()).map(I=>{var N;return((N=I==null?void 0:I.cta)==null?void 0:N.text)||(I==null?void 0:I.cta)||""}).filter(Boolean).slice(0,8),M=q.current==="en"?`
- DIVERSITY RULE: Each variation MUST be clearly different in angle, wording, and structure.
- STRICTLY AVOID reusing these exact texts (as-is) for any part:
HOOK_AVOID: ${w.join(" || ")}
BODY_AVOID: ${A.join(" || ")}
CTA_AVOID: ${R.join(" || ")}`:`
- ATURAN KERAGAMAN: Setiap variasi WAJIB jelas berbeda dalam angle, diksi, dan struktur.
- HINDARI keras mengulang teks persis berikut (apa adanya) pada bagian manapun:
HOOK_HINDARI: ${w.join(" || ")}
BODY_HINDARI: ${A.join(" || ")}
CTA_HINDARI: ${R.join(" || ")}`,B=r+M,O=Math.max(0,p-g.size);if(O>0)try{const I=await Ge(B,_e(O),Math.min(1,(l||.7)+.1),u);Array.isArray(I)&&I.forEach(N=>{const F=f(N);!g.has(F)&&g.size<p&&g.set(F,N)})}catch{}}let E=Array.from(g.values()).slice(0,p);if(E.length<p){const w=p-E.length;try{const A=await Ge(r+(q.current==="en"?`
Return EXACTLY the requested number of scripts.`:`
Kembalikan JUMLAH skrip sesuai yang diminta.`),_e(w),Math.min(1,(l||.7)+.05),u);Array.isArray(A)&&A.forEach(R=>{const M=f(R);!g.has(M)&&E.length<p&&(g.set(M,R),E.push(R))})}catch{}}const k=m.visualDnaStorage.textContent||"";let L=null;try{L=JSON.parse(localStorage.getItem("direktiva_visual_dna_tokens")||"null")}catch{}const b=(()=>{var O;const w=(L==null?void 0:L.brand)||(k.match(/brand\s*=\s*([^,;]+)/i)||[])[1]||"",A=(L==null?void 0:L.model)||(k.match(/model\s*=\s*([^,;]+)/i)||[])[1]||"",R=((O=L==null?void 0:L.colors)==null?void 0:O.join("|"))||(k.match(/must_keep_colors\s*=\s*([^,;]+)/i)||[])[1]||"",M=(Array.isArray(L==null?void 0:L.colors)?L.colors:R.split(/[|,\s]+/)).filter(I=>/^#?[0-9A-Fa-f]{3,6}$/.test(I)).slice(0,3),B=[];return w&&B.push(`brand=${w}`),A&&B.push(`model=${A}`),M.length&&B.push(`must_keep_colors=${M.map(I=>I.startsWith("#")?I:"#"+I).join("|")}`),B.join(", ")})();let P="";try{const w=JSON.parse(localStorage.getItem("direktiva_visual_features")||"[]");Array.isArray(w)&&w.length&&(P=w.slice(0,4).join(", "))}catch{}const _=w=>{if(!w)return"";let A=String(w);return A=A.replace(/^\((?:brand|model|must_keep_colors)[^)]*\)\s*/i,""),A=A.replace(/\bbrand\s*=\s*[^,;]+[;,]?\s*/gi,""),A=A.replace(/\bmodel\s*=\s*[^,;]+[;,]?\s*/gi,""),A=A.replace(/\bmust_keep_colors\s*=\s*[^,;]+[;,]?\s*/gi,""),A=A.replace(/\bCAM\[[^\]]*\]\s*\|?/gi,""),A=A.replace(/\bLIGHT\[[^\]]*\]\s*\|?/gi,""),A=A.replace(/\bMOOD\[[^\]]*\]\s*\|?/gi,""),A=A.replace(/\bcharid\[[^\]]*\]/gi,""),A=A.replace(/\|?\s*ID\[[^\]]*\]\s*/gi,""),A.trim()},S=(w,A="")=>{var I,N;let M=_(w);try{const F=localStorage.getItem("direktiva_char_essence")||"";F&&localStorage.getItem("visualStrategy")==="character"&&(M=M.replace(/<\/?char-desc>[^]*?<\/char-desc>/gi,"").trim(),M=`<char-desc>${F}</char-desc> ${M}`.trim())}catch{}let B="";if(b){let F="";try{const ge=JSON.parse(localStorage.getItem("direktiva_visual_features")||"[]"),G=na(A,ge);Array.isArray(G)&&G.length&&(F=G.slice(0,4).join(", "))}catch{}const Y=F||P,ie=`ID[${b}${Y?`; features=${Y}`:""}]`,Z=((N=(I=m.inputs)==null?void 0:I.productName)==null?void 0:N.value)||"";oa(A,Z,(L==null?void 0:L.brand)||"",M)&&(B=` | ${ie}`)}const O="";return`${M}${B}`},T=w=>{var A,R,M;try{(A=w==null?void 0:w.hook)!=null&&A.shots&&w.hook.shots.forEach(B=>{B.text_to_image_prompt&&(B.text_to_image_prompt=S(B.text_to_image_prompt,B.visual_idea||""))}),(R=w==null?void 0:w.body)!=null&&R.shots&&w.body.shots.forEach(B=>{B.text_to_image_prompt&&(B.text_to_image_prompt=S(B.text_to_image_prompt,B.visual_idea||""))}),(M=w==null?void 0:w.cta)!=null&&M.shots&&w.cta.shots.forEach(B=>{B.text_to_image_prompt&&(B.text_to_image_prompt=S(B.text_to_image_prompt,B.visual_idea||""))}),Array.isArray(w==null?void 0:w.slides)&&w.slides.forEach(B=>{B.text_to_image_prompt&&(B.text_to_image_prompt=S(B.text_to_image_prompt,B.slide_text||""))})}catch{}return w},C=E.map((w,A)=>({...T({...w}),visual_dna:k,id:`script-${Date.now()}-${A}`})),D=localStorage.getItem("currentMode")||"single";$n(C,m.inputs.productName.value,D),a&&(a.style.width="90%"),await Vn(C);try{const w=document.getElementById("results-toolbar"),A=parseInt(((i=document.getElementById("script-count"))==null?void 0:i.value)||"1",10);if(w){const R=A>1;w.classList.toggle("hidden",!R);try{w.style.display=R?"flex":"none"}catch{}}}catch{}a&&(a.style.width="100%"),m.downloadAllContainer.classList.remove("hidden"),setTimeout(()=>{e&&e.classList.add("hidden")},1e3)}catch(r){console.error("Error during generation:",r);const c=r.message||d("notification_api_error")||"API Error";xa(c),v(c,"error",5e3),e&&e.classList.add("hidden")}finally{z(!1,m.generateBtn)}}async function Yt(){const t=document.getElementById("revision-instruction").value.trim(),e=Array.from(document.querySelectorAll(".section-checkbox:checked")).map(a=>a.dataset.section);if(e.length===0){v(d("notification_select_section_regenerate")||"Pilih setidaknya satu bagian untuk diregenerasi.","warning");return}if(!t){v(d("notification_revision_instruction_empty")||"Instruksi revisi tidak boleh kosong.","error");return}z(!0,m.editModal.regenerateBtn);try{const a=localStorage.getItem("cardBeingEditedId"),n=document.getElementById(a),o=JSON.parse(n.dataset.script),s=to(o,t,e),i={};e.includes("hook")&&(i.hook=_e(1).items.properties.hook),e.includes("body")&&(i.body=_e(1).items.properties.body),e.includes("cta")&&(i.cta=_e(1).items.properties.cta);const r=await Ge(s,{type:"OBJECT",properties:i});za(o,r,e)}catch(a){console.error("Error during regeneration:",a),v(`${d("notification_regeneration_error")||"Regeneration error"} ${a.message}`,"error")}finally{z(!1,m.editModal.regenerateBtn)}}function _e(t){const e=localStorage.getItem("currentMode")||"single";t||parseInt(m.inputs.scriptCount.value,10);const n={type:"OBJECT",properties:{text:{type:"STRING"},shots:{type:"ARRAY",items:{type:"OBJECT",properties:{visual_idea:{type:"STRING"},prompt_translation_notes:{type:"STRING",description:"Explain step-by-step how the visual_idea is translated into the text_to_image_prompt, ensuring all key elements like framing and subject are identical."},text_to_image_prompt:{type:"STRING"},negative_prompt:{type:"STRING",description:"Contextual negatives for this shot"},suggested_negative_prompt:{type:"STRING"},image_to_video_prompt:{type:"STRING"},camera_directives:{type:"STRING"},lighting_directives:{type:"STRING"},mood_directives:{type:"STRING"}},required:["visual_idea","text_to_image_prompt","image_to_video_prompt","negative_prompt"]}}},required:["text","shots"]},o={type:"OBJECT",properties:{selling_points:{type:"ARRAY",items:{type:"STRING"}}},required:["selling_points"]},s={type:"OBJECT",properties:{name:{type:"STRING"},age:{type:"STRING"},ethnicity:{type:"STRING"},skin_tone:{type:"STRING"},face_shape:{type:"STRING"},body_shape:{type:"STRING"},hair_style:{type:"STRING"},hair_color:{type:"STRING"},eye_color:{type:"STRING"}},required:["name","age","ethnicity","skin_tone","face_shape","body_shape","hair_style","hair_color","eye_color"]},i={type:"OBJECT",properties:{title:{type:"STRING"},review_insights:o},required:["title","review_insights"]};if(e==="single")i.properties.character_sheet={type:"ARRAY",items:s},i.properties.hook=n,i.properties.body=n,i.properties.cta=n,i.properties.hook_variants={type:"ARRAY",items:{type:"STRING"}},i.properties.body_intro={type:"STRING"},i.properties.body_variants={type:"ARRAY",items:{type:"STRING"}},i.properties.cta_variants={type:"ARRAY",items:{type:"STRING"}},i.required.push("hook","body","cta","hook_variants","body_variants","cta_variants");else{const r={type:"OBJECT",properties:{slide_text:{type:"STRING"},text_to_image_prompt:{type:"STRING"},layout_suggestion:{type:"STRING"},engagement_idea:{type:"STRING"},camera_directives:{type:"STRING"},lighting_directives:{type:"STRING"},mood_directives:{type:"STRING"}},required:["slide_text","text_to_image_prompt"]};i.properties.slides={type:"ARRAY",items:r},i.required.push("slides")}return{type:"ARRAY",items:i}}function qa(){const t=q.current,e=localStorage.getItem("direktiva_system_prompt");return e||(t==="en"?va:ba)}function eo(){var Pa,Ba;const t=localStorage.getItem("currentMode")||"single",e=q.current,a=t==="single"?m.inputs.scriptCount.value:1,n=m.personaSelector.value,o=localStorage.getItem("productColorPalette");localStorage.getItem("model_target");const s=localStorage.getItem("platform_target")||localStorage.getItem("targetPlatform")||"tiktok",i=localStorage.getItem("content_mode")||"post",r=ws(s,e,i),c=(localStorage.getItem("aspectRatio")||"").trim(),l=(Pa=document.getElementById("script-duration"))==null?void 0:Pa.value,u=Number(l)>0?Number(l):null,y=(Ba=document.getElementById("carousel-slide-count"))==null?void 0:Ba.value,p=Number(y)>0?Number(y):null,h=i==="carousel",f=h?c&&c!=="auto"?c:"4:5":c&&c!=="auto"?c:r.cfg.aspect||"9:16",g=h?null:u||r.cfg.maxDuration||30,E=h?p||r.meta.slides||7:null;function k(H,V,j){if(!Array.isArray(H)||!V||!j||V===j)return H||[];const te=j/V;return H.map(Q=>({...Q,t:typeof Q.t=="number"?Math.max(0,Math.round(Q.t*te)):Q.t}))}const L=h?[]:k(r.beats,r.cfg.maxDuration,g),b=document.getElementById("creative-freedom"),P=b?parseFloat(b.value):.7,S=Math.max(0,Math.min(1,1-P))<.5?e==="en"?"- Treat the structure as advisory; you may deviate if clarity improves.":"- Struktur sebagai panduan; boleh menyimpang bila hasil lebih jelas.":e==="en"?"- Follow the structure closely.":"- Ikuti struktur secara ketat.",T=e==="en",C=h?`${T?"Slides":"Jumlah slide"}: ${E}
${T?"Aspect":"Rasio"}: ${f}`:`${T?"Aspect":"Rasio"}: ${f}
${T?"Target duration":"Durasi target"}: ${g}s`;let D=T?`
- **${s.toUpperCase()} ${h?"CAROUSEL":"PLAN"}:**
- ${C}${r.promptNotes}
${S}`:`
- **RANCANGAN ${s.toUpperCase()} ${h?"CAROUSEL":""}:**
- ${C}${r.promptNotes}
${S}`;const w=h?{type:"carousel",slides:E,structure:r.cfg.structure||["Slide1 HOOK","Slide2-6 value","Slide7 CTA"],fontMaxWordsPerSlide:r.meta.fontMaxWordsPerSlide||12,meta:{aspect:f}}:{type:"post",beats:L,cta:r.cta,commentBait:r.commentBait,meta:{...r.meta,aspect:f,targetDuration:g}},A=JSON.stringify(w);qa();const R=qa(),M=R.includes("[[PLATFORM_NOTES]]")||R.includes("[[PLATFORM_PLAN_JSON]]"),B=R.replace("[[PLATFORM_NOTES]]",D).replace("[[PLATFORM_PLAN_JSON]]",A),O=["low quality","blurry","pixelated","watermark","text","logo","signature","overexposed highlights","underexposed shadows","deformed hands","extra fingers","missing fingers","melted skin","asymmetrical eyes","uncanny valley","plastic skin","wax texture","doll-like","mannequin face"];let I=e==="en"?`
- **NEGATIVE PROMPT (REQUIRED):** ${O.join(", ")}`:`
- **NEGATIVE PROMPT (WAJIB):** ${O.join(", ")}`;const N=parseInt(localStorage.getItem("ab_variant_count")||"3",10),F=e==="en"?`
- **A/B VARIANTS (MUST BE RETURNED):** Besides the main Hook/Body/CTA/shots structure, also return:
  - hook_variants: array containing EXACTLY ${N} alternative hook variations
  - body_intro: short intro string for body (optional)
  - body_variants: array containing 2-3 alternative body variations
  - cta_variants: array containing EXACTLY ${N} alternative CTA variations`:`
- **A/B VARIANTS (WAJIB DIKEMBALIKAN):** Selain struktur utama Hook/Body/CTA/shots, kembalikan juga:
  - hook_variants: array berisi TEPAT ${N} variasi hook alternatif
  - body_intro: string intro singkat untuk body (opsional)
  - body_variants: array berisi 2-3 variasi body alternatif
  - cta_variants: array berisi TEPAT ${N} variasi CTA alternatif`;let Y="";if(o&&o!=="undefined"&&o!=="null")try{const H=JSON.parse(o);Array.isArray(H)&&H.length>0&&(Y=e==="en"?`
- **MAIN COLOR PALETTE (MUST BE FOLLOWED):** Use the following color combinations dominantly: ${H.join(", ")}.`:`
- **PALET WARNA UTAMA (WAJIB DIPATUHI):** Gunakan kombinasi warna berikut secara dominan: ${H.join(", ")}.`)}catch(H){console.error(`${d("failed_parsing_color_palette")||"Gagal parsing palet warna:"}`,H);try{localStorage.removeItem("productColorPalette")}catch{}}let ie="";if(n){const V=Pe().find(j=>j.id===n);V&&(ie=e==="en"?`
- AI Persona / Brand Voice: Use this persona strictly: "${V.description}"`:`
- Persona AI / Brand Voice: Gunakan persona ini secara ketat: "${V.description}"`)}const Z=m.inputs.hookType.value,ge=zn(Z),G=m.inputs.ctaType.value,Ne=Wn(G);let be=[];const Se=localStorage.getItem("visualStrategy")||"default";Se==="character"&&document.querySelectorAll(".character-sheet-instance").forEach(H=>{const V={};["name","gender","age","ethnicity","face_shape","eye_color","eye_shape","lip_shape","nose_shape","eyebrow_style","hair_style","hair_color","unique_features","makeup_style","skin_tone","body_shape","height","clothing_style","color_palette","specific_outfit","vibe","notes"].forEach(te=>{const Q=H.querySelector(`[data-field="${te}"]`);Q&&Q.value.trim()!==""&&(V[te]=Q.value)}),Object.keys(V).length>0&&be.push(V)});let St="";if(be.length>0){try{const j=be[0]||{},{stableId:te}=Wa(j),Q=Xa(j);localStorage.setItem("direktiva_char_essence",Q),localStorage.setItem("direktiva_char_id",te);const co={name:j.name||"",gender:j.gender||"",age:j.age||"",ethnicity:j.ethnicity||"",hair:[j.hair_style,j.hair_color].filter(Boolean).join(" "),eyes:j.eye_color||"",skin:j.skin_tone||"",vibe:j.vibe||""};localStorage.setItem("direktiva_char_tokens",JSON.stringify(co))}catch(j){console.error("Failed to process character sheet tokens:",j)}St=e==="en"?`
- **CHARACTER ESSENCE (USE IN <char-desc>):** [[CHAR_ESSENCE]]
- CHARACTER PERSONA SYNTHESIS: Blend the sheet facts into a living persona with coherent facial proportions (eye distance, nose bridge, lip fullness) and micro-expressions. Maintain these anchor cues consistently across shots. Express mood naturally through eyes and mouth; avoid mannequin faces.
- If character is visible, you may append a compact CHAR[...] identity block at the end.`:`
- **ESENSI KARAKTER (PAKAI DI <char-desc>):** [[CHAR_ESSENCE]]
- SINTESIS PERSONA: Gabungkan fakta sheet menjadi sosok hidup dengan proporsi wajah koheren (jarak mata, pangkal hidung, ketebalan bibir) dan micro-expression. Jaga ciri jangkar ini konsisten antar shot. Ekspresikan mood natural; hindari wajah manekin.
- Jika karakter terlihat, boleh tambah blok ringkas CHAR[...] di akhir.`}let kt="";const $e=document.getElementById("interaction-description");$e&&!$e.parentElement.classList.contains("hidden")&&$e.value.trim()&&(kt=e==="en"?`
- **KEY INTERACTION DESCRIPTION (MUST BE USED):** ${$e.value}`:`
- **DESKRIPSI INTERAKSI KUNCI (WAJIB DIGUNAKAN):** ${$e.value}`);let wt="";if(t==="single"){const H=document.getElementById("script-duration").value;wt=e==="en"?`
- Target Video Duration: Around ${H} seconds.`:`
- Target Durasi Video: Sekitar ${H} detik.`}let oe=e==="en"?`${B}
                **User Request:**
                - Create ${a} script variations.
                - Product Name: ${m.inputs.productName.value}
                - Description: ${m.inputs.productDesc.value||d("no_description")||"No description provided."}
                - Product Category: ${document.getElementById("product-category").value}
                ${Y}
                - Visual Strategy: ${Se}
                ${St}
                ${kt}
                ${wt}
                - Aspect Ratio: ${Vt}
                - Writing Style: ${m.inputs.writingStyle.value}
                - Tone & Vibe: ${m.inputs.toneVibe.value}
                - Target Audience: ${m.inputs.targetAudience.value}
                - Hook Type: ${m.inputs.hookType.value}
                - CTA Type: ${m.inputs.ctaType.value}
                ${ie}
                ${I}
                ${D}
                ${F}
                
                **SPECIFIC HOOK STRATEGY:**
                ${ge}
                
                **SPECIFIC CTA STRATEGY:**
                ${Ne}`:`${B}
                **Permintaan Pengguna:**
                - Buat ${a} variasi skrip.
                - Nama Produk: ${m.inputs.productName.value}
                - Deskripsi: ${m.inputs.productDesc.value||d("no_description")||"Tidak ada deskripsi."}
                - Kategori Produk: ${document.getElementById("product-category").value}
                ${Y}
                - Strategi Visual: ${Se}
                ${St}
                ${kt}
                ${wt}
                - Aspek Rasio: ${Vt}
                - Gaya Penulisan: ${m.inputs.writingStyle.value}
                - Tone & Vibe: ${m.inputs.toneVibe.value}
                - Target Penonton: ${m.inputs.targetAudience.value}
                - Jenis Hook: ${m.inputs.hookType.value}
                - Jenis CTA: ${m.inputs.ctaType.value}
                ${ie}
                ${I}
                ${D}
                ${F}
                
                **STRATEGI HOOK SPESIFIK:**
                ${ge}
                
                **STRATEGI CTA SPESIFIK:**
                ${Ne}`;M||(oe+=D+`

[[PLATFORM_PLAN_JSON]]
${A}`);const Et=m.visualDnaStorage.textContent;if(Et&&(oe+=e==="en"?`
- **PRODUCT VISUAL DNA:** ${Et}`:`
- **VISUAL DNA PRODUK:** ${Et}`,oe+=e==="en"?`
- At the END of each text_to_image_prompt, optionally append ID[brand=...; model=...; must_keep_colors=HEX|HEX|HEX; features=...] ONLY if the scene clearly depicts OUR product (not competitor/before/messy/dirty/greasy/sticky/burnt/old/worn/unbranded).`:`
- Di AKHIR tiap text_to_image_prompt, tambahkan ID[brand=...; model=...; must_keep_colors=HEX|HEX|HEX; features=...] HANYA jika adegan jelas memperlihatkan produk KITA (bukan kompetitor/sebelum/kotor/lengket/gosong/lama/usang/tanpa brand).`,oe+=e==="en"?`
- FIDELITY (REQUIRED): For each shot, the text_to_image_prompt MUST explicitly reflect the subject + action + framing present in visual_idea. Start the prompt with a short one-line English paraphrase of visual_idea (no new ideas), then continue with details. Keep language strictly English.`:`
- KESESUAIAN (WAJIB): Untuk setiap shot, text_to_image_prompt HARUS secara eksplisit mencerminkan subjek + aksi + framing dari visual_idea. Mulai prompt dengan satu kalimat ringkas berbahasa Inggris yang memparafrasekan visual_idea (tanpa menambah ide baru), lalu lanjutkan detail. Bahasa untuk prompt gambar HARUS Inggris.`,oe+=e==="en"?`
- CHARACTER CONSISTENCY: If visual strategy is 'Character Sheet', BEGIN text_to_image_prompt with <char-desc>[[CHAR_ESSENCE]]</char-desc>. Do NOT include <char-desc> in image_to_video_prompt.`:`
- KONSISTENSI KARAKTER: Jika strategi visual 'Character Sheet', AWALI text_to_image_prompt dengan <char-desc>[[CHAR_ESSENCE]]</char-desc>. JANGAN pakai <char-desc> pada image_to_video_prompt.`),t==="carousel"){const H=m.inputs.slideCount.value,V=m.inputs.carouselTemplate.value;let j="";const te={pas:d("pas_template_desc"),feature_benefit:d("feature_benefit_template_desc"),listicle:d("listicle_template_desc")};return V!=="auto"&&te[V]&&(j=e==="en"?`
- Story Template: ${te[V]}`:`
- Template Cerita: ${te[V]}`),e==="en"?`${oe}
- Slide Count: ${H}${j}
**Additional Instructions:** Create one carousel script. Generate a "slides" property containing an ARRAY of ${H} objects. Each object in the array MUST have "slide_text", "text_to_image_prompt" properties, and optional "layout_suggestion" and "engagement_idea" properties.`:`${oe}
- Jumlah Slide: ${H}${j}
**Instruksi Tambahan:** Buat satu skrip carousel. Hasilkan sebuah properti "slides" yang berisi sebuah ARRAY berisi ${H} objek. Setiap objek dalam array WAJIB memiliki properti "slide_text", "text_to_image_prompt", dan properti opsional "layout_suggestion" serta "engagement_idea".`}o&&localStorage.removeItem("productColorPalette");let Oe=e==="en"?`${oe}
**Additional Instructions:** Create a script consisting of "hook", "body", and "cta". Each section must have script text and an array containing 2-3 'shots' (micro-shots). If the visual strategy is 'Character Sheet', define one or more characters in 'character_sheet'.`:`${oe}
**Instruksi Tambahan:** Buat skrip yang terdiri dari "hook", "body", dan "cta". Setiap bagian harus memiliki teks skrip dan sebuah array berisi 2-3 'shots' (micro-shots). Jika strategi visual adalah 'Character Sheet', definisikan satu atau lebih karakter di 'character_sheet'.`;try{let H=localStorage.getItem("direktiva_char_essence")||"";Oe=Oe.replaceAll("[[CHAR_ESSENCE]]",H)}catch{Oe=Oe.replaceAll("[[CHAR_ESSENCE]]","")}return Oe}function to(t,e,a){const n=q.current,o={};a.includes("hook")||(o.hook=t.hook),a.includes("body")||(o.body=t.body),a.includes("cta")||(o.cta=t.cta);const s={writingStyle:m.inputs.writingStyle.value,toneVibe:m.inputs.toneVibe.value,targetAudience:m.inputs.targetAudience.value,hookType:m.inputs.hookType.value,ctaType:m.inputs.ctaType.value,characterSheets:(()=>{const r=[];try{document.querySelectorAll(".character-sheet-instance").forEach(c=>{const l={};c.querySelectorAll("[data-field]").forEach(u=>{u.value.trim()&&(l[u.dataset.field]=u.value)}),Object.keys(l).length&&r.push(l)})}catch{}return r})()};let i="";return n==="en"?(i=`You are an AI revision assistant. A script has been created with the following initial constraints:
`,i+=`\`\`\`json
${JSON.stringify(s,null,2)}
\`\`\`

`,Object.keys(o).length>0&&(i+=`The following sections of this script are FINAL and MUST NOT BE CHANGED AT ALL:
`,i+=`\`\`\`json
${JSON.stringify(o,null,2)}
\`\`\`

`),i+=`Now, your task is to regenerate the following sections: [${a.join(", ")}] based on this instruction: "${e}".
`,i+=`STRICT CHARACTER RULES: If characterSheets are provided, you MUST use them for all regenerated parts and visual prompts. Do NOT invent or modify characters. In T2I prompts, place physical descriptions ONLY inside <char-desc>...</char-desc>. NEVER include <char-desc> in I2V prompts.
`,i+=`IMPORTANT: Ensure your regeneration results still comply with the initial constraints given above (for example, if ctaType is 'TikTok', the result should still be TikTok-style). ALL SCRIPT TEXT OUTPUT MUST BE IN ENGLISH.
`,i+="Generate ONLY the sections you regenerate in valid JSON format."):(i=`Anda adalah asisten revisi AI. Sebuah skrip telah dibuat dengan batasan awal sebagai berikut:
`,i+=`\`\`\`json
${JSON.stringify(s,null,2)}
\`\`\`

`,Object.keys(o).length>0&&(i+=`Bagian berikut dari skrip ini SUDAH FINAL dan TIDAK BOLEH DIUBAH SAMA SEKALI:
`,i+=`\`\`\`json
${JSON.stringify(o,null,2)}
\`\`\`

`),i+=`Sekarang, tugas Anda adalah me-regenerasi bagian berikut: [${a.join(", ")}] berdasarkan instruksi ini: "${e}".
`,i+=`ATURAN KARAKTER YANG KETAT: Jika characterSheets tersedia, WAJIB digunakan untuk semua bagian yang direvisi dan prompt visual. JANGAN membuat/mengubah karakter baru. Pada T2I, taruh deskripsi fisik HANYA di dalam tag <char-desc>...</char-desc>. JANGAN pernah menaruh <char-desc> pada I2V.
`,i+=`PENTING: Pastikan hasil regenerasi Anda tetap mematuhi batasan awal yang diberikan di atas (misalnya, jika ctaType adalah 'TikTok', hasilnya harus tetap bergaya TikTok). SEMUA OUTPUT TEKS SKRIP WAJIB DALAM BAHASA INDONESIA.
`,i+="Hasilkan HANYA bagian yang Anda regenerasi dalam format JSON yang valid."),i}async function ao(t){var s,i;const e=t.querySelector(".additional-assets-container"),a=t.querySelector(".asset-loader"),n=t.querySelector(".asset-content");e.classList.remove("hidden"),a.classList.remove("hidden"),n.classList.add("hidden"),n.innerHTML="",v("Generating assets...","info");let o=null;try{const r=JSON.parse(t.dataset.script),c=Te(r),l=(localStorage.getItem("platform_target")||localStorage.getItem("targetPlatform")||"tiktok").toLowerCase(),u=`${d("asset_generation_prompt")||"Berdasarkan skrip berikut, buatlah 3 opsi judul/caption yang menarik, 1 set hashtag yang relevan (gabungan umum dan niche), dan 3 ide teks singkat untuk thumbnail/cover."}

Tambahkan juga daftar hashtag yang SPESIFIK untuk platform: ${l}.
Jika platform TikTok, gunakan kombinasi tag FYP dan niche yang relevan (contoh: #fyp, #foryou, #tiktokshop, serta niche spesifik produk/brand). Jika Instagram Reels, prioritaskan tag discoverability dan niche brand (contoh: #reels, #reelitfeelit). Jika YouTube Shorts, gunakan tag discoverability seperti #shorts serta niche.

WAJIB: Selain platform yang dipilih, SELALU sertakan juga daftar khusus untuk Shopee pada field platform_hashtags.shopee (format array of strings) yang relevan untuk konversi marketplace (contoh: #Shopee, #ShopeeHaul, #Voucher, #GratisOngkir, dll).

${d("script_label")||"Skrip"}:
---
${c}
---
`,y=Number(localStorage.getItem("direktiva_timeout_ms"))||12e4;o=await Ge(u,Es(),.7,y);let p='<div class="space-y-4">';p+=`<div><h5 class="text-sm font-bold text-gray-300 mb-2">${d("asset_titles_label")||"Judul/Caption"}</h5><ul class="list-disc list-inside text-xs text-gray-400 space-y-1">`,o.titles.forEach(k=>{p+=`<li>${k}</li>`}),p+="</ul></div>",p+=`<div><h5 class="text-sm font-bold text-gray-300 mb-2">${d("asset_hashtags_label")||"Hashtags"}</h5>`;const h=(o.hashtags||[]).join(" "),f=((s=o.platform_hashtags)==null?void 0:s[l])||[],g=o.trending_tags||[];p+=`<p class="text-xs text-gray-400 bg-gray-800 p-2 rounded-md">${h}</p>`,f.length&&(p+=`<div class="mt-2"><span class="text-xs font-semibold text-blue-300">${l} #</span><p class="text-xs text-gray-400 bg-gray-800 p-2 rounded-md">${f.join(" ")}</p></div>`);const E=((i=o.platform_hashtags)==null?void 0:i.shopee)||[];E.length&&(p+=`<div class="mt-2"><span class="text-xs font-semibold text-orange-300">Shopee #</span><p class="text-xs text-gray-400 bg-gray-800 p-2 rounded-md">${E.join(" ")}</p></div>`),g.length&&(p+=`<div class="mt-2"><span class="text-xs font-semibold text-green-300">Trending</span><p class="text-xs text-gray-400 bg-gray-800 p-2 rounded-md">${g.join(" ")}</p></div>`),p+="</div>",p+=`<div><h5 class="text-sm font-bold text-gray-300 mb-2">${d("asset_thumbnail_label")||"Ide Thumbnail"}</h5><ul class="list-disc list-inside text-xs text-gray-400 space-y-1">`,o.thumbnail_ideas.forEach(k=>{p+=`<li>${k}</li>`}),p+="</ul></div>",p+="</div>",n.innerHTML=p,v("Assets generated.","success");try{const k=JSON.parse(t.dataset.script);k.additional_assets=o,k.additional_assets_html=p,t.dataset.script=JSON.stringify(k);const{updateSingleScript:L}=await $(async()=>{const{updateSingleScript:b}=await Promise.resolve().then(()=>Ko);return{updateSingleScript:b}},void 0);L(k)}catch{}}catch(r){console.error("Error generating assets:",r),n.innerHTML=`<p class="text-red-400 text-xs">${d("failed_to_generate_assets")||"Failed to generate assets:"} ${r.message}</p>`,v(r.message||d("failed_to_generate_assets")||"Failed to generate assets","error")}finally{a.classList.add("hidden"),n.classList.remove("hidden")}}const xs=Object.freeze(Object.defineProperty({__proto__:null,aspectRatio:Vt,constructPrompt:eo,constructRevisionPrompt:to,getCTAInstructions:Wn,getHookInstructions:zn,getResponseSchema:_e,handleGenerate:Qn,handleGenerateAssets:ao,handleImageUpload:Zn,handleRegenerate:Yt,handleRemoveImage:Ta,validateInputs:Xn},Symbol.toStringTag,{value:"Module"}));function Is(){Ls()}function Ls(){document.querySelectorAll("input[required], textarea[required]").forEach(e=>{const a=e.closest(".form-field");a&&(e.addEventListener("blur",()=>{As(a,e)}),e.addEventListener("input",()=>{a.classList.contains("error")&&a.classList.remove("error")}))})}function As(t,e){const a=e.checkValidity()&&e.value.trim()!=="";t.classList.remove("error","success"),!a&&e.value.trim()!==""?(t.classList.add("error"),Ts(t,Cs(e))):(a&&e.value.trim()!==""&&t.classList.add("success"),Kt(t))}function Ts(t,e){Kt(t);const a=document.createElement("div");a.className="form-field-helper error-message",a.textContent=e,t.appendChild(a)}function Kt(t){const e=t.querySelector(".error-message");e&&e.remove()}function Cs(t){return t.validity.valueMissing?"Field ini wajib diisi":t.validity.typeMismatch?"Format input tidak valid":t.validity.tooShort?`Minimal ${t.minLength} karakter`:t.validity.tooLong?`Maksimal ${t.maxLength} karakter`:"Input tidak valid"}function Ps(){Bs(),$s(),Os(),Rs(),Ds()}function Bs(){document.addEventListener("click",t=>{const e=t.target.closest(".btn, .icon-btn");e&&Ns(e,t)})}function Ns(t,e){const a=t.getBoundingClientRect(),n=Math.max(a.width,a.height),o=e.clientX-a.left-n/2,s=e.clientY-a.top-n/2,i=document.createElement("span");if(i.className="ripple",i.style.cssText=`
        position: absolute;
        width: ${n}px;
        height: ${n}px;
        left: ${o}px;
        top: ${s}px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
        z-index: 1;
    `,t.style.position="relative",t.style.overflow="hidden",t.appendChild(i),!document.querySelector("#ripple-styles")){const r=document.createElement("style");r.id="ripple-styles",r.textContent=`
            @keyframes ripple-animation {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `,document.head.appendChild(r)}setTimeout(()=>{i.remove()},600)}function $s(){document.querySelectorAll(".result-card, .persona-card, .history-item").forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-4px) scale(1.02)",e.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(0) scale(1)"})})}function Os(){document.documentElement.classList.add("smooth-scroll");const t=document.querySelectorAll(".parallax");t.length>0&&window.addEventListener("scroll",()=>{const e=window.pageYOffset;t.forEach(a=>{const n=e*-.5;a.style.transform=`translateY(${n}px)`})},{passive:!0}),Ms()}function Ms(){const t={threshold:.1,rootMargin:"0px 0px -50px 0px"},e=new IntersectionObserver(n=>{n.forEach(o=>{o.isIntersecting&&o.target.classList.add("animate-in")})},t);document.querySelectorAll(".animate-on-scroll").forEach(n=>e.observe(n))}function Rs(){window.showSuccessFeedback=t=>{t.classList.add("bounce"),setTimeout(()=>{t.classList.remove("bounce")},600)},window.showErrorFeedback=t=>{t.classList.add("shake"),setTimeout(()=>{t.classList.remove("shake")},500)},window.showLoadingFeedback=t=>{t.classList.add("pulse")},window.hideLoadingFeedback=t=>{t.classList.remove("pulse")}}function Ds(){document.addEventListener("keydown",e=>{e.key==="Tab"&&document.body.classList.add("keyboard-navigation")}),document.addEventListener("mousedown",()=>{document.body.classList.remove("keyboard-navigation")});const t=document.createElement("style");t.textContent=`
        .keyboard-navigation *:focus {
            outline: 2px solid var(--primary-color) !important;
            outline-offset: 2px !important;
        }
        
        .keyboard-navigation .btn:focus,
        .keyboard-navigation .icon-btn:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3) !important;
        }
    `,document.head.appendChild(t),window.matchMedia("(prefers-reduced-motion: reduce)").matches&&document.body.classList.add("reduce-motion")}const Ha="direktiva_migration_completed",qs={kontenkilat_theme:"aethera_theme",kontenkilat_language:"aethera_language",kontenkilat_system_prompt:"aethera_system_prompt",kontenkilat_user_api_key:"aethera_user_api_key",kontenkilat_history:"aethera_history",kontenkilat_lastGeneratedScripts:"aethera_lastGeneratedScripts",kontenkilat_personas:"aethera_personas",aethera_theme:"direktiva_theme",aethera_language:"direktiva_language",aethera_system_prompt:"direktiva_system_prompt",aethera_user_api_key:"direktiva_user_api_key",aethera_settings_last_modified:"direktiva_settings_last_modified",aethera_timeout_ms:"direktiva_timeout_ms",aethera_session_id:"direktiva_session_id",aethera_history:"direktiva_history",aethera_history_last_modified:"direktiva_history_last_modified",aethera_history_tags:"direktiva_history_tags",aethera_last_settings:"direktiva_last_settings",aethera_settings_presets:"direktiva_settings_presets",aethera_presets_last_modified:"direktiva_presets_last_modified",aethera_character_presets:"direktiva_character_presets",aethera_character_presets_last_modified:"direktiva_character_presets_last_modified",aethera_pinned_characters:"direktiva_pinned_characters",aethera_character_usage:"direktiva_character_usage",aethera_personas:"direktiva_personas",aethera_lastGeneratedScripts:"direktiva_lastGeneratedScripts",aethera_sync_status:"direktiva_sync_status",aethera_last_sync:"direktiva_last_sync",aethera_pending_sync:"direktiva_pending_sync",aethera_offline_changes:"direktiva_offline_changes"};function Hs(){if(localStorage.getItem(Ha)){console.log("Migration already completed");return}console.log("Starting localStorage key migration...");let t=0;Object.entries(qs).forEach(([e,a])=>{const n=localStorage.getItem(e);if(n!==null)try{localStorage.getItem(a)===null&&localStorage.setItem(a,n);try{localStorage.removeItem(e)}catch{}t++,console.log(`Migrated: ${e} -> ${a}`)}catch(o){console.error(`Failed to migrate ${e}:`,o)}}),localStorage.setItem(Ha,"true"),console.log(`Migration completed. ${t} keys migrated.`)}function zt(){try{Hs()}catch(t){console.error("Migration failed:",t)}}typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",zt):zt());function Wt(){if(localStorage.getItem("aethera_show_sync_indicator")!=="false"){const e=js();document.body.appendChild(e)}Js()}function js(){const t=document.createElement("div");return t.id="sync-indicator",t.className="sync-indicator sync-offline",t.innerHTML=`
        <svg class="sync-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        <span class="sync-text">${d("sync_status_offline")||"Offline"}</span>
    `,t.addEventListener("click",Gs),t.addEventListener("dblclick",Us),t}function Us(){const t=document.getElementById("sync-indicator");if(!t)return;if(t.style.display==="none"){t.style.display="",localStorage.setItem("aethera_show_sync_indicator","true");const a=d("sync_indicator_shown")||"Indikator sinkronisasi ditampilkan";v(a,"info")}else{t.style.display="none",localStorage.setItem("aethera_show_sync_indicator","false");const a=d("sync_indicator_hidden")||"Indikator sinkronisasi disembunyikan. Double-click di area kosong untuk menampilkan kembali.";v(a,"info"),Fs()}}function Fs(){document.body.removeEventListener("dblclick",Xt),document.body.addEventListener("dblclick",Xt)}function Xt(t){if(t.target===document.body||t.target.tagName==="HTML"){const e=document.getElementById("sync-indicator");if(e&&e.style.display==="none"){e.style.display="",localStorage.setItem("aethera_show_sync_indicator","true");const a=d("sync_indicator_shown")||"Indikator sinkronisasi ditampilkan";v(a,"info"),document.body.removeEventListener("dblclick",Xt)}}}async function Gs(){const{data:{session:t}}=await x.auth.getSession();if(!t){v(d("notification_login_required")||"Please login to sync data","warning");return}if(!navigator.onLine){v(d("notification_offline")||"You are offline. Data will sync when connection is restored.","info");return}try{await U.syncAll(),v(d("notification_sync_success")||"Data synced successfully")}catch(e){console.error("Manual sync failed:",e),v(d("notification_sync_failed")||"Sync failed. Please try again.","error")}}function Js(){const t=document.getElementById("settings-panel");if(!t)return;const e=document.createElement("div");e.className="settings-section sync-section",e.innerHTML=`
        <h3>${d("settings_sync_title")||"Cloud Sync"}</h3>
        <div class="sync-controls">
            <div class="sync-status-display">
                <div class="sync-status-item">
                    <span class="sync-label">${d("sync_last_sync")||"Last Sync"}:</span>
                    <span id="last-sync-time" class="sync-value">-</span>
                </div>
                <div class="sync-status-item">
                    <span class="sync-label">${d("sync_status")||"Status"}:</span>
                    <span id="sync-status-text" class="sync-value">-</span>
                </div>
            </div>
            
            <div class="sync-buttons">
                <button id="manual-sync-btn" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    ${d("sync_manual_sync")||"Sync Now"}
                </button>
                
                <button id="export-backup-btn" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    ${d("sync_export_backup")||"Export Backup"}
                </button>
                
                <button id="import-backup-btn" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17,8 12,3 7,8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    ${d("sync_import_backup")||"Import Backup"}
                </button>
            </div>
            
            <div class="sync-info">
                <p class="sync-description">
                    ${d("sync_description")||"Your data is automatically synced when you're online and logged in. You can also manually export/import backups."}
                </p>
            </div>
        </div>
        
        <input type="file" id="backup-file-input" accept=".json" style="display: none;">
    `,t.appendChild(e),Vs()}function Vs(){const t=document.getElementById("manual-sync-btn");t&&t.addEventListener("click",Ys);const e=document.getElementById("export-backup-btn");e&&e.addEventListener("click",Ks);const a=document.getElementById("import-backup-btn");a&&a.addEventListener("click",zs);const n=document.getElementById("backup-file-input");n&&n.addEventListener("change",Ws),dt(),setInterval(dt,3e4)}async function Ys(){const t=document.getElementById("manual-sync-btn"),e=t.innerHTML;try{t.disabled=!0,t.innerHTML=`
            <svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
            ${d("sync_syncing")||"Syncing..."}
        `,await U.syncAll(),v(d("notification_sync_success")||"Data synced successfully"),dt()}catch(a){console.error("Manual sync failed:",a),v(d("notification_sync_failed")||"Sync failed. Please try again.","error")}finally{t.disabled=!1,t.innerHTML=e}}async function Ks(){try{await U.exportBackup()}catch(t){console.error("Export backup failed:",t),v(d("notification_export_failed")||"Failed to export backup","error")}}function zs(){const t=document.getElementById("backup-file-input");t&&t.click()}async function Ws(t){const e=t.target.files[0];if(e){try{await U.restoreBackup(e),dt(),setTimeout(()=>{window.location.reload()},2e3)}catch(a){console.error("Import backup failed:",a),v(d("notification_import_failed")||"Failed to import backup","error")}t.target.value=""}}function dt(){const t=document.getElementById("last-sync-time"),e=document.getElementById("sync-status-text");if(t){const a=localStorage.getItem("aethera_last_sync");if(a)try{const n=new Date(a);isNaN(n.getTime())?t.textContent=d("sync_never")||"Never":t.textContent=n.toLocaleString()}catch{console.warn("Invalid last sync date:",a),t.textContent=d("sync_never")||"Never"}else t.textContent=d("sync_never")||"Never"}if(e){const a=localStorage.getItem("aethera_sync_status")||J.OFFLINE,n={[J.SYNCED]:d("sync_status_synced")||"Synced",[J.SYNCING]:d("sync_status_syncing")||"Syncing...",[J.OFFLINE]:d("sync_status_offline")||"Offline",[J.ERROR]:d("sync_status_error")||"Error"};e.textContent=n[a],e.className=`sync-value sync-${a}`}}function ja(){const t=document.createElement("style");t.textContent=`
        /* Sync Indicator */
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            display: none !important;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0.8;
        }
        
        .sync-indicator:hover {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .sync-indicator.hidden {
            display: none;
        }
        
        .sync-indicator.sync-synced {
            color: var(--success-color, #10b981);
        }
        
        .sync-indicator.sync-syncing {
            color: var(--warning-color, #f59e0b);
        }
        
        .sync-indicator.sync-offline {
            color: var(--text-secondary);
        }
        
        .sync-indicator.sync-error {
            color: var(--error-color, #ef4444);
        }
        
        .sync-icon {
            width: 14px;
            height: 14px;
        }
        
        .sync-indicator.sync-syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Sync Section in Settings */
        .sync-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
        }
        
        .sync-section h3 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        .sync-status-display {
            margin-bottom: 16px;
        }
        
        .sync-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sync-status-item:last-child {
            border-bottom: none;
        }
        
        .sync-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .sync-value {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .sync-value.sync-synced {
            color: var(--success-color, #10b981);
        }
        
        .sync-value.sync-syncing {
            color: var(--warning-color, #f59e0b);
        }
        
        .sync-value.sync-offline {
            color: var(--text-secondary);
        }
        
        .sync-value.sync-error {
            color: var(--error-color, #ef4444);
        }
        
        .sync-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .sync-buttons .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sync-buttons .btn:hover {
            background-color: var(--bg-secondary);
        }
        
        .sync-buttons .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .sync-buttons .btn-primary {
            background-color: var(--primary-color, #3b82f6);
            color: white;
            border-color: var(--primary-color, #3b82f6);
        }
        
        .sync-buttons .btn-primary:hover {
            background-color: var(--primary-hover, #2563eb);
        }
        
        .sync-info {
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .sync-description {
            margin: 0;
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* Migration Modal */
        .migration-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .migration-modal.show {
            opacity: 1;
        }
        
        .migration-modal .modal-content {
            background-color: var(--bg-primary);
            border-radius: 8px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .migration-modal .modal-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .migration-modal .modal-header h3 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }
        
        .migration-modal .modal-body {
            padding: 20px;
        }
        
        .migration-modal .modal-body p {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .migration-modal .modal-body ul {
            margin: 0 0 16px 0;
            padding-left: 20px;
            color: var(--text-primary);
        }
        
        .migration-modal .modal-body li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .migration-note {
            background-color: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color, #3b82f6);
        }
        
        .migration-modal .modal-footer {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .migration-modal .modal-footer .btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .migration-modal .modal-footer .btn:hover {
            background-color: var(--bg-secondary);
        }
        
        .migration-modal .modal-footer .btn-primary {
            background-color: var(--primary-color, #3b82f6);
            color: white;
            border-color: var(--primary-color, #3b82f6);
        }
        
        .migration-modal .modal-footer .btn-primary:hover {
            background-color: var(--primary-hover, #2563eb);
        }
        
        .migration-modal .modal-footer .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sync-buttons {
                flex-direction: column;
            }
            
            .sync-buttons .btn {
                justify-content: center;
            }
            
            .migration-modal .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .migration-modal .modal-footer {
                flex-direction: column;
            }
        }
    `,document.head.appendChild(t)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ja(),Wt()}):(ja(),Wt());function Xs(){const t=document.getElementById("back-to-top");if(!t)return;const e=()=>{window.pageYOffset>200?(t.style.opacity="1",t.style.pointerEvents="auto",t.setAttribute("aria-hidden","false")):(t.style.opacity="0",t.style.pointerEvents="none",t.setAttribute("aria-hidden","true"))},a=()=>{window.scrollTo({top:0,behavior:"smooth"})};window.addEventListener("scroll",e,{passive:!0}),t.addEventListener("click",a),e()}function Zs(){const t=document.getElementById("generate-btn"),e=t==null?void 0:t.closest(".mt-6.pt-6.border-t.border-gray-800.space-y-4");if(!t||!e)return;const a=()=>{const n=window.innerWidth<768,o=!document.getElementById("generator-page").classList.contains("hidden");n&&o?(e.style.position="sticky",e.style.bottom="0",e.style.backgroundColor="var(--bg-primary)",e.style.borderTop="1px solid var(--border-color)",e.style.zIndex="20",e.style.padding="1rem",e.style.margin="0 -1.5rem",e.style.boxShadow="0 -4px 12px rgba(0, 0, 0, 0.15)"):(e.style.position="",e.style.bottom="",e.style.backgroundColor="",e.style.borderTop="",e.style.zIndex="",e.style.padding="",e.style.margin="",e.style.boxShadow="")};window.addEventListener("resize",a,{passive:!0}),a()}function Qs(){const t=document.getElementById("mobile-menu-button"),e=document.getElementById("mobile-menu"),a=document.getElementById("menu-open-icon"),n=document.getElementById("menu-close-icon");if(!t||!e)return;t.setAttribute("aria-expanded","false"),t.setAttribute("aria-controls","mobile-menu"),t.setAttribute("aria-label","Toggle mobile menu"),e.setAttribute("role","navigation"),e.setAttribute("aria-label","Mobile navigation");const o=i=>{i&&(i.preventDefault(),i.stopImmediatePropagation());const r=e.classList.contains("hidden");if(e.classList.toggle("hidden"),a.classList.toggle("hidden"),n.classList.toggle("hidden"),t.setAttribute("aria-expanded",r?"true":"false"),r?(document.body.style.overflow="hidden",document.body.style.paddingRight=er()+"px"):(document.body.style.overflow="",document.body.style.paddingRight=""),r){const c=e.querySelector("a, button");c&&setTimeout(()=>c.focus(),100)}else t.focus()};t.addEventListener("click",o,{capture:!0}),document.addEventListener("click",i=>{!e.classList.contains("hidden")&&!e.contains(i.target)&&!t.contains(i.target)&&o()}),document.addEventListener("keydown",i=>{i.key==="Escape"&&!e.classList.contains("hidden")&&o()}),e.querySelectorAll("a, button").forEach(i=>{i.addEventListener("click",()=>{e.classList.contains("hidden")||o()})}),window.originalToggleMobileMenu=o}function er(){const t=document.createElement("div");t.style.visibility="hidden",t.style.overflow="scroll",t.style.msOverflowStyle="scrollbar",document.body.appendChild(t);const e=document.createElement("div");t.appendChild(e);const a=t.offsetWidth-e.offsetWidth;return t.parentNode.removeChild(t),a}function tr(){document.querySelectorAll("input, textarea, select").forEach(e=>{e.type!=="date"&&e.type!=="datetime-local"&&parseFloat(getComputedStyle(e).fontSize)<16&&(e.style.fontSize="16px"),e.addEventListener("focus",()=>{var a;(a=e.parentElement)==null||a.classList.add("field-focused")}),e.addEventListener("blur",()=>{var a;(a=e.parentElement)==null||a.classList.remove("field-focused")})})}function ar(){const t=document.createElement("a");t.href="#main-content",t.textContent="Skip to main content",t.className="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded z-50",t.style.transform="translateY(-100%)",t.style.transition="transform 0.3s ease",t.addEventListener("focus",()=>{t.style.transform="translateY(0)"}),t.addEventListener("blur",()=>{t.style.transform="translateY(-100%)"}),document.body.insertBefore(t,document.body.firstChild),document.querySelectorAll('[role="dialog"], .modal-overlay').forEach(a=>{a.addEventListener("keydown",n=>{n.key==="Tab"&&nr(n,a)})})}function nr(t,e){const a=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=a[0],o=a[a.length-1];t.shiftKey?document.activeElement===n&&(o.focus(),t.preventDefault()):document.activeElement===o&&(n.focus(),t.preventDefault())}function or(){Xs(),Zs(),Qs(),tr(),ar(),console.log(" UX improvements initialized")}function sr(t){return`<!doctype html><meta charset="utf-8"><title>VO Preview (Gemini)</title>
<style>body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;padding:16px;background:#0b1220;color:#e5e7eb}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
textarea{width:100%;height:200px;background:#0f1629;color:#e5e7eb;border:1px solid #23314d;border-radius:8px;padding:10px}
select,button{padding:8px 12px;border-radius:8px;border:1px solid #23314d;background:#111a2e;color:#e5e7eb;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}.hint{color:#9aa4b2;font-size:12px}</style>
<h2>VO Preview (Gemini)</h2>
<div class="row"><label>Voice:</label><select id="voice"><option value="Kore" selected>Kore</option><option value="Puck">Puck</option></select></div>
<textarea id="text"></textarea>
<div class="row"><button id="play"> Preview Gemini</button><span id="status" class="hint"></span></div>
<script>
  const ta=document.getElementById('text'); ta.value=${JSON.stringify(t||"")};
  const btn=document.getElementById('play'); const status=document.getElementById('status');
  let busy=false, audioRef=null;
  btn.onclick=async()=>{ if(busy) return; busy=true; btn.disabled=true; status.textContent='Generating audio...';
    try{
      if(audioRef){ try{ audioRef.pause(); }catch(e){} }
      const voice=document.getElementById('voice').value || 'Kore';
      const r=await fetch('/api/tts/gemini',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:ta.value,voiceName:voice})});
      const txt=await r.text(); if(!r.ok){ let m=txt; try{const j=JSON.parse(txt); m=j.error||txt;}catch{} throw new Error(m); }
      const {audio_base64,mime}=JSON.parse(txt);
      audioRef=new Audio('data:'+(mime||'audio/wav')+';base64,'+audio_base64);
      audioRef.onended=()=>{busy=false;btn.disabled=false;status.textContent='';};
      audioRef.onerror=()=>{busy=false;btn.disabled=false;status.textContent='(audio error)';};
      await audioRef.play(); status.textContent='Playing...';
    }catch(e){ status.textContent = e.message||String(e); busy=false; btn.disabled=false; }
  };
<\/script>`}function rr(t,e,a={},n={}){var h,f,g;const{ssml:o,geminiText:s,lang:i,platform:r,recipe:c,readTimes:l}=ze(e,a),u={lang:i,platform:r,engine:((h=a==null?void 0:a.vo)==null?void 0:h.engine)||"gemini",geminiVoice:((f=a==null?void 0:a.vo)==null?void 0:f.geminiVoice)||"Kore",elevenVoice:((g=a==null?void 0:a.vo)==null?void 0:g.elevenVoice)||"",recipe:c,readTimes:l},y=n.base||`VO/${r}_${i}`,p=(E,k)=>{t.file(`${y}/${E}`,k)};p(`vo_${r}_${i}.ssml`,o),p(`vo_${r}_${i}_gemini.txt`,s),p(`vo_meta_${r}_${i}.json`,JSON.stringify(u,null,2)),p("vo_preview_gemini.html",sr(s))}async function ir(){return window.JSZip||await new Promise((t,e)=>{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",a.onload=t,a.onerror=e,document.head.appendChild(a)}),window.JSZip}function cr(t){return String(t||"").trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_\-]/g,"").slice(0,64)||"script"}function lr(t){var i;const e=(((i=t.body)==null?void 0:i.text)||t.body||"").toString().split(`
`).filter(Boolean),a=2;let n=0,o=1,s="";for(const r of e){const c=new Date(n*1e3).toISOString().substr(11,8)+",000",l=new Date((n+a)*1e3).toISOString().substr(11,8)+",000";s+=`${o}
${c} --> ${l}
${r}

`,n+=a,o++}return s}function dr(t){var s;const e=(((s=t.body)==null?void 0:s.text)||t.body||"").toString().split(`
`).filter(Boolean),a=2;let n=0,o=`start,end,text
`;for(const i of e){const r=n.toFixed(2),c=(n+a).toFixed(2);o+=`${r},${c},"${i.replace(/"/g,'""')}"
`,n+=a}return o}function ur(t){var i,r,c;const e=t.title||"",a=(((i=t.hook)==null?void 0:i.text)||t.hook||"").toString(),n=(((r=t.body)==null?void 0:r.text)||t.body||"").toString(),o=(((c=t.cta)==null?void 0:c.text)||t.cta||"").toString(),s=Array.isArray(t.hashtags)?t.hashtags.join(" "):t.hashtags||"";return`TITLE
${e}

HOOK
${a}

BODY
${n}

CTA
${o}

HASHTAGS
${s}
`}async function mr(t){var f,g;const n=document.createElement("canvas");n.width=1080,n.height=1920;const o=n.getContext("2d"),s=o.createLinearGradient(0,0,1080,1920);s.addColorStop(0,"#0f172a"),s.addColorStop(1,"#1e293b"),o.fillStyle=s,o.fillRect(0,0,1080,1920),o.globalAlpha=.5,o.fillStyle="#22d3ee",o.fillRect(0,1920*.72,1080,1920*.28),o.globalAlpha=1;const i=64,r=1080-i*2,c=(((f=t.hook)==null?void 0:f.text)||t.hook||t.title||"").toString();let l=88;o.fillStyle="#e2e8f0",o.textBaseline="top",o.font=`bold ${l}px Inter, system-ui, -apple-system, Segoe UI, Roboto`;function u(E){const k=E.split(/\s+/),L=[];let b="";for(const P of k){const _=b?b+" "+P:P;o.measureText(_).width>r?(b&&L.push(b),b=P):b=_}return b&&L.push(b),L}let y=u(c);for(;y.length>10&&l>44;)l-=6,o.font=`bold ${l}px Inter, system-ui, -apple-system, Segoe UI, Roboto`,y=u(c);const p=i;y.slice(0,10).forEach((E,k)=>o.fillText(E,i,p+k*(l*1.2)));const h=(((g=t.cta)==null?void 0:g.text)||t.cta||"").toString();return h&&(o.font="600 48px Inter, system-ui, -apple-system, Segoe UI, Roboto",o.fillStyle="#0b1320",o.fillText(h.slice(0,70),i,1920*.74)),await new Promise(E=>n.toBlob(E,"image/png"))}async function no(t,e){var y,p,h;const a=await ir(),n=new a;if(!Array.isArray(t)||!t.length){v(d("notification_no_script_to_download")||"No script to export","warning");return}const o=n.folder("aethera_exports"),s=document.getElementById("platform-target"),i=((s==null?void 0:s.value)||"tiktok").toLowerCase(),c={platform:{tiktok:"tiktok_video",shopee:"shopee_video",instagram:"igreels",threads:"threads",shorts:"shorts"}[i]||"tiktok_video",lang:(q==null?void 0:q.current)==="en"?"en":"id",vo:{engine:"gemini",geminiVoice:"Kore"}};for(let f=0;f<t.length;f++){const g=t[f],E=cr(g.title||`script_${f+1}`),k=o.folder(`${String(f+1).padStart(2,"0")}_${E}`);if(k.file(`${E}.json`,JSON.stringify(g,null,2)),k.file(`${E}.srt`,lr(g)),k.file(`${E}.csv`,dr(g)),k.file(`${E}_platform_pack.txt`,ur(g)),e){const b=await mr(g);b&&k.file(`${E}_thumb_1080x1920.png`,b)}const L={hook:((y=g==null?void 0:g.hook)==null?void 0:y.text)||(g==null?void 0:g.hook)||"",scenes:[((p=g==null?void 0:g.body)==null?void 0:p.text)||(g==null?void 0:g.body)||""],cta:((h=g==null?void 0:g.cta)==null?void 0:h.text)||(g==null?void 0:g.cta)||""};try{rr(k,L,c)}catch(b){console.warn("appendVOToZip failed:",b)}}const l=await n.generateAsync({type:"blob"}),u=document.createElement("a");u.href=URL.createObjectURL(l),u.download=`aethera_exports_${Date.now()}.zip`,u.click(),URL.revokeObjectURL(u.href),v(d("zip_export_done")||"ZIP exported.","success")}async function oo(t){return no(fe(),t)}function so(){const t=document.getElementById("export-all-zip-btn"),e=document.getElementById("include-thumbs");t&&!t.__bound&&(t.__bound=!0,t.addEventListener("click",()=>oo(!!(e!=null&&e.checked))))}const Ca=Object.freeze(Object.defineProperty({__proto__:null,exportAllZip:oo,exportZipForScripts:no,initResultsExportToolbar:so},Symbol.toStringTag,{value:"Module"}));function ro(){const t=document.getElementById("rank-all-btn");t&&t.addEventListener("click",async()=>{const e=document.getElementById("output-panel"),a=Array.from(e?e.querySelectorAll(".result-card"):[]);if(a.length<2){try{(await $(async()=>{const{showNotification:s}=await Promise.resolve().then(()=>X);return{showNotification:s}},void 0)).showNotification("Rank requires at least 2 results","warning")}catch{}return}const n=[];for(const s of a){const i=s.querySelector(".hook-text"),r=s.querySelector(".body-text"),c=s.querySelector(".cta-text"),l=i?i.textContent.trim():"",u=c?c.textContent.trim():"";let y=await pe(l);y+=Math.min(((r==null?void 0:r.textContent)||"").split(/\s+/).length,120)*.1,y+=/now|today|grab|discount|sale|link|tap|shop/i.test(u)?20:0,n.push({card:s,score:y})}n.sort((s,i)=>i.score-s.score);const o=document.getElementById("output-panel");o&&(n.forEach(({card:s})=>o.appendChild(s)),t.textContent=" "+(d("rank_button_active")||"Ranked (best  worst)"),setTimeout(()=>{t.textContent=" "+(d("rank_button_default")||"Rank All")},2e3))})}const pr=Object.freeze(Object.defineProperty({__proto__:null,initRankAll:ro},Symbol.toStringTag,{value:"Module"}));async function Ua(){try{const{data:{session:t}}=await x.auth.getSession();if(!(t!=null&&t.user)){v(d("notification_login_required")||"Silakan login terlebih dahulu","warning");return}const e=t.user,a=document.getElementById("acc-email-current");a&&(a.value=e.email||"");const{data:n}=await x.from("profiles").select("*").eq("id",e.id).single();if(n){const o=document.getElementById("acc-fullname"),s=document.getElementById("acc-username"),i=document.getElementById("acc-bio");o&&(o.value=n.full_name||""),s&&(s.value=n.username||""),i&&(i.value=n.bio||"")}}catch{}}function gr(){const t=document.getElementById("acc-save-profile"),e=document.getElementById("acc-update-email"),a=document.getElementById("acc-update-password");t==null||t.addEventListener("click",async()=>{var n,o,s;z(!0,t);try{const{data:{session:i}}=await x.auth.getSession();if(!(i!=null&&i.user))throw new Error("Not authenticated");const r={id:i.user.id,full_name:(((n=document.getElementById("acc-fullname"))==null?void 0:n.value)||"").trim(),username:(((o=document.getElementById("acc-username"))==null?void 0:o.value)||"").trim(),bio:(((s=document.getElementById("acc-bio"))==null?void 0:s.value)||"").trim(),updated_at:new Date().toISOString()},{error:c}=await x.from("profiles").upsert(r);c?String(c.code)==="23505"?v(d("username_taken")||"Username sudah dipakai","error"):v(c.message||"Gagal menyimpan profil","error"):v(d("profile_saved")||"Profil disimpan","success")}catch(i){v(i.message||"Gagal menyimpan","error")}finally{z(!1,t)}}),e==null||e.addEventListener("click",async()=>{var n,o;z(!0,e);try{const{data:{session:s}}=await x.auth.getSession();if(!((n=s==null?void 0:s.user)!=null&&n.email))throw new Error("Not authenticated");const i=(((o=document.getElementById("acc-email-new"))==null?void 0:o.value)||"").trim();if(!i)return;const r=window.location.origin,{error:c}=await x.auth.updateUser({email:i},{emailRedirectTo:r});if(c)throw c;v(d("email_update_sent")||"Email konfirmasi dikirim. Cek inbox Anda.","success");try{await x.from("profiles").upsert({id:s.user.id,email_pending:i})}catch{}}catch(s){v(s.message||"Gagal mengirim konfirmasi perubahan email","error")}finally{z(!1,e)}}),a==null||a.addEventListener("click",async()=>{var n,o;z(!0,a);try{const{data:{session:s}}=await x.auth.getSession();if(!((n=s==null?void 0:s.user)!=null&&n.email))throw new Error("Not authenticated");const i=(((o=document.getElementById("acc-password"))==null?void 0:o.value)||"").trim();if(!i||i.length<6){v(d("password_too_short")||"Password minimal 6 karakter","warning");return}const r=window.location.origin,{error:c}=await x.auth.resetPasswordForEmail(s.user.email,{redirectTo:r});if(c)throw c;v(d("password_reset_sent")||"Link reset password dikirim ke email Anda.","success")}catch(s){v(s.message||"Gagal mengirim link reset","error")}finally{z(!1,a)}})}function hr(){try{console.log("Language:",localStorage.getItem("direktiva_language")||localStorage.getItem("aethera_language")||"id"),console.log("Has id.json:",!!(W&&Object.keys(W.id||{}).length)),console.log("Has en.json:",!!(W&&Object.keys(W.en||{}).length)),console.log("Sample t(light_mode_active):",d("light_mode_active"))}catch{}}document.addEventListener("DOMContentLoaded",async()=>{var g,E,k,L,b,P;zt(),await Mt(),hr(),Is(),Ps(),Wt(),await U.init(),On(),ht(localStorage.getItem("direktiva_theme")||localStorage.getItem("aethera_theme")||"dark");const t=localStorage.getItem("direktiva_language")||localStorage.getItem("aethera_language")||"id";await pa(t),or(),so(),ro(),jt(),ee("generator"),At(localStorage.getItem("currentMode")||"single"),await Mt(),await Ve.init();try{ue(),me()}catch(_){console.warn("Failed to populate selectors on startup:",_.message)}xn();const e=localStorage.getItem("direktiva_theme")||localStorage.getItem("aethera_theme")||"dark";document.getElementById("theme-icon-sun").classList.toggle("hidden",e==="dark"),document.getElementById("theme-icon-moon").classList.toggle("hidden",e==="light"),document.getElementById("main-content").addEventListener("click",_=>{const S=_.target.closest(".result-card");if(S){if(_.target.closest(".prompt-copy-btn")){const C=_.target.closest(".prompt-copy-btn"),w=C.dataset.prompt.replace(/<\/?char-desc>/gi,"");z(!0,C);try{Ee(w,C)}finally{setTimeout(()=>{z(!1,C)},500)}return}if(_.target.closest(".generate-assets-btn")){ao(S);return}}const T=_.target.closest(".history-entry");T&&(_.target.closest(".delete-history-btn")&&ye(d("confirm_delete_entry")||"Apakah Anda yakin ingin menghapus entri ini?",async()=>{await ot(T.dataset.entryId),v(d("history_entry_deleted")||"Entri riwayat berhasil dihapus.","success")}),_.target.closest(".history-checkbox")&&(la(),cn()))}),m.generateBtn.addEventListener("click",()=>{En(),Qn()}),document.getElementById("product-category").addEventListener("change",st),document.getElementById("character-mode").addEventListener("change",ma),m.personaSelector.addEventListener("change",()=>{const _=m.personaSelector.value,S=document.getElementById("persona-description-display");if(!_){S.classList.add("hidden"),S.textContent="";return}const C=(JSON.parse(localStorage.getItem("aethera_personas"))||[]).find(D=>D.id===_);C?(S.textContent=`${d("description_label")}: "${C.description}"`,S.classList.remove("hidden")):S.classList.add("hidden")}),document.getElementById("dynamic-character-sheet-area").addEventListener("click",_=>{if(_.target.closest("#save-character-preset-btn")&&Tn(),_.target.closest("#add-character-btn")){const S=_.currentTarget,T=S.querySelectorAll(".character-sheet-instance").length,C=gt(T);S.insertBefore(C,_.target.closest("#add-character-btn")),st()}_.target.closest(".remove-character-btn")&&(_.target.closest(".character-sheet-instance").remove(),document.querySelectorAll(".character-sheet-instance .character-title").forEach((S,T)=>{S.textContent=d("character_number",{number:T+1})}))}),m.settingsPresetSelector.addEventListener("change",wn),m.savePresetBtn.addEventListener("click",Sn),m.managePresetsBtn.addEventListener("click",In),document.getElementById("character-preset-selector").addEventListener("change",ka),m.manageCharacterPresetsBtn.addEventListener("click",Pn);const a=document.getElementById("manage-presets-modal");document.getElementById("close-manage-presets-modal-btn").addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:T}=await Promise.resolve().then(()=>X);return{setLoadingState:T}},void 0),S=document.getElementById("close-manage-presets-modal-btn");_(!0,S);try{rt()}finally{_(!1,S)}}),a.addEventListener("click",_=>_.target===a&&rt()),document.getElementById("preset-list-container").addEventListener("click",Ln);const n=document.getElementById("manage-character-presets-modal");document.getElementById("close-manage-character-presets-modal-btn").addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:T}=await Promise.resolve().then(()=>X);return{setLoadingState:T}},void 0),S=document.getElementById("close-manage-character-presets-modal-btn");_(!0,S);try{it()}finally{_(!1,S)}}),n.addEventListener("click",_=>_.target===n&&it()),document.getElementById("character-preset-list-container").addEventListener("click",Bn),document.getElementById("cancel-revision-btn").addEventListener("click",we),document.getElementById("regenerate-again-btn").addEventListener("click",()=>{const _=document.getElementById("revision-instruction-stage2").value;document.getElementById("revision-instruction").value=_,Yt()}),document.getElementById("apply-changes-btn").addEventListener("click",async()=>{var B,O,I;const _=localStorage.getItem("cardBeingEditedId"),S=document.getElementById(_);if(!S){we();return}const{setLoadingState:T}=await $(async()=>{const{setLoadingState:N}=await Promise.resolve().then(()=>X);return{setLoadingState:N}},void 0),C=document.getElementById("apply-changes-btn");T(!0,C);const D=JSON.parse(S.dataset.script);let w={...D};if(de){w={...w,...de};try{const N=[];if(typeof((B=de.hook)==null?void 0:B.text)=="string"&&N.push("hook"),typeof((O=de.body)==null?void 0:O.text)=="string"&&N.push("body"),typeof((I=de.cta)==null?void 0:I.text)=="string"&&N.push("cta"),N.length>0){const{regenerateVisualPrompts:F}=await $(async()=>{const{regenerateVisualPrompts:Y}=await Promise.resolve().then(()=>Fe);return{regenerateVisualPrompts:Y}},void 0);for(const Y of N){const ie=w[Y].text,Z=await F(w,Y,ie);Array.isArray(Z)&&Z.length&&(w[Y].shots=Z)}}}catch{}}const{updateCardContent:A,initSwiper:R}=await $(async()=>{const{updateCardContent:N,initSwiper:F}=await Promise.resolve().then(()=>Ra);return{updateCardContent:N,initSwiper:F}},void 0);A(S,w),ct(w);try{const{openScriptViewer:N}=await $(async()=>{const{openScriptViewer:F}=await Promise.resolve().then(()=>Fe);return{openScriptViewer:F}},void 0);await N(S,w)}catch{}const{showActionNotification:M}=await $(async()=>{const{showActionNotification:N}=await Promise.resolve().then(()=>X);return{showActionNotification:N}},void 0);M(d("notification_script_updated")||"Skrip berhasil diperbarui!",d("undo_button")||"Urungkan",async()=>{A(S,D),ct(D);try{const{openScriptViewer:N}=await $(async()=>{const{openScriptViewer:F}=await Promise.resolve().then(()=>Fe);return{openScriptViewer:F}},void 0);await N(S,D)}catch{}},"success"),we(),T(!1,C)}),m.loginBtn.addEventListener("click",Lt),(g=document.getElementById("forgot-password-btn"))==null||g.addEventListener("click",Yo),document.getElementById("login-password").addEventListener("keyup",_=>_.key==="Enter"&&Lt()),document.getElementById("login-email").addEventListener("keyup",_=>_.key==="Enter"&&Lt()),m.logoutBtn.addEventListener("click",Ut),m.mobileLogoutBtn.addEventListener("click",Ut),m.navGenerator.addEventListener("click",_=>{_.preventDefault(),ee("generator")}),m.navHistory.addEventListener("click",async _=>{_.preventDefault();const{loadHistory:S}=await $(async()=>{const{loadHistory:T}=await Promise.resolve().then(()=>It);return{loadHistory:T}},void 0);await S(),ee("history")}),m.navSettings.addEventListener("click",_=>{_.preventDefault(),ee("settings")}),(E=m.navAccount)==null||E.addEventListener("click",async _=>{_.preventDefault(),ee("account"),await Ua()}),m.mobileMenuButton.addEventListener("click",Me),m.mobileNavGenerator.addEventListener("click",_=>{_.preventDefault(),ee("generator"),Me()}),m.mobileNavHistory.addEventListener("click",async _=>{_.preventDefault();const{loadHistory:S}=await $(async()=>{const{loadHistory:T}=await Promise.resolve().then(()=>It);return{loadHistory:T}},void 0);await S(),ee("history"),Me()}),m.mobileNavSettings.addEventListener("click",_=>{_.preventDefault(),ee("settings"),Me()}),(k=m.mobileNavAccount)==null||k.addEventListener("click",async _=>{_.preventDefault(),ee("account"),Me(),await Ua()}),m.apiKeyModal.saveBtn.addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:S}=await Promise.resolve().then(()=>X);return{setLoadingState:S}},void 0);_(m.apiKeyModal.saveBtn,!0);try{await fn()}finally{_(m.apiKeyModal.saveBtn,!1)}}),m.modeSingleBtn.addEventListener("click",()=>At("single")),m.modeCarouselBtn.addEventListener("click",()=>At("carousel"));try{const _=document.getElementById("platform-target"),S=localStorage.getItem("platform_target")||localStorage.getItem("targetPlatform")||"tiktok";_&&(_.value=S,_.addEventListener("change",()=>{const T=_.value;localStorage.setItem("platform_target",T),localStorage.setItem("targetPlatform",T),v(`${d("target_platform_label")||"Target Platform"}: ${T}`,"success");try{const C=document.getElementById("cta-type");if(C){const D=T==="tiktok"?"cta_tiktok":T==="shopee"?"cta_shopee":T==="instagram"||T==="threads"?"cta_instagram":T==="shorts"?"cta_youtube":"cta_general";Array.from(C.options).some(w=>w.value===D)&&(C.value=D)}}catch{}}))}catch{}m.strategyDefaultBtn.addEventListener("click",()=>Tt("default")),m.strategyFacelessBtn.addEventListener("click",()=>Tt("faceless")),m.strategyCharacterBtn.addEventListener("click",()=>Tt("character")),m.ratio916Btn.addEventListener("click",()=>Ct("9:16")),m.ratio11Btn.addEventListener("click",()=>Ct("1:1")),m.ratio169Btn.addEventListener("click",()=>Ct("16:9")),m.inputs.productImage.addEventListener("change",Zn),m.removeImageBtn.addEventListener("click",Ta),m.editModal.closeBtn.addEventListener("click",we),m.editModal.regenerateBtn.addEventListener("click",Yt),m.editModal.el.addEventListener("click",_=>_.target===m.editModal.el&&we());try{const{translateUI:_}=await $(async()=>{const{translateUI:S}=await Promise.resolve().then(()=>Ra);return{translateUI:S}},void 0);_()}catch{}const o=document.getElementById("results-container");o&&o.children.length===0&&(o.innerHTML=`<div class="text-center text-gray-500 py-8">${d("empty_results_prompt")||"Belum ada hasil. Isi detail produk dan klik Generate untuk memulai."}</div>`);const s=document.getElementById("history-panel");s&&s.children.length===0&&(s.innerHTML=`<div class="text-center text-gray-500 py-8">${d("empty_history_prompt")||"Belum ada riwayat. Hasil skrip Anda akan tampil di sini."}</div>`),m.downloadAllContainer.addEventListener("click",_=>{_.target.classList.contains("download-all-btn")&&Zo(_.target.dataset.format)}),m.saveSettingsBtn.addEventListener("click",vn),gr(),m.personaModal.addBtn.addEventListener("click",()=>Ma()),m.personaModal.closeBtn.addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:S}=await Promise.resolve().then(()=>X);return{setLoadingState:S}},void 0);_(!0,m.personaModal.closeBtn);try{ln()}finally{_(!1,m.personaModal.closeBtn)}}),m.personaModal.saveBtn.addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:S}=await Promise.resolve().then(()=>X);return{setLoadingState:S}},void 0);_(!0,m.personaModal.saveBtn);try{await Lo()}finally{_(!1,m.personaModal.saveBtn)}}),m.personaModal.listContainer.addEventListener("click",_=>{const S=_.target.closest(".edit-persona-btn");if(S){const D=(JSON.parse(localStorage.getItem("aethera_personas"))||[]).find(w=>w.id===S.dataset.id);D&&Ma(D)}const T=_.target.closest(".delete-persona-btn");T&&Ao(T.dataset.id)}),m.personaModal.defaultContainer.addEventListener("click",_=>{if(_.target.closest(".add-default-persona-btn")){const S=_.target.closest(".add-default-persona-btn");To(S.dataset.name,S.dataset.desc)}}),m.confirmModal.cancelBtn.addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:S}=await Promise.resolve().then(()=>X);return{setLoadingState:S}},void 0);_(!0,m.confirmModal.cancelBtn);try{et()}finally{_(!1,m.confirmModal.cancelBtn)}}),m.confirmModal.el.addEventListener("click",_=>_.target===m.confirmModal.el&&et()),m.confirmModal.confirmBtn.addEventListener("click",async()=>{const{setLoadingState:_}=await $(async()=>{const{setLoadingState:S}=await Promise.resolve().then(()=>X);return{setLoadingState:S}},void 0);_(!0,m.confirmModal.confirmBtn);try{typeof Je=="function"&&await Je(),et()}finally{_(!1,m.confirmModal.confirmBtn)}}),document.getElementById("theme-toggle-btn").addEventListener("click",()=>{const S=(localStorage.getItem("direktiva_theme")||localStorage.getItem("aethera_theme")||"dark")==="dark"?"light":"dark";Ht(S)}),m.langIdBtn.addEventListener("click",async()=>await De("id")),m.langEnBtn.addEventListener("click",async()=>await De("en"));const i=document.getElementById("mobile-theme-toggle-btn");i&&i.addEventListener("click",()=>{const S=(localStorage.getItem("direktiva_theme")||localStorage.getItem("aethera_theme")||"dark")==="dark"?"light":"dark";Ht(S)}),m.mobileLangIdBtn&&m.mobileLangIdBtn.addEventListener("click",async()=>await De("id")),m.mobileLangEnBtn&&m.mobileLangEnBtn.addEventListener("click",async()=>await De("en"));try{const _=new URL(window.location.href),S=_.searchParams.get("code"),T=_.searchParams.get("message")||(_.hash.includes("message=")?decodeURIComponent(_.hash.split("message=")[1]):"");if(S){try{await x.auth.exchangeCodeForSession(S);try{(L=m.loginOverlay)==null||L.classList.add("hidden"),(b=m.appContainer)==null||b.classList.remove("hidden")}catch{}try{await jt()}catch{}}catch{}try{const{data:{session:C}}=await x.auth.getSession();(P=C==null?void 0:C.user)!=null&&P.id&&await x.from("profiles").upsert({id:C.user.id,email:C.user.email,email_pending:null})}catch{}ut(d("set_new_password_title")||"Set New Password",d("set_new_password_desc")||"Enter your new password to complete recovery.",d("new_password")||"New Password",async C=>{if(!C||C.length<6){v(d("password_too_short")||"Password minimal 6 karakter","warning");return}try{const{error:D}=await x.auth.updateUser({password:C});if(D)throw D;v(d("password_updated")||"Password updated","success")}catch(D){v(D.message||"Failed to set password","error")}}),history.replaceState({},"",location.pathname)}else T&&(v(T,"success"),history.replaceState({},"",location.pathname))}catch{}const r=document.getElementById("delete-all-btn");r&&r.addEventListener("click",async()=>{ye(d("confirm_delete_all"),async()=>{var S;const{deleteAllHistory:_}=await $(async()=>{const{deleteAllHistory:T}=await Promise.resolve().then(()=>It);return{deleteAllHistory:T}},void 0);await _(),v(d("history_deleted_all"),"success"),(S=document.getElementById("delete-selected-btn"))==null||S.classList.add("hidden")})});const c=document.getElementById("delete-selected-btn");c&&c.addEventListener("click",()=>{const _=Array.from(document.querySelectorAll(".history-checkbox:checked")).map(S=>{var T;return(T=S.closest(".history-entry"))==null?void 0:T.dataset.entryId}).filter(Boolean);_.length!==0&&ye(d("confirm_delete_selected").replace("{n}",_.length),async()=>{var S;await ot(_),v(d("history_deleted_selected"),"success"),(S=document.getElementById("delete-selected-btn"))==null||S.classList.add("hidden")})});const l=document.getElementById("prev-page"),u=document.getElementById("next-page");l&&l.addEventListener("click",on),u&&u.addEventListener("click",nn);const y=document.getElementById("history-search"),p=document.getElementById("history-sort"),h=document.getElementById("select-all-history");y&&y.addEventListener("input",_=>{ra(_.target.value)}),p&&p.addEventListener("change",_=>{ia(_.target.value)}),h&&h.addEventListener("change",_=>{sn(_.target.checked)}),document.querySelectorAll(".post-type-tab").forEach(_=>{_.addEventListener("click",()=>{const S=_.dataset.filter;ca(S)})});const f=document.getElementById("group-by-product");f&&f.addEventListener("change",rn)});(function(){const t=document.querySelector("header.sticky");function e(){const r=(window.scrollY||document.documentElement.scrollTop)>8;t&&(t.classList.toggle("bg-gray-900/70",!r),t.classList.toggle("bg-gray-900/50",r),t.classList.toggle("backdrop-blur-sm",!r),t.classList.toggle("backdrop-blur-md",r),t.classList.toggle("shadow-sm",r))}window.addEventListener("scroll",e,{passive:!0}),e();function a(r){var c;r==null||r.classList.remove("opacity-0","pointer-events-none"),(c=r==null?void 0:r.querySelector(".modal-content"))==null||c.classList.remove("scale-95")}function n(r){var c;r==null||r.classList.add("opacity-0","pointer-events-none"),(c=r==null?void 0:r.querySelector(".modal-content"))==null||c.classList.add("scale-95")}const o=document.getElementById("about-modal"),s=document.getElementById("nav-about"),i=document.getElementById("mobile-nav-about");[s,i].forEach(r=>r&&r.addEventListener("click",c=>{c.preventDefault(),a(o)})),document.querySelectorAll(".about-close").forEach(r=>r.addEventListener("click",()=>n(o))),o&&o.addEventListener("click",r=>{r.target===o&&n(o)}),window.addEventListener("keydown",r=>{r.key==="Escape"&&n(o)})})();const Ot=document.getElementById("creative-freedom"),yr=document.getElementById("freedom-value"),Fa=t=>{let e=d("freedom_balanced");t<=.3&&(e=d("freedom_very_obedient")),t>=.9&&(e=d("freedom_very_creative")),yr.textContent=`${t} (${e})`};Ot&&(Ot.addEventListener("input",t=>{Fa(t.target.value)}),Fa(Ot.value));(function(){function t(s){var i;s==null||s.classList.remove("opacity-0","pointer-events-none"),(i=s==null?void 0:s.querySelector(".modal-content"))==null||i.classList.remove("scale-95")}function e(s){var i;s==null||s.classList.add("opacity-0","pointer-events-none"),(i=s==null?void 0:s.querySelector(".modal-content"))==null||i.classList.add("scale-95")}const a=document.getElementById("manual-modal"),n=document.getElementById("nav-manual"),o=document.getElementById("mobile-nav-manual");[n,o].forEach(s=>s&&s.addEventListener("click",i=>{i.preventDefault(),t(a)})),document.querySelectorAll(".manual-close").forEach(s=>s.addEventListener("click",()=>e(a))),a==null||a.addEventListener("click",s=>{s.target===a&&e(a)}),window.addEventListener("keydown",s=>{s.key==="Escape"&&e(a)})})();(function(){const t=document.querySelector("header.sticky");function e(){const a=window.scrollY||document.documentElement.scrollTop||0;t&&(a>8?t.classList.add("is-scrolled"):t.classList.remove("is-scrolled"))}window.addEventListener("scroll",e,{passive:!0}),e()})();try{$(()=>Promise.resolve().then(()=>Ca),void 0).then(t=>t.initResultsExportToolbar&&t.initResultsExportToolbar())}catch{}try{$(()=>Promise.resolve().then(()=>pr),void 0).then(t=>t.initRankAll&&t.initRankAll())}catch{}document.addEventListener("click",t=>{const e=t.target.closest("[data-cta-value]");if(!e)return;const a=e.getAttribute("data-cta-value"),n=document.getElementById("cta-type");n&&a&&(n.value=a,n.dispatchEvent(new Event("change",{bubbles:!0})),document.querySelectorAll("[data-cta-value]").forEach(o=>o.classList.toggle("selected",o===e)))});(()=>{const t=document.getElementById("cta-type");if(t){t.disabled=!1;const e=t.closest(".form-group");e==null||e.classList.remove("pointer-events-none","opacity-50")}})();let je=1;const io=5;function fr(){localStorage.getItem("aethera_onboarding_completed")||_r()}function _r(){const t=document.getElementById("onboarding-overlay");t&&(t.classList.remove("hidden"),Zt(1))}function Ga(){const t=document.getElementById("onboarding-overlay");t&&(t.classList.add("hidden"),localStorage.setItem("aethera_onboarding_completed","true"))}function Zt(t){je=t,document.querySelectorAll(".onboarding-step").forEach(o=>{o.classList.add("hidden")});const e=document.querySelector(`[data-step="${t}"]`);e&&e.classList.remove("hidden"),document.querySelectorAll(".onboarding-dot").forEach((o,s)=>{s+1<=t?(o.classList.remove("bg-muted"),o.classList.add("bg-accent")):(o.classList.remove("bg-accent"),o.classList.add("bg-muted"))});const a=document.getElementById("onboarding-prev"),n=document.getElementById("onboarding-next");a&&a.classList.toggle("hidden",t===1),n&&(t===io?n.textContent="Mulai Sekarang!":n.textContent="Selanjutnya")}const vr={"tiktok-viral":{name:"TikTok Viral 2025",settings:{hookType:"hook_future_pacing",ctaType:"cta_tiktok",targetAudience:"audience_young_pro",writingStyle:"style_storytelling",toneVibe:"tone_inspiring",duration:"15"}},"shopee-sales":{name:"Shopee Sales",settings:{hookType:"hook_negativity_bias",ctaType:"cta_shopee",targetAudience:"audience_general",writingStyle:"style_persuasive",toneVibe:"tone_urgent",duration:"30"}},"instagram-story":{name:"Instagram Story",settings:{hookType:"hook_question",ctaType:"cta_instagram",targetAudience:"audience_young_pro",writingStyle:"style_storytelling",toneVibe:"tone_inspiring",duration:"15"}},"youtube-review":{name:"YouTube Review",settings:{hookType:"hook_statistic",ctaType:"cta_youtube",targetAudience:"audience_gamers",writingStyle:"style_informative",toneVibe:"tone_professional",duration:"60"}}};function br(t){const e=vr[t];if(!e)return;const a=e.settings;function n(i,r){const c=document.getElementById(i);if(!c)return!1;const l=c.querySelector(`option[data-lang-key="${r}"]`);return l?(c.value=l.value||r,!0):!1}function o(i,r){const c=document.getElementById(i);return c?(c.value=r,!0):!1}a.hookType&&n("hook-type",a.hookType),a.ctaType&&n("cta-type",a.ctaType),a.targetAudience&&n("target-audience",a.targetAudience),a.writingStyle&&n("writing-style",a.writingStyle),a.toneVibe&&n("tone-vibe",a.toneVibe),a.duration&&o("script-duration",a.duration),typeof v=="function"&&v(d("template_applied_success",{name:e.name}),"success");const s=document.getElementById("product-name");s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.focus())}function Ja(){var e,a,n,o,s,i,r;const t={productName:((e=document.getElementById("product-name"))==null?void 0:e.value)||"",productDesc:((a=document.getElementById("product-desc"))==null?void 0:a.value)||"",hookType:((n=document.getElementById("hook-type"))==null?void 0:n.value)||"",ctaType:((o=document.getElementById("cta-type"))==null?void 0:o.value)||"",targetAudience:((s=document.getElementById("target-audience"))==null?void 0:s.value)||"",writingStyle:((i=document.getElementById("writing-style"))==null?void 0:i.value)||"",toneVibe:((r=document.getElementById("tone-vibe"))==null?void 0:r.value)||""};localStorage.setItem("aethera_form_autosave",JSON.stringify(t)),localStorage.setItem("aethera_form_last_modified",new Date().toISOString())}function Sr(){const t=localStorage.getItem("aethera_form_autosave");if(t)try{const e=JSON.parse(t);Object.keys(e).forEach(a=>{const n=document.getElementById(a.replace(/([A-Z])/g,"-$1").toLowerCase());n&&e[a]&&(n.value=e[a])})}catch(e){console.warn("Failed to load auto-saved form data:",e)}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{fr()},1e3);const t=document.getElementById("onboarding-next");t&&t.addEventListener("click",()=>{je<io?Zt(je+1):Ga()});const e=document.getElementById("onboarding-prev");e&&e.addEventListener("click",()=>{je>1&&Zt(je-1)});const a=document.getElementById("onboarding-skip");a&&a.addEventListener("click",()=>{Ga()}),document.querySelectorAll(".quick-template-btn").forEach(o=>{o.addEventListener("click",()=>{const s=o.dataset.template;br(s),o.classList.add("pulse-glow"),setTimeout(()=>{o.classList.remove("pulse-glow")},1e3)})}),setTimeout(()=>{Sr()},500),["product-name","product-desc","hook-type","cta-type","target-audience","writing-style","tone-vibe"].forEach(o=>{const s=document.getElementById(o);s&&(s.addEventListener("input",Ja),s.addEventListener("change",Ja))})});(async()=>{await Ve.init();const t=document.querySelector("#platform-target"),e=document.querySelector("#hook-type"),a=document.querySelector("#cta-type");let n=!1;a==null||a.addEventListener("change",()=>{n=!0});function o(){if(!t||!e||!a)return;[...a.options].forEach(c=>{c.textContent=c.textContent.replace(/^\s*/,"")});const s=(t.value||"").toLowerCase().trim(),i=s==="threads"?"instagram":s==="shorts"?"youtube":s,r=Ve.suggestCtas(i,e.value)||[];if(r.slice(0,3).forEach(c=>{const l=[...a.options].find(u=>u.value===c);l&&(l.textContent=" "+l.textContent.replace(/^\s*/,""))}),!n&&![...a.options].some(l=>l.selected)){const l=r[0]&&[...a.options].find(u=>u.value===r[0]);l&&(l.selected=!0)}}t==null||t.addEventListener("change",()=>{n=!1,o()}),e==null||e.addEventListener("change",()=>{n=!1,o()}),o()})();
